<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduHeTech - Learn & Earn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* Your existing CSS styles remain the same */
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1d4ed8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        .scrollable-content {
            max-height: calc(100vh - 80px);
            overflow-y: auto;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-radius: 0.5rem;
            color: white;
            transition: transform 0.1s ease;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 50;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Additional styles remain the same */
        .progress-ring { transform: rotate(-90deg); }
        .streak-flame { animation: pulse 1.5s infinite alternate; }
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .achievement-badge {
            transition: transform 0.3s ease;
        }
        .achievement-badge:hover {
            transform: scale(1.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .course-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .course-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .course-section:last-child {
            border-bottom: none;
        }
        .refresh-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .ad-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .ad-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            text-align: center;
        }
        .ad-slide.active {
            opacity: 1;
            position: relative;
        }
        .ad-indicators {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .ad-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #cbd5e1;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .ad-indicator.active {
            background-color: var(--primary-color);
        }
        .ad-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        .ad-description {
            color: #6b7280;
            margin-bottom: 1rem;
        }
        .ad-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        
        .learn-ad-container {
            height: 180px;
            margin-bottom: 1.5rem;
        }
        .learn-ad-slide {
            padding: 1rem;
        }
        .learn-ad-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .learn-ad-description {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        .learn-ad-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="loader"></div>
    </div>

    <!-- Global Modal Structure -->
    <div id="global-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4 z-40">
        <div class="card w-full max-w-sm p-6 space-y-4 slide-in">
            <div id="modal-content"></div>
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" onclick="hideModal()" class="p-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm" class="p-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition hidden">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Application Root -->
    <div id="app">
        <!-- Content rendered by JavaScript -->
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-500">Initializing EduHeTech...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Your existing Firebase initialization code remains the same
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDDKcWF9bOA9aSZOkeODE_N8Ag_wS87J_0",
            authDomain: "studio-4004347076-d761a.firebaseapp.com",
            projectId: "studio-4004347076-d761a",
            storageBucket: "studio-4004347076-d761a.firebasestorage.app",
            messagingSenderId: "316122123573",
            appId: "1:316122123573:web:b36fe06376e37948ea907c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseApp = app;
        window.firebaseModules = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            collection,
            query,
            where,
            getDocs
        };

        console.log("Firebase initialized successfully!");
    </script>

    <script>
        // =====================================================
        // APPLICATION CONSTANTS AND STATE
        // =====================================================
        
        // Your existing constants and state remain the same
        const LS_USERS = 'eduhetech_users_v10';
        const LS_WITHDRAWALS = 'eduhetech_withdrawals_v10';
        const LS_LESSONS = 'eduhetech_lessons_v10';
        const LS_QUIZZES = 'eduhetech_quizzes_v10';
        const LS_ACHIEVEMENTS = 'eduhetech_achievements_v10';

        const AD_ROTATION_DATA = [
            // Your existing ad data
        ];
        
        const LEARN_AD_DATA = [
            // Your existing learn ad data
        ];
        
        const BASE_POINTS_REWARDS = {
            lesson: 500,
            quiz: 50,
            ad: 500,
            dailyLogin: 100,
            referral: 1000,
            streak: 500,
            achievement: 5000
        };
        const MIN_WITHDRAWAL_POINTS = 100000;
        const DAILY_POINTS_LIMIT = 10000;

        window.state = {
            user: null,
            currentView: 'loading',
            isLoading: false,
            quizData: null,
            allUsers: {},
            withdrawalRequests: [],
            lessons: [],
            quizzes: [],
            achievements: [],
            notifications: [],
            currentCourse: null,
            currentAdIndex: 0,
            currentLearnAdIndex: 0,
            adRotationInterval: null,
            learnAdRotationInterval: null,
            firebaseUser: null
        };

        // =====================================================
        // FIREBASE AUTHENTICATION FUNCTIONS
        // =====================================================

        // Your existing Firebase functions remain the same
        async function handleFirebaseSignup(name, email, password, referrerCode = null) {
            // Your existing implementation
        }

        async function handleFirebaseLogin(email, password) {
            // Your existing implementation
        }

        async function handleFirebaseLogout() {
            // Your existing implementation
        }

        async function handleReferral(referrerCode, newUserId) {
            // Your existing implementation
        }

        function getFirebaseErrorMessage(error) {
            // Your existing implementation
        }

        function generateReferralCode() {
            // Your existing implementation
        }

        function initializeAuthStateListener() {
            // Your existing implementation
        }

        // =====================================================
        // DATA PERSISTENCE FUNCTIONS
        // =====================================================

        // Your existing data functions remain the same
        async function saveUser(userData) {
            // Your existing implementation
        }

        async function addPoints(action, points, checkDailyLimit = true) {
            // Your existing implementation
        }

        function loadAllUsers() {
            // Your existing implementation
        }

        function saveAllUsers(users) {
            // Your existing implementation
        }

        function loadCollection(key) {
            // Your existing implementation
        }

        function saveCollection(key, data) {
            // Your existing implementation
        }

        // =====================================================
        // AD ROTATION SYSTEM
        // =====================================================

        // Your existing ad rotation functions remain the same
        function startAdRotation() {
            // Your existing implementation
        }

        function startLearnAdRotation() {
            // Your existing implementation
        }

        function stopAdRotation() {
            // Your existing implementation
        }

        function stopLearnAdRotation() {
            // Your existing implementation
        }

        function rotateAd() {
            // Your existing implementation
        }

        function rotateLearnAd() {
            // Your existing implementation
        }

        function setAdIndex(index) {
            // Your existing implementation
        }

        function setLearnAdIndex(index) {
            // Your existing implementation
        }

        function updateAdDisplay() {
            // Your existing implementation
        }

        function updateLearnAdDisplay() {
            // Your existing implementation
        }

        function renderAdSlide(index) {
            // Your existing implementation
        }

        function renderLearnAdSlide(index) {
            // Your existing implementation
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        // Your existing utility functions remain the same
        function render() {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;
            appContainer.innerHTML = '';
            showLoading(state.isLoading);

            if (!state.user) {
                appContainer.innerHTML = renderAuthScreen();
                attachAuthListeners();
            } else if (state.currentView === 'loading') {
                appContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full p-8"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p class="mt-4 text-gray-500">Loading Dashboard...</p></div>';
            } else if (state.currentView === 'course-detail') {
                appContainer.innerHTML = renderHeader() + renderCourseDetail();
                attachCourseDetailListeners();
            } else {
                appContainer.innerHTML = renderHeader() + renderContent();
                attachNavListeners();
                attachContentListeners();
                updateNotifications();
                
                if (state.currentView === 'ads') {
                    startAdRotation();
                    stopLearnAdRotation();
                } else if (state.currentView === 'learn') {
                    startLearnAdRotation();
                    stopAdRotation();
                } else {
                    stopAdRotation();
                    stopLearnAdRotation();
                }
            }
            
            updateBrowserTitle();
        }

        function showLoading(show) {
            // Your existing implementation
        }

        function showModal(content, onConfirm = null, onCancel = null) {
            // Your existing implementation
        }

        function hideModal() {
            // Your existing implementation
        }

        function formatPoints(points) {
            // Your existing implementation
        }

        function generateUniqueId() {
            // Your existing implementation
        }

        function calculateStreak(loginDates) {
            // Your existing implementation
        }

        function updateBrowserTitle() {
            // Your existing implementation
        }

        // =====================================================
        // CORE APPLICATION LOGIC
        // =====================================================

        // Your existing core functions remain the same
        function initMockData() {
            // Your existing implementation
        }

        function getAllCourses() {
            // Your existing implementation
        }

        function getAllQuizzes() {
            // Your existing implementation
        }

        function initializeAppData() {
            // Your existing implementation
        }

        function initializeData() {
            initMockData();
            initializeAuthStateListener();
            state.currentView = 'loading';
            render();
        }

        function initializeBrowserHistory() {
            // Your existing implementation
        }

        // =====================================================
        // MISSING RENDER FUNCTIONS - ADDED BELOW
        // =====================================================

        function renderHeader() {
            return `
                <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-16">
                            <div class="flex items-center">
                                <h1 class="text-2xl font-bold text-blue-600">EduHeTech</h1>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2 bg-blue-50 px-3 py-1 rounded-full">
                                    <i class="fas fa-coins text-yellow-500"></i>
                                    <span class="font-semibold text-blue-700">${state.user ? formatPoints(state.user.eduPoints) : 0}</span>
                                </div>
                                <button onclick="handleFirebaseLogout()" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg transition text-gray-700">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                        
                        <nav class="flex space-x-8 overflow-x-auto py-2">
                            <button class="nav-btn ${state.currentView === 'dashboard' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent'} whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm transition" data-view="dashboard">
                                <i class="fas fa-home mr-2"></i>Dashboard
                            </button>
                            <button class="nav-btn ${state.currentView === 'learn' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent'} whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm transition" data-view="learn">
                                <i class="fas fa-book mr-2"></i>Learn
                            </button>
                            <button class="nav-btn ${state.currentView === 'quiz' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent'} whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm transition" data-view="quiz">
                                <i class="fas fa-brain mr-2"></i>Quiz
                            </button>
                            <button class="nav-btn ${state.currentView === 'ads' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent'} whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm transition" data-view="ads">
                                <i class="fas fa-ad mr-2"></i>Watch Ads
                            </button>
                            <button class="nav-btn ${state.currentView === 'referral' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent'} whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm transition" data-view="referral">
                                <i class="fas fa-users mr-2"></i>Refer & Earn
                            </button>
                            <button class="nav-btn ${state.currentView === 'rewards' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent'} whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm transition" data-view="rewards">
                                <i class="fas fa-gift mr-2"></i>Withdraw
                            </button>
                            <button class="nav-btn ${state.currentView === 'leaderboard' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent'} whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm transition" data-view="leaderboard">
                                <i class="fas fa-trophy mr-2"></i>Leaderboard
                            </button>
                            <button class="nav-btn ${state.currentView === 'achievements' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent'} whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm transition" data-view="achievements">
                                <i class="fas fa-medal mr-2"></i>Achievements
                            </button>
                        </nav>
                    </div>
                </header>
            `;
        }

        function renderContent() {
            const views = {
                dashboard: renderDashboard(),
                learn: renderLearn(),
                quiz: renderQuiz(),
                ads: renderAds(),
                referral: renderReferral(),
                rewards: renderRewards(),
                leaderboard: renderLeaderboard(),
                achievements: renderAchievements()
            };
            
            return `
                <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <div id="coin-animation" class="fixed top-20 right-4 z-40"></div>
                    ${views[state.currentView] || views.dashboard}
                </main>
            `;
        }

        function renderDashboard() {
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6 text-center">
                            <i class="fas fa-coins text-4xl text-yellow-500 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-700">Total Points</h3>
                            <p class="text-3xl font-bold text-blue-600">${formatPoints(state.user.eduPoints)}</p>
                        </div>
                        
                        <div class="card p-6 text-center">
                            <i class="fas fa-fire text-4xl text-orange-500 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-700">Learning Streak</h3>
                            <p class="text-3xl font-bold text-orange-600">${state.user.streak || 0} days</p>
                        </div>
                        
                        <div class="card p-6 text-center">
                            <i class="fas fa-users text-4xl text-green-500 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-700">Referrals</h3>
                            <p class="text-3xl font-bold text-green-600">${state.user.referralCount || 0}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
                            <div class="space-y-3">
                                <button class="w-full text-left p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition" data-view="learn">
                                    <i class="fas fa-book mr-3 text-blue-500"></i>
                                    <span class="font-semibold">Continue Learning</span>
                                </button>
                                <button class="w-full text-left p-4 bg-green-50 rounded-lg hover:bg-green-100 transition" data-view="quiz">
                                    <i class="fas fa-brain mr-3 text-green-500"></i>
                                    <span class="font-semibold">Take a Quiz</span>
                                </button>
                                <button class="w-full text-left p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition" data-view="ads">
                                    <i class="fas fa-ad mr-3 text-purple-500"></i>
                                    <span class="font-semibold">Watch Ads for Points</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4">Recent Activity</h3>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${state.user.history && state.user.history.length > 0 
                                    ? state.user.history.slice(-5).reverse().map(activity => `
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <span class="text-sm">${activity.action}</span>
                                            <span class="text-sm font-semibold text-green-600">+${activity.points}</span>
                                        </div>
                                    `).join('')
                                    : '<p class="text-gray-500 text-center py-4">No recent activity</p>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLearn() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Available Courses</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.lessons.map(course => `
                            <div class="card p-6 hover:shadow-lg transition cursor-pointer" data-course="${course.id}">
                                <div class="flex justify-between items-start mb-4">
                                    <h3 class="font-bold text-lg text-gray-800">${course.title}</h3>
                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${course.difficulty}</span>
                                </div>
                                <p class="text-gray-600 text-sm mb-4">${course.category} â€¢ ${course.duration} min</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-yellow-500 font-semibold">+${course.points} points</span>
                                    <button class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                                        Start Learning
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderQuiz() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Available Quizzes</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${state.quizzes.map(quiz => `
                            <div class="card p-6">
                                <h3 class="font-bold text-lg mb-2">${quiz.title}</h3>
                                <p class="text-gray-600 mb-4">Category: ${quiz.category}</p>
                                <button class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition" data-quiz="${quiz.id}">
                                    Start Quiz
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderAds() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Watch Ads to Earn Points</h2>
                    <div class="ad-container h-64 mb-6">
                        <div id="ad-rotation-container">
                            ${renderAdSlide(state.currentAdIndex)}
                        </div>
                    </div>
                    <div class="ad-indicators">
                        ${AD_ROTATION_DATA.map((_, index) => `
                            <div class="ad-indicator ${index === state.currentAdIndex ? 'active' : ''}" 
                                 onclick="setAdIndex(${index})"></div>
                        `).join('')}
                    </div>
                    <button class="w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition font-semibold" onclick="addPoints('Ad View', 500)">
                        <i class="fas fa-play-circle mr-2"></i>Watch Ad & Earn 500 Points
                    </button>
                </div>
            `;
        }

        function renderReferral() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Refer & Earn</h2>
                    <div class="card p-6 text-center">
                        <i class="fas fa-user-plus text-5xl text-green-500 mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Invite Your Friends</h3>
                        <p class="text-gray-600 mb-4">Share your referral code and earn 1000 points for each friend who signs up!</p>
                        
                        <div class="bg-gray-100 p-4 rounded-lg mb-4">
                            <p class="text-sm text-gray-600 mb-2">Your Referral Code</p>
                            <p class="text-2xl font-bold text-blue-600">${state.user.referralCode}</p>
                        </div>
                        
                        <p class="text-sm text-gray-500">Share this code with your friends when they sign up</p>
                    </div>
                </div>
            `;
        }

        function renderRewards() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Withdraw Your Earnings</h2>
                    <div class="card p-6">
                        <div class="text-center mb-6">
                            <p class="text-gray-600">Current Balance</p>
                            <p class="text-4xl font-bold text-blue-600">${formatPoints(state.user.eduPoints)} points</p>
                            <p class="text-sm text-gray-500 mt-2">Minimum withdrawal: ${formatPoints(MIN_WITHDRAWAL_POINTS)} points</p>
                        </div>
                        
                        ${state.user.eduPoints >= MIN_WITHDRAWAL_POINTS 
                            ? `<button class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition font-semibold" onclick="showWithdrawModal()">
                                Withdraw Points
                               </button>`
                            : `<button class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold cursor-not-allowed" disabled>
                                Need ${formatPoints(MIN_WITHDRAWAL_POINTS - state.user.eduPoints)} more points
                               </button>`
                        }
                    </div>
                </div>
            `;
        }

        function renderLeaderboard() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Leaderboard</h2>
                    <div class="card p-6">
                        <div class="space-y-4">
                            ${Object.values(state.allUsers)
                                .sort((a, b) => b.eduPoints - a.eduPoints)
                                .slice(0, 10)
                                .map((user, index) => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-3">
                                            ${index + 1}
                                        </span>
                                        <span class="font-semibold">${user.name}</span>
                                    </div>
                                    <span class="font-bold text-yellow-600">${formatPoints(user.eduPoints)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAchievements() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Achievements</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.achievements.map(achievement => `
                            <div class="card p-6 text-center achievement-badge">
                                <i class="${achievement.icon} text-4xl text-yellow-500 mb-4"></i>
                                <h3 class="font-bold text-lg mb-2">${achievement.name}</h3>
                                <p class="text-gray-600 text-sm mb-3">${achievement.description}</p>
                                <span class="bg-yellow-100 text-yellow-800 text-sm px-3 py-1 rounded-full">
                                    +${formatPoints(achievement.points)} points
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCourseDetail() {
            if (!state.currentCourse) return '<div>Course not found</div>';
            
            return `
                <div class="max-w-4xl mx-auto py-6">
                    <div class="card p-6">
                        <button onclick="state.currentView = 'learn'; render();" class="mb-4 text-blue-500 hover:text-blue-700 transition">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Courses
                        </button>
                        
                        <h1 class="text-3xl font-bold mb-4">${state.currentCourse.title}</h1>
                        <div class="flex items-center space-x-4 mb-6">
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">${state.currentCourse.category}</span>
                            <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm">${state.currentCourse.difficulty}</span>
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">${state.currentCourse.duration} min</span>
                        </div>
                        
                        ${state.currentCourse.content}
                        
                        <div class="mt-6 text-center">
                            <button onclick="completeCourse('${state.currentCourse.id}')" class="bg-green-500 text-white px-8 py-3 rounded-lg hover:bg-green-600 transition font-semibold">
                                <i class="fas fa-check-circle mr-2"></i>Complete Course & Earn ${state.currentCourse.points} Points
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // =====================================================
        // MISSING EVENT LISTENER FUNCTIONS
        // =====================================================

        function attachNavListeners() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const view = e.currentTarget.getAttribute('data-view');
                    state.currentView = view;
                    render();
                });
            });
        }

        function attachContentListeners() {
            // Course click listeners
            document.querySelectorAll('[data-course]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const courseId = e.currentTarget.getAttribute('data-course');
                    const course = state.lessons.find(c => c.id === courseId);
                    if (course) {
                        state.currentCourse = course;
                        state.currentView = 'course-detail';
                        render();
                    }
                });
            });

            // Quiz click listeners
            document.querySelectorAll('[data-quiz]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const quizId = e.currentTarget.getAttribute('data-quiz');
                    startQuiz(quizId);
                });
            });

            // Quick action buttons
            document.querySelectorAll('[data-view]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const view = e.currentTarget.getAttribute('data-view');
                    state.currentView = view;
                    render();
                });
            });
        }

        function attachCourseDetailListeners() {
            // Add any course-specific listeners here
        }

        function updateNotifications() {
            // Implementation for notifications
        }

        function completeCourse(courseId) {
            const course = state.lessons.find(c => c.id === courseId);
            if (course) {
                addPoints(`Completed: ${course.title}`, course.points);
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-check-circle text-5xl text-green-500"></i>
                        <h3 class="text-xl font-bold text-green-600">Course Completed!</h3>
                        <p class="text-gray-600">You earned ${course.points} points!</p>
                    </div>
                `, () => {
                    state.currentView = 'learn';
                    render();
                });
            }
        }

        function startQuiz(quizId) {
            // Quiz implementation
            showModal(`
                <div class="text-center space-y-3">
                    <i class="fas fa-brain text-5xl text-blue-500"></i>
                    <h3 class="text-xl font-bold text-blue-600">Quiz Feature</h3>
                    <p class="text-gray-600">Quiz functionality will be implemented here.</p>
                </div>
            `);
        }

        function showWithdrawModal() {
            showModal(`
                <div class="text-center space-y-3">
                    <i class="fas fa-money-bill-wave text-5xl text-green-500"></i>
                    <h3 class="text-xl font-bold text-green-600">Withdrawal Request</h3>
                    <p class="text-gray-600">Withdrawal functionality will be implemented here.</p>
                </div>
            `);
        }

        function updateLeaderboards() {
            // Implementation for leaderboard updates
        }

        function checkAchievements() {
            // Implementation for achievement checking
        }

        function hasReachedDailyLimit(user) {
            // Implementation for daily limit check
            return false;
        }

        function resetDailyCourses() {
            // Implementation for resetting daily courses
        }

        // =====================================================
        // AUTH SCREEN FUNCTIONS (your existing ones)
        // =====================================================

        function renderAuthScreen() {
            // Your existing implementation
        }

        function renderLoginForm() {
            // Your existing implementation
        }

        function renderSignupForm() {
            // Your existing implementation
        }

        function attachAuthListeners() {
            // Your existing implementation
        }

        function handleAuthError(message) {
            // Your existing implementation
        }

        // Initialize the application
        window.onload = initializeData;
    </script>
</body>
</html>
