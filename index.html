<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduHeTech - Learn & Earn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #3b82f6; /* Blue 500 */
            --secondary-color: #1d4ed8; /* Blue 700 */
            --success-color: #10b981; /* Green 500 */
            --warning-color: #f59e0b; /* Amber 500 */
            --danger-color: #ef4444; /* Red 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            min-height: 100vh;
        }
        .scrollable-content {
            max-height: calc(100vh - 80px); /* Adjust based on header height */
            overflow-y: auto;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-radius: 0.5rem;
            color: white;
            transition: transform 0.1s ease;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Custom modal overlay styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 50;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* New styles for enhanced UI */
        .progress-ring {
            transform: rotate(-90deg);
        }
        .streak-flame {
            animation: pulse 1.5s infinite alternate;
        }
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .achievement-badge {
            transition: transform 0.3s ease;
        }
        .achievement-badge:hover {
            transform: scale(1.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .course-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .course-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .course-section:last-child {
            border-bottom: none;
        }
        .refresh-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            animation: pulse 2s infinite;
        }
        
        /* Ad rotation styles */
        .ad-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .ad-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            text-align: center;
        }
        .ad-slide.active {
            opacity: 1;
            position: relative;
        }
        .ad-indicators {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .ad-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #cbd5e1;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .ad-indicator.active {
            background-color: var(--primary-color);
        }
        .ad-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        .ad-description {
            color: #6b7280;
            margin-bottom: 1rem;
        }
        .ad-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        
        /* Learn section specific ad styles */
        .learn-ad-container {
            height: 180px;
            margin-bottom: 1.5rem;
        }
        .learn-ad-slide {
            padding: 1rem;
        }
        .learn-ad-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .learn-ad-description {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        .learn-ad-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="loader"></div>
    </div>

    <!-- Global Modal Structure -->
    <div id="global-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4 z-40">
        <div class="card w-full max-w-sm p-6 space-y-4 slide-in">
            <div id="modal-content"></div>
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" onclick="hideModal()" class="p-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm" class="p-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition hidden">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Application Root -->
    <div id="app">
        <!-- Content rendered by JavaScript -->
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-500">Initializing EduHeTech...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDKcWF9bOA9aSZOkeODE_N8Ag_wS87J_0",
            authDomain: "studio-4004347076-d761a.firebaseapp.com",
            projectId: "studio-4004347076-d761a",
            storageBucket: "studio-4004347076-d761a.firebasestorage.app",
            messagingSenderId: "316122123573",
            appId: "1:316122123573:web:b36fe06376e37948ea907c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseApp = app;
        window.firebaseModules = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            collection,
            query,
            where,
            getDocs
        };

        console.log("Firebase initialized successfully!");
    </script>

    <script>
        // =====================================================
        // APPLICATION CONSTANTS AND STATE
        // =====================================================
        
        // Local Storage Keys (for app data, not auth)
        const LS_USERS = 'eduhetech_users_v10';
        const LS_WITHDRAWALS = 'eduhetech_withdrawals_v10';
        const LS_LESSONS = 'eduhetech_lessons_v10';
        const LS_QUIZZES = 'eduhetech_quizzes_v10';
        const LS_ACHIEVEMENTS = 'eduhetech_achievements_v10';

        // Ad rotation data
        const AD_ROTATION_DATA = [
            {
                id: 'ad1',
                title: 'Boost Your Learning',
                description: 'Discover premium courses to advance your skills',
                icon: 'fas fa-rocket',
                category: 'education',
                color: 'from-blue-500 to-indigo-600'
            },
            {
                id: 'ad2',
                title: 'Earn More Points',
                description: 'Complete daily challenges for bonus rewards',
                icon: 'fas fa-coins',
                category: 'rewards',
                color: 'from-green-500 to-teal-600'
            },
            {
                id: 'ad3',
                title: 'Refer Friends',
                description: 'Share your link and earn 1000 points per referral',
                icon: 'fas fa-user-plus',
                category: 'referral',
                color: 'from-purple-500 to-pink-600'
            },
            {
                id: 'ad4',
                title: 'Limited Time Offer',
                description: 'Double points on all courses this weekend',
                icon: 'fas fa-bolt',
                category: 'promotion',
                color: 'from-yellow-500 to-orange-600'
            },
            {
                id: 'ad5',
                title: 'New Courses Available',
                description: 'Check out our latest course additions',
                icon: 'fas fa-book-open',
                category: 'education',
                color: 'from-red-500 to-pink-600'
            }
        ];
        
        // Educational-focused ads for Learn section
        const LEARN_AD_DATA = [
            {
                id: 'learn-ad1',
                title: 'Master New Skills',
                description: 'Expand your knowledge with our advanced courses',
                icon: 'fas fa-graduation-cap',
                category: 'education',
                color: 'from-blue-500 to-purple-600'
            },
            {
                id: 'learn-ad2',
                title: 'Learning Streak Bonus',
                description: 'Maintain your streak for extra points',
                icon: 'fas fa-fire',
                category: 'rewards',
                color: 'from-orange-500 to-red-500'
            },
            {
                id: 'learn-ad3',
                title: 'Expert Instructors',
                description: 'Learn from industry professionals',
                icon: 'fas fa-chalkboard-teacher',
                category: 'education',
                color: 'from-green-500 to-blue-500'
            },
            {
                id: 'learn-ad4',
                title: 'Course Completion Rewards',
                description: 'Earn bonus points when you finish courses',
                icon: 'fas fa-trophy',
                category: 'rewards',
                color: 'from-yellow-500 to-orange-500'
            }
        ];
        
        const BASE_POINTS_REWARDS = {
            lesson: 500,
            quiz: 50,
            ad: 500,
            dailyLogin: 100,
            referral: 1000,
            streak: 500,
            achievement: 5000
        };
        const MIN_WITHDRAWAL_POINTS = 100000;
        const DAILY_POINTS_LIMIT = 10000;

        // Global State Management
        window.state = {
            user: null,
            currentView: 'loading',
            isLoading: false,
            quizData: null,
            allUsers: {},
            withdrawalRequests: [],
            lessons: [],
            quizzes: [],
            achievements: [],
            notifications: [],
            currentCourse: null,
            currentAdIndex: 0,
            currentLearnAdIndex: 0,
            adRotationInterval: null,
            learnAdRotationInterval: null,
            firebaseUser: null
        };

        // =====================================================
        // FIREBASE AUTHENTICATION FUNCTIONS
        // =====================================================

        async function handleFirebaseSignup(name, email, password, referrerCode = null) {
            try {
                showLoading(true);
                
                const { createUserWithEmailAndPassword, doc, setDoc } = window.firebaseModules;
                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                
                // Create user in Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Create user profile in Firestore
                const userData = {
                    uid: firebaseUser.uid,
                    name: name,
                    email: email,
                    eduPoints: 1000, // Starting bonus
                    referralCount: 0,
                    referralCode: generateReferralCode(),
                    lastLogin: Date.now(),
                    loginDates: [new Date().toDateString()],
                    history: [{ 
                        action: 'Welcome Bonus', 
                        points: 1000, 
                        timestamp: Date.now() 
                    }],
                    achievements: [],
                    completedCoursesToday: {},
                    lastCourseReset: new Date().toDateString(),
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                // Save to Firestore
                await setDoc(doc(db, 'users', firebaseUser.uid), userData);
                
                // Handle referral if applicable
                if (referrerCode) {
                    await handleReferral(referrerCode, firebaseUser.uid);
                }

                // Update local state
                state.firebaseUser = firebaseUser;
                state.user = userData;
                
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-check-circle text-5xl text-green-500"></i>
                        <h3 class="text-xl font-bold text-green-600">Account Created!</h3>
                        <p class="text-gray-600">Welcome to EduHeTech, ${name}!</p>
                        <p class="text-sm text-green-600">You received 1000 welcome bonus points!</p>
                    </div>
                `, () => {
                    setTimeout(hideModal, 2000);
                    state.currentView = 'dashboard';
                    render();
                });

            } catch (error) {
                console.error("Signup error:", error);
                handleAuthError(getFirebaseErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        async function handleFirebaseLogin(email, password) {
            try {
                showLoading(true);
                
                const { signInWithEmailAndPassword, doc, getDoc, updateDoc } = window.firebaseModules;
                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Get user data from Firestore
                const userDoc = await getDoc(doc(db, 'users', firebaseUser.uid));
                
                if (!userDoc.exists()) {
                    throw new Error('User data not found. Please contact support.');
                }
                
                const userData = userDoc.data();
                
                // Update login info
                const today = new Date().toDateString();
                const lastLoginDate = new Date(userData.lastLogin).toDateString();
                
                if (today !== lastLoginDate) {
                    if (!userData.loginDates) userData.loginDates = [];
                    if (!userData.loginDates.includes(today)) {
                        userData.loginDates.push(today);
                    }
                    
                    // Add daily login bonus
                    const streak = calculateStreak(userData.loginDates);
                    userData.streak = streak;
                    
                    if (!hasReachedDailyLimit(userData)) {
                        userData.eduPoints += BASE_POINTS_REWARDS.dailyLogin;
                        userData.history.push({
                            action: 'Daily Login Bonus',
                            points: BASE_POINTS_REWARDS.dailyLogin,
                            timestamp: Date.now()
                        });
                    }
                    
                    userData.lastLogin = Date.now();
                    
                    // Update in Firestore
                    await updateDoc(doc(db, 'users', firebaseUser.uid), {
                        loginDates: userData.loginDates,
                        streak: userData.streak,
                        eduPoints: userData.eduPoints,
                        history: userData.history,
                        lastLogin: userData.lastLogin,
                        updatedAt: Date.now()
                    });
                }

                // Update local state
                state.firebaseUser = firebaseUser;
                state.user = userData;
                
                state.currentView = 'dashboard';
                render();

            } catch (error) {
                console.error("Login error:", error);
                handleAuthError(getFirebaseErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        async function handleFirebaseLogout() {
            try {
                showLoading(true);
                const { signOut } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                await signOut(auth);
                state.firebaseUser = null;
                state.user = null;
                state.currentView = 'auth';
                render();
            } catch (error) {
                console.error("Logout error:", error);
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Logout Error</h3>
                        <p class="text-gray-600">${error.message}</p>
                    </div>
                `);
            } finally {
                showLoading(false);
            }
        }

        async function handleReferral(referrerCode, newUserId) {
            try {
                const { collection, query, where, getDocs, doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // Find referrer by referral code
                const referrersSnapshot = await getDocs(
                    query(collection(db, 'users'), where('referralCode', '==', referrerCode))
                );
                
                if (!referrersSnapshot.empty) {
                    const referrerDoc = referrersSnapshot.docs[0];
                    const referrerData = referrerDoc.data();
                    
                    // Update referrer's data
                    const newReferralCount = (referrerData.referralCount || 0) + 1;
                    const newPoints = referrerData.eduPoints + BASE_POINTS_REWARDS.referral;
                    
                    await updateDoc(doc(db, 'users', referrerDoc.id), {
                        referralCount: newReferralCount,
                        eduPoints: newPoints,
                        history: [
                            ...(referrerData.history || []),
                            {
                                action: `Referral Bonus - ${state.user.name}`,
                                points: BASE_POINTS_REWARDS.referral,
                                timestamp: Date.now()
                            }
                        ],
                        updatedAt: Date.now()
                    });
                    
                    // Also update new user's data to track who referred them
                    await updateDoc(doc(db, 'users', newUserId), {
                        referredBy: referrerDoc.id,
                        updatedAt: Date.now()
                    });
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error("Referral error:", error);
                return false;
            }
        }

        function getFirebaseErrorMessage(error) {
            const errorMap = {
                'auth/email-already-in-use': 'This email is already registered.',
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/operation-not-allowed': 'Email/password accounts are not enabled.',
                'auth/weak-password': 'Password should be at least 6 characters.',
                'auth/user-disabled': 'This account has been disabled.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/too-many-requests': 'Too many attempts. Please try again later.'
            };
            
            return errorMap[error.code] || error.message || 'An error occurred. Please try again.';
        }

        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Auth State Listener
        function initializeAuthStateListener() {
            const { onAuthStateChanged, doc, getDoc } = window.firebaseModules;
            const auth = window.firebaseAuth;
            const db = window.firebaseDb;
            
            onAuthStateChanged(auth, async (firebaseUser) => {
                if (firebaseUser) {
                    // User is signed in
                    try {
                        const userDoc = await getDoc(doc(db, 'users', firebaseUser.uid));
                        
                        if (userDoc.exists()) {
                            state.firebaseUser = firebaseUser;
                            state.user = userDoc.data();
                            
                            // Initialize app data
                            initializeAppData();
                            
                            if (state.currentView === 'auth' || state.currentView === 'loading') {
                                state.currentView = 'dashboard';
                            }
                        } else {
                            // User document doesn't exist - sign them out
                            const { signOut } = window.firebaseModules;
                            await signOut(auth);
                            state.firebaseUser = null;
                            state.user = null;
                            state.currentView = 'auth';
                            showModal(`
                                <div class="text-center space-y-3">
                                    <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                                    <h3 class="text-xl font-bold text-red-600">Account Error</h3>
                                    <p class="text-gray-600">Your account data was not found. Please contact support.</p>
                                </div>
                            `);
                        }
                    } catch (error) {
                        console.error("Error loading user data:", error);
                        state.currentView = 'auth';
                    }
                } else {
                    // User is signed out
                    state.firebaseUser = null;
                    state.user = null;
                    state.currentView = 'auth';
                }
                render();
            });
        }

        // =====================================================
        // DATA PERSISTENCE FUNCTIONS
        // =====================================================

        async function saveUser(userData) {
            if (!state.firebaseUser) return;
            
            try {
                const { doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // Update in Firestore
                await updateDoc(doc(db, 'users', state.firebaseUser.uid), {
                    ...userData,
                    updatedAt: Date.now()
                });
                
                // Also update local state
                state.user = { ...state.user, ...userData };
            } catch (error) {
                console.error("Error saving user:", error);
                // Fallback to localStorage for critical data
                const fallbackData = loadAllUsers();
                fallbackData[state.firebaseUser.uid] = { ...state.user, ...userData };
                saveAllUsers(fallbackData);
            }
        }

        async function addPoints(action, points, checkDailyLimit = true) {
            if (!state.user || !state.firebaseUser) return;
            
            if (checkDailyLimit && hasReachedDailyLimit(state.user)) {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-yellow-500"></i>
                        <h3 class="text-xl font-bold text-yellow-600">Daily Limit Reached</h3>
                        <p class="text-gray-600">You have reached your daily earning limit of ${formatPoints(DAILY_POINTS_LIMIT)} points. Come back tomorrow to earn more!</p>
                    </div>
                `);
                return;
            }
            
            showLoading(true);

            try {
                const { doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const newPoints = state.user.eduPoints + points;
                const historyEntry = { action, points, timestamp: Date.now() };
                const updatedHistory = [...(state.user.history || []), historyEntry];

                // Update in Firestore
                await updateDoc(doc(db, 'users', state.firebaseUser.uid), {
                    eduPoints: newPoints,
                    history: updatedHistory,
                    updatedAt: Date.now()
                });

                // Update local state
                state.user.eduPoints = newPoints;
                state.user.history = updatedHistory;

                updateLeaderboards();
                checkAchievements();

                render();

                // Show points animation
                const coinAnimation = document.getElementById('coin-animation');
                if (coinAnimation) {
                    coinAnimation.innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg slide-in">
                            <div class="flex items-center">
                                <i class="fas fa-coins text-xl mr-2"></i>
                                <span class="font-bold">+${points} EduPoints!</span>
                            </div>
                            <p class="text-sm mt-1">${action}</p>
                        </div>
                    `;
                    setTimeout(() => {
                        if (coinAnimation) coinAnimation.innerHTML = '';
                    }, 3000);
                }

            } catch (error) {
                console.error("Error adding points:", error);
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Error</h3>
                        <p class="text-gray-600">Failed to add points. Please try again.</p>
                    </div>
                `);
            } finally {
                showLoading(false);
            }
        }

        function loadAllUsers() {
            try {
                const usersJson = localStorage.getItem(LS_USERS);
                return usersJson ? JSON.parse(usersJson) : {};
            } catch (e) {
                console.error("Error loading users from LS:", e);
                return {};
            }
        }

        function saveAllUsers(users) {
            try {
                localStorage.setItem(LS_USERS, JSON.stringify(users));
                state.allUsers = users;
            } catch (e) {
                console.error("Error saving users to LS:", e);
            }
        }

        function loadCollection(key) {
            try {
                const dataJson = localStorage.getItem(key);
                return dataJson ? JSON.parse(dataJson) : [];
            } catch (e) {
                console.error(`Error loading collection ${key} from LS:`, e);
                return [];
            }
        }

        function saveCollection(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving collection ${key} to LS:`, e);
            }
        }

        // =====================================================
        // AD ROTATION SYSTEM
        // =====================================================

        function startAdRotation() {
            if (state.adRotationInterval) {
                clearInterval(state.adRotationInterval);
            }
            
            state.adRotationInterval = setInterval(() => {
                rotateAd();
            }, 5000);
        }

        function startLearnAdRotation() {
            if (state.learnAdRotationInterval) {
                clearInterval(state.learnAdRotationInterval);
            }
            
            state.learnAdRotationInterval = setInterval(() => {
                rotateLearnAd();
            }, 6000);
        }

        function stopAdRotation() {
            if (state.adRotationInterval) {
                clearInterval(state.adRotationInterval);
                state.adRotationInterval = null;
            }
        }

        function stopLearnAdRotation() {
            if (state.learnAdRotationInterval) {
                clearInterval(state.learnAdRotationInterval);
                state.learnAdRotationInterval = null;
            }
        }

        function rotateAd() {
            state.currentAdIndex = (state.currentAdIndex + 1) % AD_ROTATION_DATA.length;
            updateAdDisplay();
        }

        function rotateLearnAd() {
            state.currentLearnAdIndex = (state.currentLearnAdIndex + 1) % LEARN_AD_DATA.length;
            updateLearnAdDisplay();
        }

        function setAdIndex(index) {
            state.currentAdIndex = index;
            updateAdDisplay();
        }

        function setLearnAdIndex(index) {
            state.currentLearnAdIndex = index;
            updateLearnAdDisplay();
        }

        function updateAdDisplay() {
            const adContainer = document.getElementById('ad-rotation-container');
            if (!adContainer) return;
            
            adContainer.innerHTML = renderAdSlide(state.currentAdIndex);
            
            // Update indicators
            const indicators = document.querySelectorAll('.ad-indicator');
            indicators.forEach((indicator, index) => {
                if (index === state.currentAdIndex) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        function updateLearnAdDisplay() {
            const adContainer = document.getElementById('learn-ad-rotation-container');
            if (!adContainer) return;
            
            adContainer.innerHTML = renderLearnAdSlide(state.currentLearnAdIndex);
            
            // Update indicators
            const indicators = document.querySelectorAll('.learn-ad-indicator');
            indicators.forEach((indicator, index) => {
                if (index === state.currentLearnAdIndex) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        function renderAdSlide(index) {
            const ad = AD_ROTATION_DATA[index];
            return `
                <div class="ad-slide active bg-gradient-to-r ${ad.color} text-white rounded-lg p-6 h-full flex flex-col justify-center items-center text-center">
                    <i class="${ad.icon} ad-icon"></i>
                    <h3 class="ad-title text-white">${ad.title}</h3>
                    <p class="ad-description text-white text-opacity-90">${ad.description}</p>
                    <button class="mt-4 bg-white text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-opacity-90 transition">
                        Learn More
                    </button>
                </div>
            `;
        }

        function renderLearnAdSlide(index) {
            const ad = LEARN_AD_DATA[index];
            return `
                <div class="ad-slide active bg-gradient-to-r ${ad.color} text-white rounded-lg h-full flex flex-col justify-center items-center text-center learn-ad-slide">
                    <i class="${ad.icon} learn-ad-icon"></i>
                    <h3 class="learn-ad-title text-white font-bold">${ad.title}</h3>
                    <p class="learn-ad-description text-white text-opacity-90">${ad.description}</p>
                    <button class="mt-2 bg-white text-gray-800 font-semibold py-1 px-4 rounded-lg hover:bg-opacity-90 transition text-sm">
                        Explore
                    </button>
                </div>
            `;
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        function render() {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;
            appContainer.innerHTML = '';
            showLoading(state.isLoading);

            if (!state.user) {
                appContainer.innerHTML = renderAuthScreen();
                attachAuthListeners();
            } else if (state.currentView === 'loading') {
                appContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full p-8"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p class="mt-4 text-gray-500">Loading Dashboard...</p></div>';
            } else if (state.currentView === 'course-detail') {
                appContainer.innerHTML = renderHeader() + renderCourseDetail();
                attachCourseDetailListeners();
            } else {
                appContainer.innerHTML = renderHeader() + renderContent();
                attachNavListeners();
                attachContentListeners();
                updateNotifications();
                
                // Start appropriate ad rotations based on current view
                if (state.currentView === 'ads') {
                    startAdRotation();
                    stopLearnAdRotation();
                } else if (state.currentView === 'learn') {
                    startLearnAdRotation();
                    stopAdRotation();
                } else {
                    stopAdRotation();
                    stopLearnAdRotation();
                }
            }
            
            updateBrowserTitle();
        }

        function showLoading(show) {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        function showModal(content, onConfirm = null, onCancel = null) {
            const modal = document.getElementById('global-modal');
            const modalContent = document.getElementById('modal-content');
            const modalConfirm = document.getElementById('modal-confirm');
            const modalCancel = document.getElementById('modal-cancel');

            if (!modal || !modalContent) return;

            modalContent.innerHTML = content;
            modal.classList.remove('hidden');

            if (onConfirm) {
                modalConfirm.classList.remove('hidden');
                modalConfirm.onclick = () => {
                    onConfirm();
                    modal.classList.add('hidden');
                    modalConfirm.onclick = null;
                };
            } else {
                modalConfirm.classList.add('hidden');
                modalConfirm.onclick = null;
            }

            if (onCancel) {
                modalCancel.classList.remove('hidden');
                modalCancel.onclick = () => {
                    onCancel();
                    modal.classList.add('hidden');
                    modalCancel.onclick = null;
                };
            } else {
                modalCancel.classList.add('hidden');
                modalCancel.onclick = null;
            }
        }

        function hideModal() {
            document.getElementById('global-modal').classList.add('hidden');
        }

        function formatPoints(points) {
            return points.toLocaleString();
        }

        function generateUniqueId() {
            return 'user-' + Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function calculateStreak(loginDates) {
            if (!loginDates || loginDates.length === 0) return 0;
            
            const sortedDates = [...loginDates].sort((a, b) => new Date(b) - new Date(a));
            let streak = 1;
            let currentDate = new Date(sortedDates[0]);
            
            for (let i = 1; i < sortedDates.length; i++) {
                const prevDate = new Date(currentDate);
                prevDate.setDate(prevDate.getDate() - 1);
                
                const checkDate = new Date(sortedDates[i]);
                if (checkDate.toDateString() === prevDate.toDateString()) {
                    streak++;
                    currentDate = checkDate;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function updateBrowserTitle() {
            const viewTitles = {
                'dashboard': 'Dashboard',
                'learn': 'Learn',
                'quiz': 'Quiz',
                'ads': 'Watch Ads',
                'referral': 'Refer & Earn',
                'rewards': 'Withdraw',
                'leaderboard': 'Leaderboard',
                'achievements': 'Achievements',
                'course-detail': state.currentCourse ? state.currentCourse.title : 'Course'
            };
            
            const title = viewTitles[state.currentView] || 'EduHeTech';
            document.title = `${title} - EduHeTech`;
        }

        // =====================================================
        // CORE APPLICATION LOGIC
        // =====================================================

        function initMockData() {
            if (loadCollection(LS_LESSONS).length === 0) {
                saveCollection(LS_LESSONS, getAllCourses());
            }

            if (loadCollection(LS_QUIZZES).length === 0) {
                saveCollection(LS_QUIZZES, getAllQuizzes());
            }

            if (loadCollection(LS_ACHIEVEMENTS).length === 0) {
                const mockAchievements = [
                    { id: 'a1', name: 'First Steps', description: 'Complete your first lesson', icon: 'fas fa-footsteps', points: 5000, type: 'bronze', condition: { type: 'lessonsCompleted', threshold: 1 } },
                    { id: 'a2', name: 'Quiz Whiz', description: 'Complete 5 quizzes', icon: 'fas fa-brain', points: 10000, type: 'silver', condition: { type: 'quizzesCompleted', threshold: 5 } },
                    { id: 'a3', name: 'Learning Streak', description: 'Maintain a 7-day learning streak', icon: 'fas fa-fire', points: 15000, type: 'gold', condition: { type: 'streak', threshold: 7 } },
                    { id: 'a4', name: 'Point Collector', description: 'Earn 50,000 points', icon: 'fas fa-coins', points: 20000, type: 'gold', condition: { type: 'points', threshold: 50000 } },
                    { id: 'a5', name: 'Referral Master', description: 'Refer 5 friends', icon: 'fas fa-users', points: 25000, type: 'platinum', condition: { type: 'referrals', threshold: 5 } },
                    { id: 'a6', name: 'Daily Learner', description: 'Complete 5 courses in one day', icon: 'fas fa-calendar-day', points: 15000, type: 'silver', condition: { type: 'dailyLessons', threshold: 5 } },
                    { id: 'a7', name: 'Tech Guru', description: 'Complete 5 technology courses', icon: 'fas fa-laptop-code', points: 15000, type: 'silver', condition: { type: 'categoryCompleted', threshold: 5, category: 'Technology' } },
                    { id: 'a8', name: 'Business Pro', description: 'Complete 5 business courses', icon: 'fas fa-briefcase', points: 15000, type: 'silver', condition: { type: 'categoryCompleted', threshold: 5, category: 'Business & Entrepreneurship' } }
                ];
                saveCollection(LS_ACHIEVEMENTS, mockAchievements);
            }
        }

        function getAllCourses() {
            return [
                {
                    id: 'health-1',
                    title: 'Introduction to Complementary and Alternative Medicine',
                    category: 'Health & Medicine',
                    subcategory: 'Alternative Medicine',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">What is Complementary and Alternative Medicine?</h3>
                                <p class="mb-3">Complementary and Alternative Medicine (CAM) refers to medical products and practices that are not part of standard medical care.</p>
                                <p class="mb-3">Complementary medicine is used together with standard medical care. An example is using acupuncture to help with side effects of cancer treatment.</p>
                            </div>
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Types of Complementary and Alternative Medicine</h3>
                                <h4 class="font-bold mb-2">1. Natural Products</h4>
                                <p class="mb-3">This includes herbs, vitamins, minerals, and probiotics.</p>
                                <h4 class="font-bold mb-2">2. Mind and Body Practices</h4>
                                <p class="mb-3">These include techniques such as acupuncture, massage therapy, meditation, and yoga.</p>
                            </div>
                        </div>
                    `,
                    duration: 10,
                    difficulty: 'Beginner',
                    points: 500,
                    order: 1
                },
                {
                    id: 'health-2',
                    title: 'Community Health Principles and Practices',
                    category: 'Health & Medicine',
                    subcategory: 'Public Health',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Introduction to Community Health</h3>
                                <p class="mb-3">Community health is a field of public health that focuses on studying, protecting, or improving health within a community.</p>
                            </div>
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Key Principles of Community Health</h3>
                                <h4 class="font-bold mb-2">1. Community Participation</h4>
                                <p class="mb-3">Active involvement of community members in identifying health problems and developing solutions.</p>
                                <h4 class="font-bold mb-2">2. Equity and Social Justice</h4>
                                <p class="mb-3">Ensuring fair distribution of health resources and addressing health disparities.</p>
                            </div>
                        </div>
                    `,
                    duration: 12,
                    difficulty: 'Intermediate',
                    points: 500,
                    order: 2
                }
            ];
        }

        function getAllQuizzes() {
            return [
                {
                    id: 'health-1-quiz',
                    title: 'Complementary and Alternative Medicine Quiz',
                    category: 'Health & Medicine',
                    courseId: 'health-1',
                    questions: [
                        { 
                            q: 'What is the main difference between complementary and alternative medicine?', 
                            options: [
                                'Complementary medicine is used together with standard care, while alternative medicine is used instead of standard care',
                                'Complementary medicine is more scientific than alternative medicine',
                                'Alternative medicine is always safer than complementary medicine',
                                'There is no significant difference between the two'
                            ], 
                            answer: 'Complementary medicine is used together with standard care, while alternative medicine is used instead of standard care' 
                        }
                    ]
                }
            ];
        }

        function initializeAppData() {
            // Load local data
            state.allUsers = loadAllUsers();
            state.lessons = loadCollection(LS_LESSONS).sort((a, b) => a.order - b.order);
            state.quizzes = loadCollection(LS_QUIZZES);
            state.withdrawalRequests = loadCollection(LS_WITHDRAWALS);
            state.achievements = loadCollection(LS_ACHIEVEMENTS);

            resetDailyCourses();
            updateLeaderboards();
            checkAchievements();
            
            initializeBrowserHistory();
        }

        function initializeData() {
            initMockData();
            
            // Initialize Firebase auth state listener
            initializeAuthStateListener();
            
            // Set initial view to loading - will be updated by auth state listener
            state.currentView = 'loading';
            render();
        }

        function initializeBrowserHistory() {
            window.history.replaceState({ view: state.currentView }, '', window.location.pathname);
        }

        // =====================================================
        // RENDER FUNCTIONS
        // =====================================================

        function renderAuthScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="w-full max-w-md card p-8 space-y-6 shadow-xl">
                        <div class="text-center">
                            <h1 class="text-4xl font-extrabold text-blue-600 mb-2">EduHeTech</h1>
                            <p class="text-gray-600">Learn valuable skills and earn rewards!</p>
                        </div>

                        <div id="auth-form-container" class="space-y-4">
                            <!-- Auth Form will be rendered here -->
                        </div>

                        <div class="text-center">
                            <button id="toggle-auth" class="text-sm text-blue-500 hover:text-blue-700 font-medium transition-colors">Need an account? Sign Up</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoginForm() {
            return `
                <h2 class="text-2xl font-bold text-center text-gray-800">Welcome Back</h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <button id="login-btn" class="w-full p-3 btn-primary font-semibold rounded-lg shadow-md hover:shadow-lg transition">Log In</button>
                </div>
                <div id="auth-error-message" class="text-red-500 text-sm text-center mt-2"></div>
            `;
        }

        function renderSignupForm() {
            return `
                <h2 class="text-2xl font-bold text-center text-gray-800">Join EduHeTech</h2>
                <div class="space-y-4">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="signup-name" placeholder="Enter your full name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="signup-password" placeholder="Create a password (min 6 chars)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-referral" class="block text-sm font-medium text-gray-700 mb-1">Referral Code (Optional)</label>
                        <input type="text" id="signup-referral" placeholder="Enter referral code if you have one" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <button id="signup-btn" class="w-full p-3 btn-primary font-semibold rounded-lg shadow-md hover:shadow-lg transition">Create Account</button>
                </div>
                <div id="auth-error-message" class="text-red-500 text-sm text-center mt-2"></div>
            `;
        }

        function attachAuthListeners() {
            const container = document.getElementById('auth-form-container');
            const toggleBtn = document.getElementById('toggle-auth');
            let isLogin = true;

            const updateForm = () => {
                container.innerHTML = isLogin ? renderLoginForm() : renderSignupForm();
                toggleBtn.textContent = isLogin ? 'Need an account? Sign Up' : 'Already have an account? Log In';
                attachFormListeners();
            };

            const attachFormListeners = () => {
                // Login form
                document.getElementById('login-btn')?.addEventListener('click', () => {
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    handleFirebaseLogin(email, password);
                });
                
                // Signup form
                document.getElementById('signup-btn')?.addEventListener('click', () => {
                    const name = document.getElementById('signup-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const referrerId = document.getElementById('signup-referral').value;
                    handleFirebaseSignup(name, email, password, referrerId);
                });
                
                // Enter key support
                const attachEnterKey = (inputId, buttonId) => {
                    document.getElementById(inputId)?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') document.getElementById(buttonId)?.click();
                    });
                };
                
                attachEnterKey('login-email', 'login-btn');
                attachEnterKey('login-password', 'login-btn');
                attachEnterKey('signup-name', 'signup-btn');
                attachEnterKey('signup-email', 'signup-btn');
                attachEnterKey('signup-password', 'signup-btn');
            };

            toggleBtn?.addEventListener('click', () => {
                isLogin = !isLogin;
                updateForm();
            });

            updateForm();
        }

        function handleAuthError(message) {
            const errorEl = document.getElementById('auth-error-message');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('slide-in');
                setTimeout(() => errorEl.classList.remove('slide-in'), 500);
            }
        }

        // Initialize the application
        window.onload = initializeData;
    </script>
</body>
</html>
