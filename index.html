<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduHeTech - Learn & Earn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1d4ed8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-radius: 0.5rem;
            color: white;
            transition: transform 0.1s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 50;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .streak-flame {
            animation: pulse 1.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .achievement-badge {
            transition: transform 0.3s ease;
        }
        
        .achievement-badge:hover {
            transform: scale(1.1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .course-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .course-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .course-section:last-child {
            border-bottom: none;
        }
        
        .refresh-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            animation: pulse 2s infinite;
        }
        
        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 40;
            display: none;
        }
        
        .mobile-nav-item {
            flex: 1;
            text-align: center;
            padding: 0.75rem 0.5rem;
            color: #6b7280;
            transition: color 0.2s;
        }
        
        .mobile-nav-item.active {
            color: var(--primary-color);
        }
        
        .mobile-nav-item i {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        .mobile-nav-item span {
            font-size: 0.75rem;
            display: block;
        }
        
        /* Splash screen styles */
        .splash-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .splash-logo {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-30px);}
            60% {transform: translateY(-15px);}
        }
        
        /* Admin dashboard styles */
        .admin-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
        }
        
        /* Google Sign-In Button */
        .google-signin-btn {
            background: white;
            color: #757575;
            border: 1px solid #dadce0;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.2s;
        }
        
        .google-signin-btn:hover {
            background: #f8f9fa;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
            }
            
            .desktop-sidebar {
                display: none;
            }
            
            .main-content {
                padding-bottom: 5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            addDoc, 
            orderBy, 
            limit, 
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDKcWF9bOA9aSZOkeODE_N8Ag_wS87J_0",
            authDomain: "studio-4004347076-d761a.firebaseapp.com",
            projectId: "studio-4004347076-d761a",
            storageBucket: "studio-4004347076-d761a.firebasestorage.app",
            messagingSenderId: "316122123573",
            appId: "1:316122123573:web:b36fe06376e37948ea907c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseApp = app;
        window.googleProvider = googleProvider;
        window.firebaseModules = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            collection,
            query,
            where,
            getDocs,
            addDoc,
            orderBy,
            limit,
            onSnapshot
        };

        console.log("Firebase initialized successfully!");
    </script>
</head>
<body class="text-gray-800">

    <!-- Splash Screen -->
    <div id="splash-screen" class="splash-screen fixed inset-0 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="splash-logo mb-8">
                <i class="fas fa-graduation-cap text-6xl mb-4"></i>
                <h1 class="text-5xl font-bold">EduHeTech</h1>
            </div>
            <p class="text-xl opacity-90">Learn • Earn • Grow</p>
            <div class="mt-8">
                <div class="loader mx-auto border-white"></div>
            </div>
        </div>
    </div>

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="loader"></div>
    </div>

    <!-- Global Modal Structure -->
    <div id="global-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4 z-40">
        <div class="card w-full max-w-sm p-6 space-y-4 slide-in">
            <div id="modal-content"></div>
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" onclick="hideModal()" class="p-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm" class="p-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition hidden">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Application Root -->
    <div id="app">
        <!-- Content rendered by JavaScript -->
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-500">Initializing EduHeTech...</p>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <a href="#dashboard" class="mobile-nav-item active" data-view="dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="#learn" class="mobile-nav-item" data-view="learn">
            <i class="fas fa-book"></i>
            <span>Learn</span>
        </a>
        <a href="#quiz" class="mobile-nav-item" data-view="quiz">
            <i class="fas fa-brain"></i>
            <span>Quiz</span>
        </a>
        <a href="#ads" class="mobile-nav-item" data-view="ads">
            <i class="fas fa-ad"></i>
            <span>Ads</span>
        </a>
        <a href="#referral" class="mobile-nav-item" data-view="referral">
            <i class="fas fa-users"></i>
            <span>Refer</span>
        </a>
    </div>

    <script>
        // =====================================================
        // APPLICATION CONSTANTS AND STATE
        // =====================================================
        
        // Firebase Collections
        const FIRESTORE_COLLECTIONS = {
            USERS: 'users',
            WITHDRAWALS: 'withdrawals',
            LESSONS: 'lessons',
            QUIZZES: 'quizzes',
            ACHIEVEMENTS: 'achievements',
            LEADERBOARD: 'leaderboard',
            NOTIFICATIONS: 'notifications'
        };

        // Monetag Smart Links
        const MONETAG_SMART_LINKS = [
            'https://otieu.com/4/10070319',
            'https://otieu.com/4/10070318',
            'https://otieu.com/4/10070317',
            'https://otieu.com/4/10070316',
            'https://otieu.com/4/10070315',
            'https://otieu.com/4/10070314',
            'https://otieu.com/4/7667810',
            'https://otieu.com/4/7667811',
            'https://otieu.com/4/7667754',
            'https://otieu.com/4/7667716'
        ];

        // Admin Configuration
        const ADMIN_CONFIG = {
            ADMIN_EMAILS: ['admin@eduhetech.com'],
            MIN_WITHDRAWAL_AMOUNT: 500000,
            POINTS_TO_CURRENCY_RATE: 10000
        };

        // Updated point rewards as specified
        const BASE_POINTS_REWARDS = {
            lesson: 500,
            quiz: 200,
            ad: 100,
            dailyLogin: 100,
            referral: 1000,
            streak: 500,
            achievement: 1000
        };
        
        const MIN_WITHDRAWAL_POINTS = 500000;
        const DAILY_POINTS_LIMIT = 10000;

        // Global State Management
        window.state = {
            user: null,
            currentView: 'loading',
            isLoading: false,
            quizData: null,
            withdrawalRequests: [],
            lessons: [],
            quizzes: [],
            achievements: [],
            notifications: [],
            currentCourse: null,
            firebaseUser: null,
            isAdmin: false,
            currentMonetagLink: '',
            referralCode: getUrlParameter('ref') // Get referral code from URL
        };

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        function getUrlParameter(name) {
            name = name.replace(/[[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // =====================================================
        // SPLASH SCREEN & INITIALIZATION
        // =====================================================

        function showSplashScreen() {
            const splashScreen = document.getElementById('splash-screen');
            splashScreen.classList.remove('hidden');
            
            // Hide splash screen after 3 seconds
            setTimeout(() => {
                splashScreen.style.opacity = '0';
                splashScreen.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                    initializeAuthStateListener();
                }, 500);
            }, 3000);
        }

        // =====================================================
        // FIREBASE AUTHENTICATION FUNCTIONS
        // =====================================================

        async function handleFirebaseSignup(name, email, password, referrerCode = null) {
            try {
                showLoading(true);
                
                const { createUserWithEmailAndPassword, doc, setDoc } = window.firebaseModules;
                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                
                // Create user in Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Generate unique referral code
                const referralCode = generateReferralCode();
                
                // Create user profile in Firestore
                const userData = {
                    uid: firebaseUser.uid,
                    name: name,
                    email: email,
                    eduPoints: 1000, // Starting bonus
                    referralCount: 0,
                    referralCode: referralCode,
                    lastLogin: Date.now(),
                    loginDates: [new Date().toDateString()],
                    history: [{ 
                        action: 'Welcome Bonus', 
                        points: 1000, 
                        timestamp: Date.now() 
                    }],
                    achievements: [],
                    completedCourses: {},
                    completedQuizzes: {},
                    completedCoursesToday: {},
                    lastCourseReset: new Date().toDateString(),
                    streak: 1,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                // Save to Firestore
                await setDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid), userData);
                
                // Handle referral if applicable
                if (referrerCode) {
                    await handleReferral(referrerCode, firebaseUser.uid);
                }

                // Update local state
                state.firebaseUser = firebaseUser;
                state.user = userData;
                state.isAdmin = ADMIN_CONFIG.ADMIN_EMAILS.includes(email);
                
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-check-circle text-5xl text-green-500"></i>
                        <h3 class="text-xl font-bold text-green-600">Account Created!</h3>
                        <p class="text-gray-600">Welcome to EduHeTech, ${name}!</p>
                        <p class="text-sm text-green-600">You received 1000 welcome bonus points!</p>
                        ${referrerCode ? `<p class="text-sm text-blue-600">Referral bonus applied!</p>` : ''}
                    </div>
                `, () => {
                    setTimeout(hideModal, 2000);
                    state.currentView = 'dashboard';
                    render();
                });

            } catch (error) {
                console.error("Signup error:", error);
                handleAuthError(getFirebaseErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        async function handleGoogleSignIn() {
            try {
                showLoading(true);
                const { signInWithPopup, doc, setDoc, getDoc } = window.firebaseModules;
                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                
                const result = await signInWithPopup(auth, window.googleProvider);
                const firebaseUser = result.user;
                
                // Check if user already exists
                const userDoc = await getDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid));
                
                if (!userDoc.exists()) {
                    // Create new user profile
                    const referralCode = generateReferralCode();
                    const userData = {
                        uid: firebaseUser.uid,
                        name: firebaseUser.displayName,
                        email: firebaseUser.email,
                        eduPoints: 1000,
                        referralCount: 0,
                        referralCode: referralCode,
                        lastLogin: Date.now(),
                        loginDates: [new Date().toDateString()],
                        history: [{ 
                            action: 'Welcome Bonus', 
                            points: 1000, 
                            timestamp: Date.now() 
                        }],
                        achievements: [],
                        completedCourses: {},
                        completedQuizzes: {},
                        completedCoursesToday: {},
                        lastCourseReset: new Date().toDateString(),
                        streak: 1,
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    };

                    await setDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid), userData);
                    
                    // Handle referral if applicable
                    if (state.referralCode) {
                        await handleReferral(state.referralCode, firebaseUser.uid);
                    }
                    
                    state.user = userData;
                } else {
                    state.user = userDoc.data();
                }

                state.firebaseUser = firebaseUser;
                state.isAdmin = ADMIN_CONFIG.ADMIN_EMAILS.includes(firebaseUser.email);
                
                // Initialize app data
                await initializeAppData();
                
                state.currentView = 'dashboard';
                render();

            } catch (error) {
                console.error("Google Sign-In error:", error);
                handleAuthError(getFirebaseErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        async function handleFirebaseLogin(email, password) {
            try {
                showLoading(true);
                
                const { signInWithEmailAndPassword, doc, getDoc, updateDoc } = window.firebaseModules;
                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Get user data from Firestore
                const userDoc = await getDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid));
                
                if (!userDoc.exists()) {
                    throw new Error('User data not found. Please contact support.');
                }
                
                const userData = userDoc.data();
                
                // Update login info
                const today = new Date().toDateString();
                const lastLoginDate = new Date(userData.lastLogin).toDateString();
                
                if (today !== lastLoginDate) {
                    if (!userData.loginDates) userData.loginDates = [];
                    if (!userData.loginDates.includes(today)) {
                        userData.loginDates.push(today);
                    }
                    
                    // Add daily login bonus
                    const streak = calculateStreak(userData.loginDates);
                    userData.streak = streak;
                    
                    if (!hasReachedDailyLimit(userData)) {
                        userData.eduPoints += BASE_POINTS_REWARDS.dailyLogin;
                        userData.history.push({
                            action: 'Daily Login Bonus',
                            points: BASE_POINTS_REWARDS.dailyLogin,
                            timestamp: Date.now()
                        });
                    }
                    
                    userData.lastLogin = Date.now();
                    
                    // Update in Firestore
                    await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid), {
                        loginDates: userData.loginDates,
                        streak: userData.streak,
                        eduPoints: userData.eduPoints,
                        history: userData.history,
                        lastLogin: userData.lastLogin,
                        updatedAt: Date.now()
                    });
                }

                // Update local state
                state.firebaseUser = firebaseUser;
                state.user = userData;
                state.isAdmin = ADMIN_CONFIG.ADMIN_EMAILS.includes(email);
                
                // Initialize app data
                await initializeAppData();
                
                state.currentView = 'dashboard';
                render();

            } catch (error) {
                console.error("Login error:", error);
                handleAuthError(getFirebaseErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        async function handleFirebaseLogout() {
            try {
                showLoading(true);
                const { signOut } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                await signOut(auth);
                state.firebaseUser = null;
                state.user = null;
                state.isAdmin = false;
                state.currentView = 'auth';
                render();
            } catch (error) {
                console.error("Logout error:", error);
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Logout Error</h3>
                        <p class="text-gray-600">${error.message}</p>
                    </div>
                `);
            } finally {
                showLoading(false);
            }
        }

        async function handleReferral(referrerCode, newUserId) {
            try {
                const { collection, query, where, getDocs, doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // Find referrer by referral code
                const referrersSnapshot = await getDocs(
                    query(collection(db, FIRESTORE_COLLECTIONS.USERS), where('referralCode', '==', referrerCode))
                );
                
                if (!referrersSnapshot.empty) {
                    const referrerDoc = referrersSnapshot.docs[0];
                    const referrerData = referrerDoc.data();
                    
                    // Update referrer's data
                    const newReferralCount = (referrerData.referralCount || 0) + 1;
                    const newPoints = referrerData.eduPoints + BASE_POINTS_REWARDS.referral;
                    
                    await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, referrerDoc.id), {
                        referralCount: newReferralCount,
                        eduPoints: newPoints,
                        history: [
                            ...(referrerData.history || []),
                            {
                                action: 'Referral Bonus',
                                points: BASE_POINTS_REWARDS.referral,
                                timestamp: Date.now()
                            }
                        ],
                        updatedAt: Date.now()
                    });
                    
                    // Also update new user's data to track who referred them
                    await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, newUserId), {
                        referredBy: referrerDoc.id,
                        updatedAt: Date.now()
                    });
                    
                    // Give bonus to new user as well
                    const newUserDoc = await getDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, newUserId));
                    if (newUserDoc.exists()) {
                        const newUserData = newUserDoc.data();
                        await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, newUserId), {
                            eduPoints: newUserData.eduPoints + 500, // Extra bonus for using referral
                            history: [
                                ...(newUserData.history || []),
                                {
                                    action: 'Referral Signup Bonus',
                                    points: 500,
                                    timestamp: Date.now()
                                }
                            ]
                        });
                    }
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error("Referral error:", error);
                return false;
            }
        }

        function getFirebaseErrorMessage(error) {
            const errorMap = {
                'auth/email-already-in-use': 'This email is already registered.',
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/operation-not-allowed': 'Email/password accounts are not enabled.',
                'auth/weak-password': 'Password should be at least 6 characters.',
                'auth/user-disabled': 'This account has been disabled.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/too-many-requests': 'Too many attempts. Please try again later.',
                'auth/popup-closed-by-user': 'Sign-in was cancelled.',
                'auth/popup-blocked': 'Sign-in popup was blocked. Please allow popups for this site.'
            };
            
            return errorMap[error.code] || error.message || 'An error occurred. Please try again.';
        }

        // Auth State Listener
        function initializeAuthStateListener() {
            const { onAuthStateChanged, doc, getDoc } = window.firebaseModules;
            const auth = window.firebaseAuth;
            const db = window.firebaseDb;
            
            onAuthStateChanged(auth, async (firebaseUser) => {
                if (firebaseUser) {
                    // User is signed in
                    try {
                        const userDoc = await getDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid));
                        
                        if (userDoc.exists()) {
                            state.firebaseUser = firebaseUser;
                            state.user = userDoc.data();
                            state.isAdmin = ADMIN_CONFIG.ADMIN_EMAILS.includes(state.user.email);
                            
                            // Initialize app data
                            await initializeAppData();
                            
                            if (state.currentView === 'auth' || state.currentView === 'loading') {
                                state.currentView = 'dashboard';
                            }
                        } else {
                            // User document doesn't exist - sign them out
                            const { signOut } = window.firebaseModules;
                            await signOut(auth);
                            state.firebaseUser = null;
                            state.user = null;
                            state.isAdmin = false;
                            state.currentView = 'auth';
                            showModal(`
                                <div class="text-center space-y-3">
                                    <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                                    <h3 class="text-xl font-bold text-red-600">Account Error</h3>
                                    <p class="text-gray-600">Your account data was not found. Please contact support.</p>
                                </div>
                            `);
                        }
                    } catch (error) {
                        console.error("Error loading user data:", error);
                        state.currentView = 'auth';
                    }
                } else {
                    // User is signed out
                    state.firebaseUser = null;
                    state.user = null;
                    state.isAdmin = false;
                    state.currentView = 'auth';
                }
                render();
            });
        }

        // =====================================================
        // MONETAG SMART LINK FUNCTIONS
        // =====================================================

        function getRandomMonetagLink() {
            const randomIndex = Math.floor(Math.random() * MONETAG_SMART_LINKS.length);
            return MONETAG_SMART_LINKS[randomIndex];
        }

        function updateMonetagLink() {
            state.currentMonetagLink = getRandomMonetagLink();
        }

        function openMonetagAd() {
            if (!state.user) return;
            
            updateMonetagLink();
            if (state.currentMonetagLink) {
                // Open the monetag link in a new tab
                window.open(state.currentMonetagLink, '_blank');
                
                // Add points after ad view
                addPoints('Watch Ad', BASE_POINTS_REWARDS.ad, true);
                
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-check-circle text-5xl text-green-500"></i>
                        <h3 class="text-xl font-bold text-green-600">Ad Viewed!</h3>
                        <p class="text-gray-600">You earned ${BASE_POINTS_REWARDS.ad} EduPoints for watching the ad.</p>
                        <p class="text-sm text-blue-600">The ad has been opened in a new tab.</p>
                    </div>
                `, () => {
                    setTimeout(hideModal, 3000);
                });
            }
        }

        // =====================================================
        // FIREBASE DATA FUNCTIONS
        // =====================================================

        async function saveUser(userData) {
            if (!state.firebaseUser) return;
            
            try {
                const { doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // Update in Firestore
                await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, state.firebaseUser.uid), {
                    ...userData,
                    updatedAt: Date.now()
                });
                
                // Also update local state
                state.user = { ...state.user, ...userData };
            } catch (error) {
                console.error("Error saving user:", error);
            }
        }

        async function addPoints(action, points, checkDailyLimit = true) {
            if (!state.user || !state.firebaseUser) return;
            
            // Check if user has reached daily limit (excluding referral bonuses)
            if (checkDailyLimit && hasReachedDailyLimit(state.user) && !action.includes('Referral')) {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-yellow-500"></i>
                        <h3 class="text-xl font-bold text-yellow-600">Daily Limit Reached</h3>
                        <p class="text-gray-600">You have reached your daily earning limit of ${formatPoints(DAILY_POINTS_LIMIT)} points. Come back tomorrow to earn more!</p>
                        <p class="text-sm text-blue-600">Note: Referral bonuses are not counted towards daily limits.</p>
                    </div>
                `);
                return;
            }
            
            showLoading(true);

            try {
                const { doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const newPoints = state.user.eduPoints + points;
                const historyEntry = { action, points, timestamp: Date.now() };
                const updatedHistory = [historyEntry, ...(state.user.history || [])];

                // Update in Firestore
                await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, state.firebaseUser.uid), {
                    eduPoints: newPoints,
                    history: updatedHistory,
                    updatedAt: Date.now()
                });

                // Update local state
                state.user.eduPoints = newPoints;
                state.user.history = updatedHistory;

                await updateLeaderboards();
                checkAchievements();

                render();

                // Show points animation
                const coinAnimation = document.createElement('div');
                coinAnimation.className = 'fixed top-4 right-4 z-30';
                coinAnimation.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg slide-in">
                        <div class="flex items-center">
                            <i class="fas fa-coins text-xl mr-2"></i>
                            <span class="font-bold">+${points} EduPoints!</span>
                        </div>
                        <p class="text-sm mt-1">${action}</p>
                    </div>
                `;
                document.body.appendChild(coinAnimation);
                
                setTimeout(() => {
                    if (coinAnimation.parentNode) {
                        document.body.removeChild(coinAnimation);
                    }
                }, 3000);

            } catch (error) {
                console.error("Error adding points:", error);
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Error</h3>
                        <p class="text-gray-600">Failed to add points. Please try again.</p>
                    </div>
                `);
            } finally {
                showLoading(false);
            }
        }

        async function loadCollection(collectionName) {
            try {
                const { collection, getDocs } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const querySnapshot = await getDocs(collection(db, collectionName));
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            } catch (error) {
                console.error(`Error loading collection ${collectionName}:`, error);
                return [];
            }
        }

        async function saveToCollection(collectionName, data) {
            try {
                const { collection, addDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const docRef = await addDoc(collection(db, collectionName), data);
                return docRef.id;
            } catch (error) {
                console.error(`Error saving to collection ${collectionName}:`, error);
                return null;
            }
        }

        // =====================================================
        // CORE APPLICATION LOGIC
        // =====================================================

        async function initMockData() {
            // Initialize lessons if empty
            const existingLessons = await loadCollection(FIRESTORE_COLLECTIONS.LESSONS);
            if (existingLessons.length === 0) {
                const lessons = getAllCourses();
                for (const lesson of lessons) {
                    await saveToCollection(FIRESTORE_COLLECTIONS.LESSONS, lesson);
                }
            }

            // Initialize quizzes if empty
            const existingQuizzes = await loadCollection(FIRESTORE_COLLECTIONS.QUIZZES);
            if (existingQuizzes.length === 0) {
                const quizzes = getAllQuizzes();
                for (const quiz of quizzes) {
                    await saveToCollection(FIRESTORE_COLLECTIONS.QUIZZES, quiz);
                }
            }

            // Initialize achievements if empty
            const existingAchievements = await loadCollection(FIRESTORE_COLLECTIONS.ACHIEVEMENTS);
            if (existingAchievements.length === 0) {
                const achievements = getAllAchievements();
                for (const achievement of achievements) {
                    await saveToCollection(FIRESTORE_COLLECTIONS.ACHIEVEMENTS, achievement);
                }
            }
        }

        function getAllCourses() {
            return [
                {
                    id: 'health-1',
                    title: 'Introduction to Complementary and Alternative Medicine',
                    category: 'Health & Medicine',
                    subcategory: 'Alternative Medicine',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">What is Complementary and Alternative Medicine?</h3>
                                <p class="mb-3">Complementary and Alternative Medicine (CAM) refers to medical products and practices that are not part of standard medical care.</p>
                            </div>
                        </div>
                    `,
                    duration: 10,
                    difficulty: 'Beginner',
                    points: 500,
                    order: 1
                },
                {
                    id: 'tech-1',
                    title: 'Introduction to Web Development',
                    category: 'Technology',
                    subcategory: 'Web Development',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">What is Web Development?</h3>
                                <p class="mb-3">Web development refers to the building, creating, and maintaining of websites.</p>
                            </div>
                        </div>
                    `,
                    duration: 15,
                    difficulty: 'Beginner',
                    points: 500,
                    order: 2
                }
            ];
        }

        function getAllQuizzes() {
            return [
                {
                    id: 'health-1-quiz',
                    title: 'Complementary and Alternative Medicine Quiz',
                    category: 'Health & Medicine',
                    courseId: 'health-1',
                    questions: [
                        { 
                            q: 'What is the main difference between complementary and alternative medicine?', 
                            options: [
                                'Complementary medicine is used together with standard care, while alternative medicine is used instead of standard care',
                                'Complementary medicine is more scientific than alternative medicine',
                                'Alternative medicine is always safer than complementary medicine',
                                'There is no significant difference between the two'
                            ], 
                            answer: 'Complementary medicine is used together with standard care, while alternative medicine is used instead of standard care' 
                        }
                    ]
                },
                {
                    id: 'tech-1-quiz',
                    title: 'Web Development Basics Quiz',
                    category: 'Technology',
                    courseId: 'tech-1',
                    questions: [
                        { 
                            q: 'Which language is primarily used for styling web pages?', 
                            options: [
                                'HTML',
                                'CSS',
                                'JavaScript',
                                'Python'
                            ], 
                            answer: 'CSS' 
                        }
                    ]
                }
            ];
        }

        function getAllAchievements() {
            return [
                { id: 'a1', name: 'First Steps', description: 'Complete your first lesson', icon: 'fas fa-footsteps', points: 1000, type: 'bronze', condition: { type: 'lessonsCompleted', threshold: 1 } },
                { id: 'a2', name: 'Quiz Whiz', description: 'Complete 5 quizzes', icon: 'fas fa-brain', points: 1000, type: 'silver', condition: { type: 'quizzesCompleted', threshold: 5 } },
                { id: 'a3', name: 'Learning Streak', description: 'Maintain a 7-day learning streak', icon: 'fas fa-fire', points: 1000, type: 'gold', condition: { type: 'streak', threshold: 7 } }
            ];
        }

        async function initializeAppData() {
            // Load data from Firestore
            state.lessons = await loadCollection(FIRESTORE_COLLECTIONS.LESSONS);
            state.quizzes = await loadCollection(FIRESTORE_COLLECTIONS.QUIZZES);
            state.achievements = await loadCollection(FIRESTORE_COLLECTIONS.ACHIEVEMENTS);
            state.withdrawalRequests = await loadCollection(FIRESTORE_COLLECTIONS.WITHDRAWALS);

            // Initialize mock data if needed
            await initMockData();
            
            resetDailyCourses();
            await updateLeaderboards();
            checkAchievements();
            
            // Initialize monetag link
            updateMonetagLink();
        }

        function resetDailyCourses() {
            if (!state.user) return;
            
            const today = new Date().toDateString();
            if (state.user.lastCourseReset !== today) {
                state.user.completedCoursesToday = {};
                state.user.lastCourseReset = today;
                saveUser({ completedCoursesToday: {}, lastCourseReset: today });
            }
        }

        async function updateLeaderboards() {
            try {
                const { collection, query, orderBy, limit, getDocs } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // Get top 10 users by points
                const leaderboardQuery = query(
                    collection(db, FIRESTORE_COLLECTIONS.USERS),
                    orderBy('eduPoints', 'desc'),
                    limit(10)
                );
                
                const querySnapshot = await getDocs(leaderboardQuery);
                state.leaderboard = [];
                querySnapshot.forEach((doc) => {
                    state.leaderboard.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error("Error updating leaderboard:", error);
            }
        }

        async function checkAchievements() {
            if (!state.user) return;
            
            const userAchievements = state.user.achievements || [];
            const unlockedAchievements = [];
            
            for (const achievement of state.achievements) {
                // Skip if already unlocked
                if (userAchievements.includes(achievement.id)) continue;
                
                let conditionMet = false;
                
                switch (achievement.condition.type) {
                    case 'lessonsCompleted':
                        conditionMet = Object.keys(state.user.completedCourses || {}).length >= achievement.condition.threshold;
                        break;
                    case 'quizzesCompleted':
                        conditionMet = Object.keys(state.user.completedQuizzes || {}).length >= achievement.condition.threshold;
                        break;
                    case 'streak':
                        conditionMet = (state.user.streak || 0) >= achievement.condition.threshold;
                        break;
                }
                
                if (conditionMet) {
                    unlockedAchievements.push(achievement);
                    userAchievements.push(achievement.id);
                    
                    // Add achievement points
                    await addPoints(`Achievement: ${achievement.name}`, achievement.points, false);
                }
            }
            
            if (unlockedAchievements.length > 0) {
                // Update user achievements in Firestore
                await saveUser({ achievements: userAchievements });
                
                // Show achievement notification
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-trophy text-5xl text-yellow-500"></i>
                        <h3 class="text-xl font-bold text-yellow-600">Achievement Unlocked!</h3>
                        <div class="space-y-2">
                            ${unlockedAchievements.map(achievement => `
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <p class="font-semibold">${achievement.name}</p>
                                    <p class="text-sm text-yellow-700">${achievement.description}</p>
                                    <p class="text-sm text-green-600">+${formatPoints(achievement.points)} points!</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `, () => {
                    setTimeout(hideModal, 3000);
                });
            }
        }

        // =====================================================
        // RENDER FUNCTIONS
        // =====================================================

        function renderAuthScreen() {
            const hasReferral = state.referralCode !== '';
            
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="w-full max-w-md card p-8 space-y-6 shadow-xl">
                        <div class="text-center">
                            <h1 class="text-4xl font-extrabold text-blue-600 mb-2">EduHeTech</h1>
                            <p class="text-gray-600">Learn valuable skills and earn rewards!</p>
                            ${hasReferral ? `
                                <div class="mt-2 bg-green-50 border border-green-200 rounded-lg p-3">
                                    <p class="text-green-700 text-sm">
                                        <i class="fas fa-gift mr-1"></i>
                                        You've been referred! Get bonus points when you sign up.
                                    </p>
                                </div>
                            ` : ''}
                        </div>

                        <div id="auth-form-container" class="space-y-4">
                            <!-- Auth Form will be rendered here -->
                        </div>

                        <div class="text-center">
                            <button id="toggle-auth" class="text-sm text-blue-500 hover:text-blue-700 font-medium transition-colors">Need an account? Sign Up</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoginForm() {
            return `
                <h2 class="text-2xl font-bold text-center text-gray-800">Welcome Back</h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <button id="login-btn" class="w-full p-3 btn-primary font-semibold rounded-lg shadow-md hover:shadow-lg transition">Log In</button>
                    
                    <div class="relative my-4">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white text-gray-500">Or continue with</span>
                        </div>
                    </div>
                    
                    <button onclick="handleGoogleSignIn()" class="w-full google-signin-btn">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-5 h-5">
                        Sign in with Google
                    </button>
                </div>
                <div id="auth-error-message" class="text-red-500 text-sm text-center mt-2"></div>
            `;
        }

        function renderSignupForm() {
            return `
                <h2 class="text-2xl font-bold text-center text-gray-800">Join EduHeTech</h2>
                <div class="space-y-4">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="signup-name" placeholder="Enter your full name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="signup-password" placeholder="Create a password (min 6 chars)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    ${state.referralCode ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-blue-700 text-sm">
                                <i class="fas fa-gift mr-1"></i>
                                Referral code detected! You'll get bonus points when you sign up.
                            </p>
                            <input type="hidden" id="signup-referral" value="${state.referralCode}">
                        </div>
                    ` : `
                        <div>
                            <label for="signup-referral" class="block text-sm font-medium text-gray-700 mb-1">Referral Code (Optional)</label>
                            <input type="text" id="signup-referral" placeholder="Enter referral code if you have one" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    `}
                    <button id="signup-btn" class="w-full p-3 btn-primary font-semibold rounded-lg shadow-md hover:shadow-lg transition">Create Account</button>
                    
                    <div class="relative my-4">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white text-gray-500">Or continue with</span>
                        </div>
                    </div>
                    
                    <button onclick="handleGoogleSignIn()" class="w-full google-signin-btn">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-5 h-5">
                        Sign up with Google
                    </button>
                </div>
                <div id="auth-error-message" class="text-red-500 text-sm text-center mt-2"></div>
            `;
        }

        // ... (Previous render functions for header, content, dashboard, learn, quiz, ads, referral, rewards, leaderboard, achievements remain the same)
        // The rest of the rendering functions would be identical to the previous implementation

        // =====================================================
        // EVENT HANDLERS AND INITIALIZATION
        // =====================================================

        function attachAuthListeners() {
            const container = document.getElementById('auth-form-container');
            const toggleBtn = document.getElementById('toggle-auth');
            let isLogin = true;

            const updateForm = () => {
                container.innerHTML = isLogin ? renderLoginForm() : renderSignupForm();
                toggleBtn.textContent = isLogin ? 'Need an account? Sign Up' : 'Already have an account? Log In';
                attachFormListeners();
            };

            const attachFormListeners = () => {
                // Login form
                document.getElementById('login-btn')?.addEventListener('click', () => {
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    handleFirebaseLogin(email, password);
                });
                
                // Signup form
                document.getElementById('signup-btn')?.addEventListener('click', () => {
                    const name = document.getElementById('signup-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const referrerCode = document.getElementById('signup-referral')?.value || state.referralCode;
                    handleFirebaseSignup(name, email, password, referrerCode);
                });
                
                // Enter key support
                const attachEnterKey = (inputId, buttonId) => {
                    document.getElementById(inputId)?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') document.getElementById(buttonId)?.click();
                    });
                };
                
                attachEnterKey('login-email', 'login-btn');
                attachEnterKey('login-password', 'login-btn');
                attachEnterKey('signup-name', 'signup-btn');
                attachEnterKey('signup-email', 'signup-btn');
                attachEnterKey('signup-password', 'signup-btn');
            };

            toggleBtn?.addEventListener('click', () => {
                isLogin = !isLogin;
                updateForm();
            });

            updateForm();
        }

        function handleAuthError(message) {
            const errorEl = document.getElementById('auth-error-message');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('slide-in');
                setTimeout(() => errorEl.classList.remove('slide-in'), 500);
            }
        }

        // ... (All other utility functions like formatPoints, calculateStreak, hasReachedDailyLimit, etc.)
        // ... (All other event handlers like startCourse, completeCourse, startQuiz, completeQuiz, etc.)

        // =====================================================
        // INITIALIZATION
        // =====================================================

        // Start with splash screen
        window.onload = showSplashScreen;

        // Make functions globally available
        window.switchView = switchView;
        window.startCourse = startCourse;
        window.completeCourse = completeCourse;
        window.startQuiz = startQuiz;
        window.completeQuiz = completeQuiz;
        window.copyReferralLink = copyReferralLink;
        window.shareOnWhatsApp = shareOnWhatsApp;
        window.shareOnFacebook = shareOnFacebook;
        window.shareOnTwitter = shareOnTwitter;
        window.submitWithdrawal = submitWithdrawal;
        window.openMonetagAd = openMonetagAd;
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleFirebaseLogout = handleFirebaseLogout;
        window.hideModal = hideModal;
        window.toggleMobileMenu = toggleMobileMenu;

        // Note: Due to character limits, I've focused on the core authentication and referral system.
        // The rendering functions for dashboard, learn, quiz, ads, referral, rewards, leaderboard, and achievements
        // would be identical to the previous implementation but integrated with the new Firebase authentication.
    </script>
</body>
</html>
