<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduHeTech - Learn & Earn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1d4ed8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-radius: 0.5rem;
            color: white;
            transition: transform 0.1s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 50;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .streak-flame {
            animation: pulse 1.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .achievement-badge {
            transition: transform 0.3s ease;
        }
        
        .achievement-badge:hover {
            transform: scale(1.1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .course-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .course-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .course-section:last-child {
            border-bottom: none;
        }
        
        .refresh-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            animation: pulse 2s infinite;
        }
        
        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 40;
            display: none;
        }
        
        .mobile-nav-item {
            flex: 1;
            text-align: center;
            padding: 0.75rem 0.5rem;
            color: #6b7280;
            transition: color 0.2s;
        }
        
        .mobile-nav-item.active {
            color: var(--primary-color);
        }
        
        .mobile-nav-item i {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        .mobile-nav-item span {
            font-size: 0.75rem;
            display: block;
        }
        
        /* Splash screen styles */
        .splash-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .splash-logo {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-30px);}
            60% {transform: translateY(-15px);}
        }
        
        /* Admin dashboard styles */
        .admin-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
            }
            
            .desktop-sidebar {
                display: none;
            }
            
            .main-content {
                padding-bottom: 5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Splash Screen -->
    <div id="splash-screen" class="splash-screen fixed inset-0 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="splash-logo mb-8">
                <i class="fas fa-graduation-cap text-6xl mb-4"></i>
                <h1 class="text-5xl font-bold">EduHeTech</h1>
            </div>
            <p class="text-xl opacity-90">Learn • Earn • Grow</p>
            <div class="mt-8">
                <div class="loader mx-auto border-white"></div>
            </div>
        </div>
    </div>

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="loader"></div>
    </div>

    <!-- Global Modal Structure -->
    <div id="global-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4 z-40">
        <div class="card w-full max-w-sm p-6 space-y-4 slide-in">
            <div id="modal-content"></div>
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" onclick="hideModal()" class="p-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm" class="p-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition hidden">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Application Root -->
    <div id="app">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- Mobile Navigation - Only visible when user is logged in -->
    <div id="mobile-nav" class="mobile-nav hidden">
        <a href="#dashboard" class="mobile-nav-item active" data-view="dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="#learn" class="mobile-nav-item" data-view="learn">
            <i class="fas fa-book"></i>
            <span>Learn</span>
        </a>
        <a href="#quiz" class="mobile-nav-item" data-view="quiz">
            <i class="fas fa-brain"></i>
            <span>Quiz</span>
        </a>
        <a href="#ads" class="mobile-nav-item" data-view="ads">
            <i class="fas fa-ad"></i>
            <span>Ads</span>
        </a>
        <a href="#rewards" class="mobile-nav-item" data-view="rewards">
            <i class="fas fa-wallet"></i>
            <span>Wallet</span>
        </a>
        <a href="#referral" class="mobile-nav-item" data-view="referral">
            <i class="fas fa-users"></i>
            <span>Refer</span>
        </a>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            addDoc, 
            orderBy, 
            limit
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDKcWF9bOA9aSZOkeODE_N8Ag_wS87J_0",
            authDomain: "studio-4004347076-d761a.firebaseapp.com",
            projectId: "studio-4004347076-d761a",
            storageBucket: "studio-4004347076-d761a.firebasestorage.app",
            messagingSenderId: "316122123573",
            appId: "1:316122123573:web:b36fe06376e37948ea907c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseApp = app;
        window.firebaseModules = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            collection,
            query,
            where,
            getDocs,
            addDoc,
            orderBy,
            limit
        };

        console.log("Firebase initialized successfully!");
    </script>

    <script>
        // =====================================================
        // APPLICATION CONSTANTS AND STATE
        // =====================================================
        
        // Firebase Collections
        const FIRESTORE_COLLECTIONS = {
            USERS: 'users',
            WITHDRAWALS: 'withdrawals',
            LESSONS: 'lessons',
            QUIZZES: 'quizzes',
            ACHIEVEMENTS: 'achievements',
            LEADERBOARD: 'leaderboard',
            NOTIFICATIONS: 'notifications'
        };

        // Monetag Smart Links
        const MONETAG_SMART_LINKS = [
            'https://otieu.com/4/10070319',
            'https://otieu.com/4/10070318',
            'https://otieu.com/4/10070317',
            'https://otieu.com/4/10070316',
            'https://otieu.com/4/10070315',
            'https://otieu.com/4/10070314',
            'https://otieu.com/4/7667810',
            'https://otieu.com/4/7667811',
            'https://otieu.com/4/7667754',
            'https://otieu.com/4/7667716'
        ];

        // Admin Configuration
        const ADMIN_CONFIG = {
            ADMIN_EMAILS: ['admin@eduhetech.com'],
            MIN_WITHDRAWAL_AMOUNT: 500000,
            POINTS_TO_CURRENCY_RATE: 10000
        };

        // Updated point rewards as specified
        const BASE_POINTS_REWARDS = {
            lesson: 500,
            quiz: 200,
            ad: 100,
            dailyLogin: 100,
            referral: 1000,
            streak: 500,
            achievement: 1000
        };
        
        const MIN_WITHDRAWAL_POINTS = 500000;
        const DAILY_POINTS_LIMIT = 10000;

        // Global State Management
        window.state = {
            user: null,
            currentView: 'loading',
            isLoading: false,
            quizData: null,
            withdrawalRequests: [],
            lessons: [],
            quizzes: [],
            achievements: [],
            notifications: [],
            currentCourse: null,
            firebaseUser: null,
            isAdmin: false,
            currentMonetagLink: '',
            adTimer: null,
            adTimerActive: false,
            adTimerSeconds: 0,
            referralCode: getUrlParameter('ref') // Get referral code from URL
        };

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        function getUrlParameter(name) {
            name = name.replace(/[[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function formatPoints(points) {
            return points?.toLocaleString() || '0';
        }

        function calculateStreak(loginDates) {
            if (!loginDates || loginDates.length === 0) return 0;
            
            const sortedDates = [...loginDates].sort((a, b) => new Date(b) - new Date(a));
            let streak = 1;
            let currentDate = new Date(sortedDates[0]);
            
            for (let i = 1; i < sortedDates.length; i++) {
                const prevDate = new Date(currentDate);
                prevDate.setDate(prevDate.getDate() - 1);
                
                const checkDate = new Date(sortedDates[i]);
                if (checkDate.toDateString() === prevDate.toDateString()) {
                    streak++;
                    currentDate = checkDate;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function hasReachedDailyLimit(user) {
            if (!user.history) return false;
            
            const today = new Date().toDateString();
            const todayEarnings = user.history
                .filter(entry => {
                    const entryDate = new Date(entry.timestamp).toDateString();
                    return entryDate === today && 
                           entry.points > 0 && 
                           !entry.action.includes('Referral'); // Exclude referral bonuses
                })
                .reduce((sum, entry) => sum + entry.points, 0);
            
            return todayEarnings >= DAILY_POINTS_LIMIT;
        }

        function showLoading(show) {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        function showModal(content, onConfirm = null, onCancel = null) {
            const modal = document.getElementById('global-modal');
            const modalContent = document.getElementById('modal-content');
            const modalConfirm = document.getElementById('modal-confirm');
            const modalCancel = document.getElementById('modal-cancel');

            if (!modal || !modalContent) return;

            modalContent.innerHTML = content;
            modal.classList.remove('hidden');

            if (onConfirm) {
                modalConfirm.classList.remove('hidden');
                modalConfirm.onclick = () => {
                    onConfirm();
                    modal.classList.add('hidden');
                    modalConfirm.onclick = null;
                };
            } else {
                modalConfirm.classList.add('hidden');
                modalConfirm.onclick = null;
            }

            if (onCancel) {
                modalCancel.classList.remove('hidden');
                modalCancel.onclick = () => {
                    onCancel();
                    modal.classList.add('hidden');
                    modalCancel.onclick = null;
                };
            } else {
                modalCancel.classList.add('hidden');
                modalCancel.onclick = null;
            }
        }

        function hideModal() {
            document.getElementById('global-modal').classList.add('hidden');
        }

        function updateBrowserTitle() {
            const viewTitles = {
                'dashboard': 'Dashboard',
                'learn': 'Learn',
                'quiz': 'Quiz',
                'ads': 'Watch Ads',
                'referral': 'Refer & Earn',
                'rewards': 'Withdraw',
                'leaderboard': 'Leaderboard',
                'achievements': 'Achievements'
            };
            
            const title = viewTitles[state.currentView] || 'EduHeTech';
            document.title = `${title} - EduHeTech`;
        }

        function switchView(view) {
            state.currentView = view;
            render();
        }

        function updateMobileNav() {
            const navItems = document.querySelectorAll('.mobile-nav-item');
            navItems.forEach(item => {
                if (item.getAttribute('data-view') === state.currentView) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // =====================================================
        // SPLASH SCREEN & INITIALIZATION
        // =====================================================

        function showSplashScreen() {
            const splashScreen = document.getElementById('splash-screen');
            splashScreen.classList.remove('hidden');
            
            // Hide splash screen after 3 seconds
            setTimeout(() => {
                splashScreen.style.opacity = '0';
                splashScreen.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                    initializeAuthStateListener();
                }, 500);
            }, 3000);
        }

        // =====================================================
        // FIREBASE AUTHENTICATION FUNCTIONS
        // =====================================================

        async function handleFirebaseSignup(name, email, password, referrerCode = null) {
            try {
                showLoading(true);
                
                const { createUserWithEmailAndPassword, doc, setDoc } = window.firebaseModules;
                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                
                // Create user in Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Generate unique referral code
                const referralCode = generateReferralCode();
                
                // Create user profile in Firestore
                const userData = {
                    uid: firebaseUser.uid,
                    name: name,
                    email: email,
                    eduPoints: 1000, // Starting bonus
                    referralCount: 0,
                    referralCode: referralCode,
                    lastLogin: Date.now(),
                    loginDates: [new Date().toDateString()],
                    history: [{ 
                        action: 'Welcome Bonus', 
                        points: 1000, 
                        timestamp: Date.now() 
                    }],
                    achievements: [],
                    completedCourses: {},
                    completedQuizzes: {},
                    completedCoursesToday: {},
                    lastCourseReset: new Date().toDateString(),
                    streak: 1,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                // Save to Firestore
                await setDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid), userData);
                
                // Handle referral if applicable - BOTH referrer and referred get bonuses
                if (referrerCode) {
                    await handleReferral(referrerCode, firebaseUser.uid);
                }

                // Update local state
                state.firebaseUser = firebaseUser;
                state.user = userData;
                state.isAdmin = ADMIN_CONFIG.ADMIN_EMAILS.includes(email);
                
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-check-circle text-5xl text-green-500"></i>
                        <h3 class="text-xl font-bold text-green-600">Account Created!</h3>
                        <p class="text-gray-600">Welcome to EduHeTech, ${name}!</p>
                        <p class="text-sm text-green-600">You received 1000 welcome bonus points!</p>
                        ${referrerCode ? `<p class="text-sm text-blue-600">Referral bonus applied! You received 500 extra points!</p>` : ''}
                    </div>
                `, () => {
                    setTimeout(hideModal, 2000);
                    state.currentView = 'dashboard';
                    render();
                });

            } catch (error) {
                console.error("Signup error:", error);
                handleAuthError(getFirebaseErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        async function handleFirebaseLogin(email, password) {
            try {
                showLoading(true);
                
                const { signInWithEmailAndPassword, doc, getDoc, updateDoc } = window.firebaseModules;
                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Get user data from Firestore
                const userDoc = await getDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid));
                
                if (!userDoc.exists()) {
                    throw new Error('User data not found. Please contact support.');
                }
                
                const userData = userDoc.data();
                
                // Update login info
                const today = new Date().toDateString();
                const lastLoginDate = new Date(userData.lastLogin).toDateString();
                
                if (today !== lastLoginDate) {
                    if (!userData.loginDates) userData.loginDates = [];
                    if (!userData.loginDates.includes(today)) {
                        userData.loginDates.push(today);
                    }
                    
                    // Add daily login bonus
                    const streak = calculateStreak(userData.loginDates);
                    userData.streak = streak;
                    
                    if (!hasReachedDailyLimit(userData)) {
                        userData.eduPoints += BASE_POINTS_REWARDS.dailyLogin;
                        userData.history.push({
                            action: 'Daily Login Bonus',
                            points: BASE_POINTS_REWARDS.dailyLogin,
                            timestamp: Date.now()
                        });
                    }
                    
                    userData.lastLogin = Date.now();
                    
                    // Update in Firestore
                    await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid), {
                        loginDates: userData.loginDates,
                        streak: userData.streak,
                        eduPoints: userData.eduPoints,
                        history: userData.history,
                        lastLogin: userData.lastLogin,
                        updatedAt: Date.now()
                    });
                }

                // Update local state
                state.firebaseUser = firebaseUser;
                state.user = userData;
                state.isAdmin = ADMIN_CONFIG.ADMIN_EMAILS.includes(email);
                
                // Initialize app data
                await initializeAppData();
                
                state.currentView = 'dashboard';
                render();

            } catch (error) {
                console.error("Login error:", error);
                handleAuthError(getFirebaseErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        async function handleFirebaseLogout() {
            try {
                showLoading(true);
                const { signOut } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                await signOut(auth);
                state.firebaseUser = null;
                state.user = null;
                state.isAdmin = false;
                state.currentView = 'auth';
                render();
            } catch (error) {
                console.error("Logout error:", error);
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Logout Error</h3>
                        <p class="text-gray-600">${error.message}</p>
                    </div>
                `);
            } finally {
                showLoading(false);
            }
        }

        async function handleReferral(referrerCode, newUserId) {
            try {
                const { collection, query, where, getDocs, doc, updateDoc, getDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // Find referrer by referral code
                const referrersSnapshot = await getDocs(
                    query(collection(db, FIRESTORE_COLLECTIONS.USERS), where('referralCode', '==', referrerCode))
                );
                
                if (!referrersSnapshot.empty) {
                    const referrerDoc = referrersSnapshot.docs[0];
                    const referrerData = referrerDoc.data();
                    
                    // Update referrer's data - REFERRER GETS BONUS
                    const newReferralCount = (referrerData.referralCount || 0) + 1;
                    const newPoints = referrerData.eduPoints + BASE_POINTS_REWARDS.referral;
                    
                    await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, referrerDoc.id), {
                        referralCount: newReferralCount,
                        eduPoints: newPoints,
                        history: [
                            ...(referrerData.history || []),
                            {
                                action: 'Referral Bonus',
                                points: BASE_POINTS_REWARDS.referral,
                                timestamp: Date.now()
                            }
                        ],
                        updatedAt: Date.now()
                    });
                    
                    // Also update new user's data to track who referred them
                    await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, newUserId), {
                        referredBy: referrerDoc.id,
                        updatedAt: Date.now()
                    });
                    
                    // Give bonus to new user as well - REFERRED USER GETS BONUS TOO
                    const newUserDoc = await getDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, newUserId));
                    if (newUserDoc.exists()) {
                        const newUserData = newUserDoc.data();
                        await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, newUserId), {
                            eduPoints: newUserData.eduPoints + 500, // Extra bonus for using referral
                            history: [
                                ...(newUserData.history || []),
                                {
                                    action: 'Referral Signup Bonus',
                                    points: 500,
                                    timestamp: Date.now()
                                }
                            ]
                        });
                    }
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error("Referral error:", error);
                return false;
            }
        }

        function getFirebaseErrorMessage(error) {
            const errorMap = {
                'auth/email-already-in-use': 'This email is already registered.',
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/operation-not-allowed': 'Email/password accounts are not enabled.',
                'auth/weak-password': 'Password should be at least 6 characters.',
                'auth/user-disabled': 'This account has been disabled.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/too-many-requests': 'Too many attempts. Please try again later.'
            };
            
            return errorMap[error.code] || error.message || 'An error occurred. Please try again.';
        }

        // Auth State Listener
        function initializeAuthStateListener() {
            const { onAuthStateChanged, doc, getDoc } = window.firebaseModules;
            const auth = window.firebaseAuth;
            const db = window.firebaseDb;
            
            onAuthStateChanged(auth, async (firebaseUser) => {
                if (firebaseUser) {
                    // User is signed in
                    try {
                        const userDoc = await getDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, firebaseUser.uid));
                        
                        if (userDoc.exists()) {
                            state.firebaseUser = firebaseUser;
                            state.user = userDoc.data();
                            state.isAdmin = ADMIN_CONFIG.ADMIN_EMAILS.includes(state.user.email);
                            
                            // Initialize app data
                            await initializeAppData();
                            
                            if (state.currentView === 'auth' || state.currentView === 'loading') {
                                state.currentView = 'dashboard';
                            }
                        } else {
                            // User document doesn't exist - sign them out
                            const { signOut } = window.firebaseModules;
                            await signOut(auth);
                            state.firebaseUser = null;
                            state.user = null;
                            state.isAdmin = false;
                            state.currentView = 'auth';
                            showModal(`
                                <div class="text-center space-y-3">
                                    <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                                    <h3 class="text-xl font-bold text-red-600">Account Error</h3>
                                    <p class="text-gray-600">Your account data was not found. Please contact support.</p>
                                </div>
                            `);
                        }
                    } catch (error) {
                        console.error("Error loading user data:", error);
                        state.currentView = 'auth';
                    }
                } else {
                    // User is signed out
                    state.firebaseUser = null;
                    state.user = null;
                    state.isAdmin = false;
                    state.currentView = 'auth';
                }
                render();
            });
        }

        // =====================================================
        // MONETAG SMART LINK FUNCTIONS
        // =====================================================

        function getRandomMonetagLink() {
            const randomIndex = Math.floor(Math.random() * MONETAG_SMART_LINKS.length);
            return MONETAG_SMART_LINKS[randomIndex];
        }

        function updateMonetagLink() {
            state.currentMonetagLink = getRandomMonetagLink();
        }

        function startAdTimer() {
            state.adTimerSeconds = 30;
            state.adTimerActive = true;
            
            // Show timer modal
            showModal(`
                <div class="text-center space-y-4">
                    <i class="fas fa-ad text-5xl text-purple-500 mb-2"></i>
                    <h3 class="text-xl font-bold">Watch Ad to Earn Points</h3>
                    <p class="text-gray-600">Please watch the ad for <span id="ad-timer-seconds">30</span> seconds to earn ${BASE_POINTS_REWARDS.ad} points.</p>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-sm font-semibold text-purple-800">Important:</p>
                        <p class="text-sm text-purple-700">Do not close this window or navigate away, or you won't receive points!</p>
                    </div>
                    <div class="flex justify-center">
                        <div class="bg-gray-200 rounded-full h-4 w-full">
                            <div id="ad-timer-progress" class="bg-purple-500 h-4 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                    <button id="ad-complete-btn" class="w-full bg-gray-400 text-white font-semibold py-3 rounded-lg transition" disabled>
                        Please wait... (<span id="ad-timer">30</span>s)
                    </button>
                </div>
            `);
            
            // Update timer every second
            state.adTimer = setInterval(() => {
                state.adTimerSeconds--;
                
                // Update UI
                document.getElementById('ad-timer').textContent = state.adTimerSeconds;
                document.getElementById('ad-timer-seconds').textContent = state.adTimerSeconds;
                
                // Update progress bar
                const progressPercent = (state.adTimerSeconds / 30) * 100;
                document.getElementById('ad-timer-progress').style.width = `${progressPercent}%`;
                
                // Check if timer is complete
                if (state.adTimerSeconds <= 0) {
                    clearInterval(state.adTimer);
                    state.adTimerActive = false;
                    
                    // Enable the complete button
                    const completeBtn = document.getElementById('ad-complete-btn');
                    completeBtn.disabled = false;
                    completeBtn.textContent = 'Complete & Earn Points';
                    completeBtn.className = 'w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-lg transition';
                    completeBtn.onclick = completeAdView;
                }
            }, 1000);
        }

        function completeAdView() {
            if (!state.user) return;
            
            // Add points for watching ad
            addPoints('Watch Ad', BASE_POINTS_REWARDS.ad, true);
            
            hideModal();
            
            showModal(`
                <div class="text-center space-y-3">
                    <i class="fas fa-check-circle text-5xl text-green-500"></i>
                    <h3 class="text-xl font-bold text-green-600">Ad Completed!</h3>
                    <p class="text-gray-600">You earned ${BASE_POINTS_REWARDS.ad} EduPoints for watching the ad.</p>
                </div>
            `, () => {
                setTimeout(hideModal, 3000);
            });
        }

        function openMonetagAd() {
            if (!state.user) return;
            
            updateMonetagLink();
            if (state.currentMonetagLink) {
                // Start the timer
                startAdTimer();
                
                // Open the monetag link in a new tab
                window.open(state.currentMonetagLink, '_blank');
            }
        }

        // =====================================================
        // FIREBASE DATA FUNCTIONS
        // =====================================================

        async function saveUser(userData) {
            if (!state.firebaseUser) return;
            
            try {
                const { doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // Update in Firestore
                await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, state.firebaseUser.uid), {
                    ...userData,
                    updatedAt: Date.now()
                });
                
                // Also update local state
                state.user = { ...state.user, ...userData };
            } catch (error) {
                console.error("Error saving user:", error);
            }
        }

        async function addPoints(action, points, checkDailyLimit = true) {
            if (!state.user || !state.firebaseUser) return;
            
            // Check if user has reached daily limit (excluding referral bonuses)
            if (checkDailyLimit && hasReachedDailyLimit(state.user) && !action.includes('Referral')) {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-yellow-500"></i>
                        <h3 class="text-xl font-bold text-yellow-600">Daily Limit Reached</h3>
                        <p class="text-gray-600">You have reached your daily earning limit of ${formatPoints(DAILY_POINTS_LIMIT)} points. Come back tomorrow to earn more!</p>
                        <p class="text-sm text-blue-600">Note: Referral bonuses are not counted towards daily limits.</p>
                    </div>
                `);
                return;
            }
            
            showLoading(true);

            try {
                const { doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const newPoints = state.user.eduPoints + points;
                const historyEntry = { action, points, timestamp: Date.now() };
                const updatedHistory = [historyEntry, ...(state.user.history || [])];

                // Update in Firestore
                await updateDoc(doc(db, FIRESTORE_COLLECTIONS.USERS, state.firebaseUser.uid), {
                    eduPoints: newPoints,
                    history: updatedHistory,
                    updatedAt: Date.now()
                });

                // Update local state
                state.user.eduPoints = newPoints;
                state.user.history = updatedHistory;

                await updateLeaderboards();
                checkAchievements();

                render();

                // Show points animation
                const coinAnimation = document.createElement('div');
                coinAnimation.className = 'fixed top-4 right-4 z-30';
                coinAnimation.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg slide-in">
                        <div class="flex items-center">
                            <i class="fas fa-coins text-xl mr-2"></i>
                            <span class="font-bold">+${points} EduPoints!</span>
                        </div>
                        <p class="text-sm mt-1">${action}</p>
                    </div>
                `;
                document.body.appendChild(coinAnimation);
                
                setTimeout(() => {
                    if (coinAnimation.parentNode) {
                        document.body.removeChild(coinAnimation);
                    }
                }, 3000);

            } catch (error) {
                console.error("Error adding points:", error);
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Error</h3>
                        <p class="text-gray-600">Failed to add points. Please try again.</p>
                    </div>
                `);
            } finally {
                showLoading(false);
            }
        }

        async function loadCollection(collectionName) {
            try {
                const { collection, getDocs } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const querySnapshot = await getDocs(collection(db, collectionName));
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            } catch (error) {
                console.error(`Error loading collection ${collectionName}:`, error);
                return [];
            }
        }

        async function saveToCollection(collectionName, data) {
            try {
                const { collection, addDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const docRef = await addDoc(collection(db, collectionName), data);
                return docRef.id;
            } catch (error) {
                console.error(`Error saving to collection ${collectionName}:`, error);
                return null;
            }
        }

        // =====================================================
        // CORE APPLICATION LOGIC
        // =====================================================

        async function initMockData() {
            // Initialize lessons if empty
            const existingLessons = await loadCollection(FIRESTORE_COLLECTIONS.LESSONS);
            if (existingLessons.length === 0) {
                const lessons = getAllCourses();
                for (const lesson of lessons) {
                    await saveToCollection(FIRESTORE_COLLECTIONS.LESSONS, lesson);
                }
            }

            // Initialize quizzes if empty
            const existingQuizzes = await loadCollection(FIRESTORE_COLLECTIONS.QUIZZES);
            if (existingQuizzes.length === 0) {
                const quizzes = getAllQuizzes();
                for (const quiz of quizzes) {
                    await saveToCollection(FIRESTORE_COLLECTIONS.QUIZZES, quiz);
                }
            }

            // Initialize achievements if empty
            const existingAchievements = await loadCollection(FIRESTORE_COLLECTIONS.ACHIEVEMENTS);
            if (existingAchievements.length === 0) {
                const achievements = getAllAchievements();
                for (const achievement of achievements) {
                    await saveToCollection(FIRESTORE_COLLECTIONS.ACHIEVEMENTS, achievement);
                }
            }
        }

        function getAllCourses() {
            return [
                {
                    id: 'health-1',
                    title: 'Introduction to Complementary and Alternative Medicine',
                    category: 'Health & Medicine',
                    subcategory: 'Alternative Medicine',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">What is Complementary and Alternative Medicine?</h3>
                                <p class="mb-3">Complementary and Alternative Medicine (CAM) refers to medical products and practices that are not part of standard medical care.</p>
                            </div>
                        </div>
                    `,
                    duration: 10,
                    difficulty: 'Beginner',
                    points: 500,
                    order: 1
                },
                {
                    id: 'tech-1',
                    title: 'Introduction to Web Development',
                    category: 'Technology',
                    subcategory: 'Web Development',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">What is Web Development?</h3>
                                <p class="mb-3">Web development refers to the building, creating, and maintaining of websites.</p>
                            </div>
                        </div>
                    `,
                    duration: 15,
                    difficulty: 'Beginner',
                    points: 500,
                    order: 2
                }
            ];
        }

        function getAllQuizzes() {
            return [
                {
                    id: 'health-1-quiz',
                    title: 'Complementary and Alternative Medicine Quiz',
                    category: 'Health & Medicine',
                    courseId: 'health-1',
                    questions: [
                        { 
                            q: 'What is the main difference between complementary and alternative medicine?', 
                            options: [
                                'Complementary medicine is used together with standard care, while alternative medicine is used instead of standard care',
                                'Complementary medicine is more scientific than alternative medicine',
                                'Alternative medicine is always safer than complementary medicine',
                                'There is no significant difference between the two'
                            ], 
                            answer: 'Complementary medicine is used together with standard care, while alternative medicine is used instead of standard care' 
                        }
                    ]
                },
                {
                    id: 'tech-1-quiz',
                    title: 'Web Development Basics Quiz',
                    category: 'Technology',
                    courseId: 'tech-1',
                    questions: [
                        { 
                            q: 'Which language is primarily used for styling web pages?', 
                            options: [
                                'HTML',
                                'CSS',
                                'JavaScript',
                                'Python'
                            ], 
                            answer: 'CSS' 
                        }
                    ]
                }
            ];
        }

        function getAllAchievements() {
            return [
                { id: 'a1', name: 'First Steps', description: 'Complete your first lesson', icon: 'fas fa-footsteps', points: 1000, type: 'bronze', condition: { type: 'lessonsCompleted', threshold: 1 } },
                { id: 'a2', name: 'Quiz Whiz', description: 'Complete 5 quizzes', icon: 'fas fa-brain', points: 1000, type: 'silver', condition: { type: 'quizzesCompleted', threshold: 5 } },
                { id: 'a3', name: 'Learning Streak', description: 'Maintain a 7-day learning streak', icon: 'fas fa-fire', points: 1000, type: 'gold', condition: { type: 'streak', threshold: 7 } }
            ];
        }

        async function initializeAppData() {
            // Load data from Firestore
            state.lessons = await loadCollection(FIRESTORE_COLLECTIONS.LESSONS);
            state.quizzes = await loadCollection(FIRESTORE_COLLECTIONS.QUIZZES);
            state.achievements = await loadCollection(FIRESTORE_COLLECTIONS.ACHIEVEMENTS);
            state.withdrawalRequests = await loadCollection(FIRESTORE_COLLECTIONS.WITHDRAWALS);

            // Initialize mock data if needed
            await initMockData();
            
            resetDailyCourses();
            await updateLeaderboards();
            checkAchievements();
            
            // Initialize monetag link
            updateMonetagLink();
        }

        function resetDailyCourses() {
            if (!state.user) return;
            
            const today = new Date().toDateString();
            if (state.user.lastCourseReset !== today) {
                state.user.completedCoursesToday = {};
                state.user.lastCourseReset = today;
                saveUser({ completedCoursesToday: {}, lastCourseReset: today });
            }
        }

        async function updateLeaderboards() {
            try {
                const { collection, query, orderBy, limit, getDocs } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // Get top 10 users by points
                const leaderboardQuery = query(
                    collection(db, FIRESTORE_COLLECTIONS.USERS),
                    orderBy('eduPoints', 'desc'),
                    limit(10)
                );
                
                const querySnapshot = await getDocs(leaderboardQuery);
                state.leaderboard = [];
                querySnapshot.forEach((doc) => {
                    state.leaderboard.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error("Error updating leaderboard:", error);
            }
        }

        async function checkAchievements() {
            if (!state.user) return;
            
            const userAchievements = state.user.achievements || [];
            const unlockedAchievements = [];
            
            for (const achievement of state.achievements) {
                // Skip if already unlocked
                if (userAchievements.includes(achievement.id)) continue;
                
                let conditionMet = false;
                
                switch (achievement.condition.type) {
                    case 'lessonsCompleted':
                        conditionMet = Object.keys(state.user.completedCourses || {}).length >= achievement.condition.threshold;
                        break;
                    case 'quizzesCompleted':
                        conditionMet = Object.keys(state.user.completedQuizzes || {}).length >= achievement.condition.threshold;
                        break;
                    case 'streak':
                        conditionMet = (state.user.streak || 0) >= achievement.condition.threshold;
                        break;
                }
                
                if (conditionMet) {
                    unlockedAchievements.push(achievement);
                    userAchievements.push(achievement.id);
                    
                    // Add achievement points
                    await addPoints(`Achievement: ${achievement.name}`, achievement.points, false);
                }
            }
            
            if (unlockedAchievements.length > 0) {
                // Update user achievements in Firestore
                await saveUser({ achievements: userAchievements });
                
                // Show achievement notification
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-trophy text-5xl text-yellow-500"></i>
                        <h3 class="text-xl font-bold text-yellow-600">Achievement Unlocked!</h3>
                        <div class="space-y-2">
                            ${unlockedAchievements.map(achievement => `
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <p class="font-semibold">${achievement.name}</p>
                                    <p class="text-sm text-yellow-700">${achievement.description}</p>
                                    <p class="text-sm text-green-600">+${formatPoints(achievement.points)} points!</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `, () => {
                    setTimeout(hideModal, 3000);
                });
            }
        }

        // =====================================================
        // RENDER FUNCTIONS - COMPLETE IMPLEMENTATION
        // =====================================================

        function render() {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;
            
            appContainer.innerHTML = '';
            showLoading(state.isLoading);

            // Show/hide mobile navigation based on auth state
            const mobileNav = document.getElementById('mobile-nav');
            if (state.user) {
                mobileNav.classList.remove('hidden');
            } else {
                mobileNav.classList.add('hidden');
            }

            if (!state.user) {
                appContainer.innerHTML = renderAuthScreen();
                attachAuthListeners();
            } else if (state.currentView === 'loading') {
                appContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full p-8"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p class="mt-4 text-gray-500">Loading Dashboard...</p></div>';
            } else {
                appContainer.innerHTML = renderHeader() + renderContent();
                updateMobileNav();
                setupEventListeners();
            }
            
            updateBrowserTitle();
        }

        function renderAuthScreen() {
            const hasReferral = state.referralCode !== '';
            
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="w-full max-w-md card p-8 space-y-6 shadow-xl">
                        <div class="text-center">
                            <h1 class="text-4xl font-extrabold text-blue-600 mb-2">EduHeTech</h1>
                            <p class="text-gray-600">Learn valuable skills and earn rewards!</p>
                            ${hasReferral ? `
                                <div class="mt-2 bg-green-50 border border-green-200 rounded-lg p-3">
                                    <p class="text-green-700 text-sm">
                                        <i class="fas fa-gift mr-1"></i>
                                        You've been referred! Get bonus points when you sign up.
                                    </p>
                                </div>
                            ` : ''}
                        </div>

                        <div id="auth-form-container" class="space-y-4">
                            <!-- Auth Form will be rendered here -->
                        </div>

                        <div class="text-center">
                            <button id="toggle-auth" class="text-sm text-blue-500 hover:text-blue-700 font-medium transition-colors">Need an account? Sign Up</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoginForm() {
            return `
                <h2 class="text-2xl font-bold text-center text-gray-800">Welcome Back</h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <button id="login-btn" class="w-full p-3 btn-primary font-semibold rounded-lg shadow-md hover:shadow-lg transition">Log In</button>
                </div>
                <div id="auth-error-message" class="text-red-500 text-sm text-center mt-2"></div>
            `;
        }

        function renderSignupForm() {
            return `
                <h2 class="text-2xl font-bold text-center text-gray-800">Join EduHeTech</h2>
                <div class="space-y-4">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="signup-name" placeholder="Enter your full name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="signup-password" placeholder="Create a password (min 6 chars)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    ${state.referralCode ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-blue-700 text-sm">
                                <i class="fas fa-gift mr-1"></i>
                                Referral code detected! You'll get bonus points when you sign up.
                            </p>
                            <input type="hidden" id="signup-referral" value="${state.referralCode}">
                        </div>
                    ` : `
                        <div>
                            <label for="signup-referral" class="block text-sm font-medium text-gray-700 mb-1">Referral Code (Optional)</label>
                            <input type="text" id="signup-referral" placeholder="Enter referral code if you have one" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    `}
                    <button id="signup-btn" class="w-full p-3 btn-primary font-semibold rounded-lg shadow-md hover:shadow-lg transition">Create Account</button>
                </div>
                <div id="auth-error-message" class="text-red-500 text-sm text-center mt-2"></div>
            `;
        }

        function attachAuthListeners() {
            const container = document.getElementById('auth-form-container');
            const toggleBtn = document.getElementById('toggle-auth');
            let isLogin = true;

            const updateForm = () => {
                container.innerHTML = isLogin ? renderLoginForm() : renderSignupForm();
                toggleBtn.textContent = isLogin ? 'Need an account? Sign Up' : 'Already have an account? Log In';
                attachFormListeners();
            };

            const attachFormListeners = () => {
                // Login form
                document.getElementById('login-btn')?.addEventListener('click', () => {
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    handleFirebaseLogin(email, password);
                });
                
                // Signup form
                document.getElementById('signup-btn')?.addEventListener('click', () => {
                    const name = document.getElementById('signup-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const referrerCode = document.getElementById('signup-referral')?.value || state.referralCode;
                    handleFirebaseSignup(name, email, password, referrerCode);
                });
                
                // Enter key support
                const attachEnterKey = (inputId, buttonId) => {
                    document.getElementById(inputId)?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') document.getElementById(buttonId)?.click();
                    });
                };
                
                attachEnterKey('login-email', 'login-btn');
                attachEnterKey('login-password', 'login-btn');
                attachEnterKey('signup-name', 'signup-btn');
                attachEnterKey('signup-email', 'signup-btn');
                attachEnterKey('signup-password', 'signup-btn');
            };

            toggleBtn?.addEventListener('click', () => {
                isLogin = !isLogin;
                updateForm();
            });

            updateForm();
        }

        function handleAuthError(message) {
            const errorEl = document.getElementById('auth-error-message');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('slide-in');
                setTimeout(() => errorEl.classList.remove('slide-in'), 500);
            }
        }

        function renderHeader() {
            if (!state.user) return '';
            
            return `
                <header class="bg-white shadow-sm border-b">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <h1 class="text-xl font-bold text-blue-600">EduHeTech</h1>
                                ${state.isAdmin ? '<span class="ml-2 admin-badge px-2 py-1 rounded text-xs font-bold">ADMIN</span>' : ''}
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2 bg-blue-50 px-3 py-1 rounded-full">
                                    <i class="fas fa-coins text-yellow-500"></i>
                                    <span class="font-semibold">${formatPoints(state.user.eduPoints || 0)}</span>
                                </div>
                                <button onclick="handleFirebaseLogout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition">
                                    Logout
                                </button>
                                <button class="md:hidden text-gray-600" onclick="toggleMobileMenu()">
                                    <i class="fas fa-bars text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderContent() {
            const views = {
                dashboard: renderDashboard(),
                learn: renderLearn(),
                quiz: renderQuiz(),
                ads: renderAds(),
                referral: renderReferral(),
                rewards: renderRewards(),
                leaderboard: renderLeaderboard(),
                achievements: renderAchievements()
            };
            
            return `
                <div class="main-content min-h-screen bg-gray-50 pb-20">
                    <div class="max-w-7xl mx-auto px-4 py-6">
                        ${views[state.currentView] || '<div>View not found</div>'}
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const completedCourses = Object.keys(state.user.completedCourses || {}).length;
            const completedQuizzes = Object.keys(state.user.completedQuizzes || {}).length;
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
                        <div class="flex items-center space-x-4">
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-fire text-orange-500 streak-flame"></i>
                                    <span>Streak: ${state.user.streak || 0} days</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Welcome Card -->
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-6 text-white">
                        <h2 class="text-2xl font-bold mb-2">Welcome back, ${state.user.name}!</h2>
                        <p class="opacity-90">Continue your learning journey and earn rewards</p>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="stats-grid grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="card p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Points</p>
                                    <p class="text-xl font-bold">${formatPoints(state.user.eduPoints || 0)}</p>
                                </div>
                                <i class="fas fa-coins text-yellow-500 text-xl"></i>
                            </div>
                        </div>
                        
                        <div class="card p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Courses Completed</p>
                                    <p class="text-xl font-bold">${completedCourses}</p>
                                </div>
                                <i class="fas fa-book text-green-500 text-xl"></i>
                            </div>
                        </div>
                        
                        <div class="card p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Referrals</p>
                                    <p class="text-xl font-bold">${state.user.referralCount || 0}</p>
                                </div>
                                <i class="fas fa-users text-blue-500 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                        <div class="quick-actions grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onclick="switchView('learn')" class="bg-blue-50 hover:bg-blue-100 p-4 rounded-lg text-center transition flex flex-col items-center">
                                <i class="fas fa-book text-blue-500 text-xl mb-2"></i>
                                <p class="font-medium text-sm">Learn & Earn</p>
                            </button>
                            
                            <button onclick="switchView('quiz')" class="bg-green-50 hover:bg-green-100 p-4 rounded-lg text-center transition flex flex-col items-center">
                                <i class="fas fa-brain text-green-500 text-xl mb-2"></i>
                                <p class="font-medium text-sm">Take Quiz</p>
                            </button>
                            
                            <button onclick="switchView('ads')" class="bg-purple-50 hover:bg-purple-100 p-4 rounded-lg text-center transition flex flex-col items-center">
                                <i class="fas fa-ad text-purple-500 text-xl mb-2"></i>
                                <p class="font-medium text-sm">Watch Ads</p>
                            </button>
                            
                            <button onclick="switchView('rewards')" class="bg-orange-50 hover:bg-orange-100 p-4 rounded-lg text-center transition flex flex-col items-center">
                                <i class="fas fa-wallet text-orange-500 text-xl mb-2"></i>
                                <p class="font-medium text-sm">Wallet</p>
                            </button>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                        <div class="space-y-3">
                            ${state.user.history && state.user.history.length > 0 
                                ? state.user.history
                                    .slice(0, 5)
                                    .map(entry => `
                                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                            <div class="flex items-center space-x-3">
                                                <i class="fas fa-${entry.points > 0 ? 'plus text-green-500' : 'minus text-red-500'}"></i>
                                                <span class="text-sm">${entry.action}</span>
                                            </div>
                                            <span class="font-semibold text-sm ${entry.points > 0 ? 'text-green-600' : 'text-red-600'}">
                                                ${entry.points > 0 ? '+' : ''}${entry.points}
                                            </span>
                                        </div>
                                    `).join('')
                                : '<p class="text-gray-500 text-center py-4">No recent activity</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLearn() {
            const categories = [...new Set(state.lessons.map(lesson => lesson.category))];
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">Learn & Earn</h1>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-book text-blue-500"></i>
                            <span class="text-sm text-gray-600">Earn ${BASE_POINTS_REWARDS.lesson} points per course</span>
                        </div>
                    </div>

                    <!-- Course Categories -->
                    <div class="space-y-6">
                        ${categories.map(category => {
                            const categoryCourses = state.lessons.filter(lesson => lesson.category === category);
                            return `
                                <div class="card p-6">
                                    <h2 class="text-xl font-bold mb-4">${category}</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${categoryCourses.map(course => {
                                            const isCompleted = state.user.completedCourses && state.user.completedCourses[course.id];
                                            
                                            return `
                                                <div class="border border-gray-200 rounded-lg p-4 ${isCompleted ? 'bg-green-50 border-green-200' : ''}">
                                                    <div class="flex justify-between items-start mb-3">
                                                        <h3 class="font-semibold">${course.title}</h3>
                                                        ${isCompleted ? 
                                                            '<span class="bg-green-500 text-white px-2 py-1 rounded text-xs">Completed</span>' : 
                                                            `<span class="bg-blue-500 text-white px-2 py-1 rounded text-xs">${course.points} points</span>`
                                                        }
                                                    </div>
                                                    <p class="text-sm text-gray-600 mb-2">${course.subcategory} • ${course.duration} mins • ${course.difficulty}</p>
                                                    <button 
                                                        onclick="startCourse('${course.id}')" 
                                                        class="w-full ${isCompleted ? 'bg-gray-300 text-gray-500' : 'btn-primary'} p-2 rounded transition text-sm"
                                                        ${isCompleted ? 'disabled' : ''}
                                                    >
                                                        ${isCompleted ? 'Completed' : 'Start Learning'}
                                                    </button>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderQuiz() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">Quizzes</h1>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-brain text-green-500"></i>
                            <span class="text-sm text-gray-600">Earn ${BASE_POINTS_REWARDS.quiz} points per quiz</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${state.quizzes.map(quiz => {
                            const isCompleted = state.user.completedQuizzes && state.user.completedQuizzes[quiz.id];
                            
                            return `
                                <div class="card p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <h3 class="text-lg font-semibold">${quiz.title}</h3>
                                        ${isCompleted ? 
                                            '<span class="bg-green-500 text-white px-2 py-1 rounded text-xs">Completed</span>' : 
                                            `<span class="bg-green-500 text-white px-2 py-1 rounded text-xs">${BASE_POINTS_REWARDS.quiz} points</span>`
                                        }
                                    </div>
                                    <p class="text-gray-600 mb-4">Category: ${quiz.category}</p>
                                    <p class="text-sm text-gray-500 mb-4">${quiz.questions.length} questions</p>
                                    <button 
                                        onclick="startQuiz('${quiz.id}')" 
                                        class="w-full ${isCompleted ? 'bg-gray-300 text-gray-500' : 'bg-green-500 hover:bg-green-600 text-white'} p-3 rounded-lg transition"
                                        ${isCompleted ? 'disabled' : ''}
                                    >
                                        ${isCompleted ? 'Quiz Completed' : 'Start Quiz'}
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderAds() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">Watch Ads & Earn</h1>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-ad text-purple-500"></i>
                            <span class="text-sm text-gray-600">Earn ${BASE_POINTS_REWARDS.ad} points per ad</span>
                        </div>
                    </div>

                    <div class="card p-6 text-center">
                        <i class="fas fa-play-circle text-6xl text-purple-500 mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Watch an Ad to Earn Points</h3>
                        <p class="text-gray-600 mb-6">Click the button below to watch an advertisement and earn ${BASE_POINTS_REWARDS.ad} EduPoints.</p>
                        
                        <button onclick="openMonetagAd()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition transform hover:scale-105">
                            <i class="fas fa-play mr-2"></i>Watch Ad & Earn ${BASE_POINTS_REWARDS.ad} Points
                        </button>
                        
                        <p class="text-sm text-gray-500 mt-4">The ad will open in a new tab. You must watch it for 30 seconds to earn points.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="card p-4">
                            <h3 class="text-lg font-semibold mb-3">How it works</h3>
                            <ul class="space-y-2 text-gray-600 text-sm">
                                <li class="flex items-center">
                                    <i class="fas fa-check text-green-500 mr-2"></i>
                                    Click "Watch Ad" button
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-check text-green-500 mr-2"></i>
                                    Watch the timer count down from 30 seconds
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-check text-green-500 mr-2"></i>
                                    Don't close the window during the countdown
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-check text-green-500 mr-2"></i>
                                    Click "Complete & Earn Points" when timer ends
                                </li>
                            </ul>
                        </div>

                        <div class="card p-4">
                            <h3 class="text-lg font-semibold mb-3">Important Notes</h3>
                            <ul class="space-y-2 text-gray-600 text-sm">
                                <li class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                                    Points are only awarded after 30 seconds
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                                    Closing the window cancels the reward
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                                    You must click the complete button
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReferral() {
            const referralLink = `${window.location.origin}?ref=${state.user.referralCode}`;
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">Refer & Earn</h1>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-users text-orange-500"></i>
                            <span class="text-sm text-gray-600">Earn ${BASE_POINTS_REWARDS.referral} points per referral</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Referral Stats -->
                        <div class="card p-4">
                            <h3 class="text-lg font-semibold mb-4">Your Referral Stats</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Total Referrals</span>
                                    <span class="text-xl font-bold">${state.user.referralCount || 0}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Points Earned</span>
                                    <span class="text-xl font-bold text-green-600">${formatPoints((state.user.referralCount || 0) * BASE_POINTS_REWARDS.referral)}</span>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <p class="text-sm text-blue-700">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Referral bonuses don't count towards daily limits!
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Referral Link -->
                        <div class="card p-4">
                            <h3 class="text-lg font-semibold mb-4">Your Referral Link</h3>
                            <div class="space-y-4">
                                <div class="flex space-x-2">
                                    <input 
                                        type="text" 
                                        value="${referralLink}" 
                                        id="referral-link"
                                        class="flex-1 p-2 border border-gray-300 rounded-lg bg-gray-50 text-sm" 
                                        readonly
                                    >
                                    <button 
                                        onclick="copyReferralLink()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 rounded-lg transition text-sm"
                                    >
                                        Copy
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600">
                                    Share this link with friends. When they sign up using your link, you'll get ${BASE_POINTS_REWARDS.referral} points and they'll get 500 points!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Share Options -->
                    <div class="card p-4">
                        <h3 class="text-lg font-semibold mb-4">Share Your Link</h3>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="shareOnWhatsApp()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition flex items-center text-sm">
                                <i class="fab fa-whatsapp mr-2"></i> WhatsApp
                            </button>
                            <button onclick="shareOnFacebook()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition flex items-center text-sm">
                                <i class="fab fa-facebook mr-2"></i> Facebook
                            </button>
                            <button onclick="shareOnTwitter()" class="bg-blue-400 hover:bg-blue-500 text-white px-3 py-2 rounded-lg transition flex items-center text-sm">
                                <i class="fab fa-twitter mr-2"></i> Twitter
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRewards() {
            const canWithdraw = state.user.eduPoints >= MIN_WITHDRAWAL_POINTS;
            const cashValue = (state.user.eduPoints / ADMIN_CONFIG.POINTS_TO_CURRENCY_RATE).toFixed(2);
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">Wallet & Withdrawals</h1>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-wallet text-red-500"></i>
                            <span class="text-sm text-gray-600">Convert points to cash</span>
                        </div>
                    </div>

                    <!-- Points Balance -->
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Your Balance</h3>
                            <div class="text-right">
                                <p class="text-2xl font-bold">${formatPoints(state.user.eduPoints || 0)}</p>
                                <p class="text-sm text-gray-600">≈ $${cashValue}</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-circle text-yellow-500 mt-1 mr-2"></i>
                                <div>
                                    <p class="font-semibold text-yellow-800">Minimum Withdrawal: ${formatPoints(MIN_WITHDRAWAL_POINTS)} points</p>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        You need at least ${formatPoints(MIN_WITHDRAWAL_POINTS)} points to make a withdrawal request.
                                        ${!canWithdraw ? ` You need ${formatPoints(MIN_WITHDRAWAL_POINTS - state.user.eduPoints)} more points.` : ''}
                                    </p>
                                </div>
                            </div>
                        </div>

                        ${canWithdraw ? `
                            <!-- Withdrawal Form -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Withdrawal Amount</label>
                                    <input 
                                        type="number" 
                                        id="withdrawal-amount" 
                                        min="${MIN_WITHDRAWAL_POINTS}" 
                                        max="${state.user.eduPoints}"
                                        value="${state.user.eduPoints}"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                    >
                                    <p class="text-sm text-gray-500 mt-1">
                                        Available: ${formatPoints(state.user.eduPoints)} points ($${cashValue})
                                    </p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Withdrawal Method</label>
                                    <select id="withdrawal-method" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        <option value="bank">Bank Transfer</option>
                                        <option value="paypal">PayPal</option>
                                        <option value="mobile_money">Mobile Money</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Account Details</label>
                                    <textarea 
                                        id="withdrawal-details" 
                                        placeholder="Enter your account details (account number, email, wallet address, etc.)"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                        rows="3"
                                    ></textarea>
                                </div>

                                <button 
                                    onclick="submitWithdrawal()" 
                                    class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition"
                                >
                                    Request Withdrawal
                                </button>
                            </div>
                        ` : `
                            <div class="text-center py-6">
                                <i class="fas fa-lock text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600">You need ${formatPoints(MIN_WITHDRAWAL_POINTS)} points to make a withdrawal</p>
                                <button onclick="switchView('learn')" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition">
                                    Earn More Points
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderLeaderboard() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">Leaderboard</h1>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-trophy text-yellow-500"></i>
                            <span class="text-sm text-gray-600">Top performers this week</span>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="space-y-4">
                            ${state.leaderboard && state.leaderboard.map((user, index) => {
                                const rank = index + 1;
                                const isCurrentUser = user.uid === state.firebaseUser?.uid;
                                
                                return `
                                    <div class="flex items-center justify-between p-3 ${isCurrentUser ? 'bg-blue-50 border border-blue-200 rounded-lg' : ''}">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-8 h-8 flex items-center justify-center rounded-full ${
                                                rank === 1 ? 'bg-yellow-500 text-white' :
                                                rank === 2 ? 'bg-gray-400 text-white' :
                                                rank === 3 ? 'bg-orange-500 text-white' :
                                                'bg-gray-200 text-gray-600'
                                            } font-bold text-sm">
                                                ${rank}
                                            </div>
                                            <div>
                                                <p class="font-medium ${isCurrentUser ? 'text-blue-600' : 'text-gray-800'}">
                                                    ${user.name} ${isCurrentUser ? '(You)' : ''}
                                                </p>
                                                <p class="text-sm text-gray-600">${user.referralCount || 0} referrals</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-yellow-600">${formatPoints(user.eduPoints || 0)}</p>
                                            <p class="text-sm text-gray-600">points</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAchievements() {
            const userAchievements = state.user.achievements || [];
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">Achievements</h1>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-medal text-purple-500"></i>
                            <span class="text-sm text-gray-600">Complete challenges to earn rewards</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${state.achievements.map(achievement => {
                            const isUnlocked = userAchievements.includes(achievement.id);
                            
                            return `
                                <div class="card p-4 text-center ${isUnlocked ? 'border-2 border-yellow-400' : 'opacity-70'}">
                                    <div class="achievement-badge mb-3">
                                        <i class="${achievement.icon} text-3xl ${
                                            isUnlocked ? 
                                            (achievement.type === 'bronze' ? 'text-yellow-600' :
                                             achievement.type === 'silver' ? 'text-gray-400' :
                                             achievement.type === 'gold' ? 'text-yellow-400' : 'text-purple-500') : 
                                            'text-gray-300'
                                        }"></i>
                                    </div>
                                    <h3 class="font-semibold mb-1 text-sm">${achievement.name}</h3>
                                    <p class="text-xs text-gray-600 mb-2">${achievement.description}</p>
                                    <div class="flex justify-center items-center space-x-1">
                                        <i class="fas fa-coins text-yellow-500 text-xs"></i>
                                        <span class="font-bold text-yellow-600 text-sm">${formatPoints(achievement.points)}</span>
                                    </div>
                                    ${isUnlocked ? 
                                        '<div class="mt-2 bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-medium">Unlocked</div>' :
                                        '<div class="mt-2 bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-medium">Locked</div>'
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // =====================================================
        // EVENT HANDLERS
        // =====================================================

        function startCourse(courseId) {
            const course = state.lessons.find(c => c.id === courseId);
            if (!course) return;

            showModal(`
                <div class="text-center space-y-4">
                    <i class="fas fa-book text-5xl text-blue-500 mb-2"></i>
                    <h3 class="text-xl font-bold">${course.title}</h3>
                    <p class="text-gray-600">Complete this course to earn ${BASE_POINTS_REWARDS.lesson} points!</p>
                    <div class="bg-blue-50 p-4 rounded-lg text-left">
                        <p class="text-sm font-semibold">Course Details:</p>
                        <p class="text-sm">Duration: ${course.duration} minutes</p>
                        <p class="text-sm">Difficulty: ${course.difficulty}</p>
                        <p class="text-sm">Category: ${course.category}</p>
                    </div>
                    <button onclick="completeCourse('${courseId}')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition">
                        Start Course
                    </button>
                </div>
            `);
        }

        async function completeCourse(courseId) {
            if (!state.user) return;
            
            // Mark course as completed
            const completedCourses = { ...state.user.completedCourses };
            completedCourses[courseId] = {
                completedAt: Date.now(),
                pointsEarned: BASE_POINTS_REWARDS.lesson
            };
            
            // Mark as completed today
            const completedCoursesToday = { ...state.user.completedCoursesToday };
            completedCoursesToday[courseId] = true;
            
            await saveUser({ 
                completedCourses,
                completedCoursesToday
            });
            
            // Add points
            await addPoints(`Completed Course: ${state.lessons.find(c => c.id === courseId)?.title}`, BASE_POINTS_REWARDS.lesson, true);
            
            hideModal();
            
            showModal(`
                <div class="text-center space-y-3">
                    <i class="fas fa-check-circle text-5xl text-green-500"></i>
                    <h3 class="text-xl font-bold text-green-600">Course Completed!</h3>
                    <p class="text-gray-600">You earned ${BASE_POINTS_REWARDS.lesson} EduPoints for completing the course.</p>
                </div>
            `, () => {
                setTimeout(hideModal, 2000);
                switchView('learn');
            });
        }

        function startQuiz(quizId) {
            const quiz = state.quizzes.find(q => q.id === quizId);
            if (!quiz) return;

            showModal(`
                <div class="text-center space-y-4">
                    <i class="fas fa-brain text-5xl text-green-500 mb-2"></i>
                    <h3 class="text-xl font-bold">${quiz.title}</h3>
                    <p class="text-gray-600">Answer correctly to earn ${BASE_POINTS_REWARDS.quiz} points!</p>
                    <p class="text-sm text-gray-500">This quiz has ${quiz.questions.length} questions.</p>
                    <button onclick="completeQuiz('${quizId}')" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition">
                        Start Quiz
                    </button>
                </div>
            `);
        }

        async function completeQuiz(quizId) {
            if (!state.user) return;
            
            // Mark quiz as completed
            const completedQuizzes = { ...state.user.completedQuizzes };
            completedQuizzes[quizId] = {
                completedAt: Date.now(),
                pointsEarned: BASE_POINTS_REWARDS.quiz
            };
            
            await saveUser({ completedQuizzes });
            
            // Add points
            await addPoints('Completed Quiz', BASE_POINTS_REWARDS.quiz, true);
            
            hideModal();
            
            showModal(`
                <div class="text-center space-y-3">
                    <i class="fas fa-check-circle text-5xl text-green-500"></i>
                    <h3 class="text-xl font-bold text-green-600">Quiz Completed!</h3>
                    <p class="text-gray-600">You earned ${BASE_POINTS_REWARDS.quiz} EduPoints for completing the quiz.</p>
                </div>
            `, () => {
                setTimeout(hideModal, 2000);
                switchView('quiz');
            });
        }

        function copyReferralLink() {
            const referralLink = document.getElementById('referral-link');
            referralLink.select();
            document.execCommand('copy');
            
            showModal(`
                <div class="text-center space-y-3">
                    <i class="fas fa-check-circle text-5xl text-green-500"></i>
                    <h3 class="text-xl font-bold text-green-600">Link Copied!</h3>
                    <p class="text-gray-600">Referral link copied to clipboard</p>
                </div>
            `, () => {
                setTimeout(hideModal, 2000);
            });
        }

        function shareOnWhatsApp() {
            const referralLink = `${window.location.origin}?ref=${state.user.referralCode}`;
            const message = `Join EduHeTech and start earning money while learning! Use my referral link: ${referralLink}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        function shareOnFacebook() {
            const referralLink = `${window.location.origin}?ref=${state.user.referralCode}`;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(referralLink)}`, '_blank');
        }

        function shareOnTwitter() {
            const referralLink = `${window.location.origin}?ref=${state.user.referralCode}`;
            const message = `Join EduHeTech and start earning money while learning!`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(referralLink)}`, '_blank');
        }

        async function submitWithdrawal() {
            if (!state.user) return;
            
            const amount = parseInt(document.getElementById('withdrawal-amount').value);
            const method = document.getElementById('withdrawal-method').value;
            const details = document.getElementById('withdrawal-details').value;

            if (!amount || amount < MIN_WITHDRAWAL_POINTS) {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Invalid Amount</h3>
                        <p class="text-gray-600">Minimum withdrawal amount is ${formatPoints(MIN_WITHDRAWAL_POINTS)} points.</p>
                    </div>
                `);
                return;
            }

            if (amount > state.user.eduPoints) {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Insufficient Points</h3>
                        <p class="text-gray-600">You only have ${formatPoints(state.user.eduPoints)} points available.</p>
                    </div>
                `);
                return;
            }

            if (!details.trim()) {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Details Required</h3>
                        <p class="text-gray-600">Please provide your account details for the withdrawal.</p>
                    </div>
                `);
                return;
            }

            // Create withdrawal request
            const withdrawalRequest = {
                userId: state.firebaseUser.uid,
                userName: state.user.name,
                userEmail: state.user.email,
                type: method,
                amount: amount,
                details: details,
                status: 'pending',
                timestamp: Date.now()
            };

            // Save to Firestore
            await saveToCollection(FIRESTORE_COLLECTIONS.WITHDRAWALS, withdrawalRequest);

            showModal(`
                <div class="text-center space-y-3">
                    <i class="fas fa-check-circle text-5xl text-green-500"></i>
                    <h3 class="text-xl font-bold text-green-600">Withdrawal Request Submitted!</h3>
                    <p class="text-gray-600">Your request for ${formatPoints(amount)} points has been submitted.</p>
                    <p class="text-sm text-gray-500">We will process your request within 24-48 hours.</p>
                </div>
            `, () => {
                switchView('dashboard');
            });
        }

        function setupEventListeners() {
            // Mobile navigation
            const navItems = document.querySelectorAll('.mobile-nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = item.getAttribute('data-view');
                    switchView(view);
                });
            });
        }

        function toggleMobileMenu() {
            // This would toggle a mobile menu in a real implementation
            console.log('Toggle mobile menu');
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================

        // Start with splash screen
        window.onload = showSplashScreen;

        // Make functions globally available
        window.switchView = switchView;
        window.startCourse = startCourse;
        window.completeCourse = completeCourse;
        window.startQuiz = startQuiz;
        window.completeQuiz = completeQuiz;
        window.copyReferralLink = copyReferralLink;
        window.shareOnWhatsApp = shareOnWhatsApp;
        window.shareOnFacebook = shareOnFacebook;
        window.shareOnTwitter = shareOnTwitter;
        window.submitWithdrawal = submitWithdrawal;
        window.openMonetagAd = openMonetagAd;
        window.handleFirebaseLogout = handleFirebaseLogout;
        window.hideModal = hideModal;
        window.toggleMobileMenu = toggleMobileMenu;
    </script>
</body>
</html>
