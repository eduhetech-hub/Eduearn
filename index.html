<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduHeTech - Learn & Earn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #3b82f6; /* Blue 500 */
            --secondary-color: #1d4ed8; /* Blue 700 */
            --success-color: #10b981; /* Green 500 */
            --warning-color: #f59e0b; /* Amber 500 */
            --danger-color: #ef4444; /* Red 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            min-height: 100vh;
        }
        .scrollable-content {
            max-height: calc(100vh - 80px); /* Adjust based on header height */
            overflow-y: auto;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-radius: 0.5rem;
            color: white;
            transition: transform 0.1s ease;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Custom modal overlay styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 50;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* New styles for enhanced UI */
        .progress-ring {
            transform: rotate(-90deg);
        }
        .streak-flame {
            animation: pulse 1.5s infinite alternate;
        }
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .achievement-badge {
            transition: transform 0.3s ease;
        }
        .achievement-badge:hover {
            transform: scale(1.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .course-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .course-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .course-section:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Global State and Data Management Scripts (LocalStorage) -->
    <script>
        // --- Local Storage Keys ---
        const LS_USERS = 'eduhetech_users_v4'; // Updated version for new features
        const LS_WITHDRAWALS = 'eduhetech_withdrawals_v4';
        const LS_LESSONS = 'eduhetech_lessons_v4';
        const LS_QUIZZES = 'eduhetech_quizzes_v4';
        const LS_ACHIEVEMENTS = 'eduhetech_achievements_v4';
        const SS_CURRENT_USER_ID = 'eduhetech_current_user_id';

        // --- Constants ---
        const MONETAG_LINKS = [
            'https://otieu.com/4/10070319', 'https://otieu.com/4/10070318', 'https://otieu.com/4/10070317',
            'https://otieu.com/4/10070316', 'https://otieu.com/4/10070315', 'https://otieu.com/4/10070314',
            'https://otieu.com/4/7667810', 'https://otieu.com/4/7667754', 'https://otieu.com/4/7667716',
            'https://otieu.com/4/7667811'
        ];
        const BASE_POINTS_REWARDS = {
            lesson: 500, // Updated from 1000 to 500
            quiz: 50, // Updated from 2000 to 50
            ad: 500,
            dailyLogin: 100,
            referral: 1000, // Updated from 5000 to 1000
            streak: 500,
            achievement: 5000
        };
        const MIN_WITHDRAWAL_POINTS = 100000; // $1
        const DAILY_POINTS_LIMIT = 10000; // Daily earning limit

        // --- Global State Management ---
        window.state = {
            user: null,
            currentView: 'loading',
            isLoading: false,
            quizData: null,
            allUsers: {},
            withdrawalRequests: [],
            lessons: [],
            quizzes: [],
            achievements: [],
            notifications: [],
            currentCourse: null
        };

        let userId = sessionStorage.getItem(SS_CURRENT_USER_ID);

        // --- Data Persistence Layer (LocalStorage) ---

        function loadAllUsers() {
            try {
                const usersJson = localStorage.getItem(LS_USERS);
                return usersJson ? JSON.parse(usersJson) : {};
            } catch (e) {
                console.error("Error loading users from LS:", e);
                return {};
            }
        }

        function saveAllUsers(users) {
            try {
                localStorage.setItem(LS_USERS, JSON.stringify(users));
                state.allUsers = users;
            } catch (e) {
                console.error("Error saving users to LS:", e);
            }
        }

        function loadCollection(key) {
            try {
                const dataJson = localStorage.getItem(key);
                return dataJson ? JSON.parse(dataJson) : [];
            } catch (e) {
                console.error(`Error loading collection ${key} from LS:`, e);
                return [];
            }
        }

        function saveCollection(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving collection ${key} to LS:`, e);
            }
        }

        function initMockData() {
            // Check and initialize Lessons
            if (loadCollection(LS_LESSONS).length === 0) {
                saveCollection(LS_LESSONS, getAllCourses());
            }

            // Check and initialize Quizzes
            if (loadCollection(LS_QUIZZES).length === 0) {
                saveCollection(LS_QUIZZES, getAllQuizzes());
            }

            // Check and initialize Achievements
            if (loadCollection(LS_ACHIEVEMENTS).length === 0) {
                const mockAchievements = [
                    { id: 'a1', name: 'First Steps', description: 'Complete your first lesson', icon: 'fas fa-footsteps', points: 5000, type: 'bronze', condition: { type: 'lessonsCompleted', threshold: 1 } },
                    { id: 'a2', name: 'Quiz Whiz', description: 'Complete 5 quizzes', icon: 'fas fa-brain', points: 10000, type: 'silver', condition: { type: 'quizzesCompleted', threshold: 5 } },
                    { id: 'a3', name: 'Learning Streak', description: 'Maintain a 7-day learning streak', icon: 'fas fa-fire', points: 15000, type: 'gold', condition: { type: 'streak', threshold: 7 } },
                    { id: 'a4', name: 'Point Collector', description: 'Earn 50,000 points', icon: 'fas fa-coins', points: 20000, type: 'gold', condition: { type: 'points', threshold: 50000 } },
                    { id: 'a5', name: 'Referral Master', description: 'Refer 5 friends', icon: 'fas fa-users', points: 25000, type: 'platinum', condition: { type: 'referrals', threshold: 5 } },
                    { id: 'a6', name: 'Health Expert', description: 'Complete 5 health courses', icon: 'fas fa-heartbeat', points: 15000, type: 'silver', condition: { type: 'categoryCompleted', threshold: 5, category: 'Health & Medicine' } },
                    { id: 'a7', name: 'Tech Guru', description: 'Complete 5 technology courses', icon: 'fas fa-laptop-code', points: 15000, type: 'silver', condition: { type: 'categoryCompleted', threshold: 5, category: 'Technology' } },
                    { id: 'a8', name: 'Business Pro', description: 'Complete 5 business courses', icon: 'fas fa-briefcase', points: 15000, type: 'silver', condition: { type: 'categoryCompleted', threshold: 5, category: 'Business & Entrepreneurship' } }
                ];
                saveCollection(LS_ACHIEVEMENTS, mockAchievements);
            }
        }

        // --- Extensive Course Database ---
        function getAllCourses() {
            return [
                // Health & Medicine Category
                {
                    id: 'health-1',
                    title: 'Introduction to Complementary and Alternative Medicine',
                    category: 'Health & Medicine',
                    subcategory: 'Alternative Medicine',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">What is Complementary and Alternative Medicine?</h3>
                                <p class="mb-3">Complementary and Alternative Medicine (CAM) refers to medical products and practices that are not part of standard medical care. Standard medical care is medicine that is practiced by health professionals who hold an M.D. (medical doctor) or D.O. (doctor of osteopathy) degree.</p>
                                <p class="mb-3">Complementary medicine is used together with standard medical care. An example is using acupuncture to help with side effects of cancer treatment. Alternative medicine is used in place of standard medical care. An example is following a special diet to treat cancer instead of using proven methods recommended by a medical doctor.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Types of Complementary and Alternative Medicine</h3>
                                <h4 class="font-bold mb-2">1. Natural Products</h4>
                                <p class="mb-3">This includes herbs, vitamins, minerals, and probiotics. They are widely marketed and readily available to consumers.</p>
                                
                                <h4 class="font-bold mb-2">2. Mind and Body Practices</h4>
                                <p class="mb-3">These include techniques such as acupuncture, massage therapy, meditation, movement therapies, relaxation techniques, spinal manipulation, tai chi, and yoga.</p>
                                
                                <h4 class="font-bold mb-2">3. Other Complementary Health Approaches</h4>
                                <p class="mb-3">These include traditional healers, Ayurvedic medicine, traditional Chinese medicine, homeopathy, and naturopathy.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Benefits and Risks</h3>
                                <p class="mb-3">While some CAM therapies have shown promise for specific conditions, many lack rigorous scientific evidence regarding their safety and effectiveness. It's important to:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Discuss CAM use with your healthcare provider</li>
                                    <li class="mb-2">Research the scientific evidence for the therapy</li>
                                    <li class="mb-2">Consider potential risks and benefits</li>
                                    <li class="mb-2">Choose qualified practitioners</li>
                                </ul>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Integration with Conventional Medicine</h3>
                                <p class="mb-3">Integrative medicine combines conventional medical treatments with CAM therapies that have shown scientific evidence of safety and effectiveness. This approach:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Focuses on the whole person</li>
                                    <li class="mb-2">Considers all factors that influence health</li>
                                    <li class="mb-2">Uses appropriate therapies from various disciplines</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    duration: 10,
                    difficulty: 'Beginner',
                    points: 500,
                    order: 1
                },
                {
                    id: 'health-2',
                    title: 'Community Health Principles and Practices',
                    category: 'Health & Medicine',
                    subcategory: 'Public Health',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Introduction to Community Health</h3>
                                <p class="mb-3">Community health is a field of public health that focuses on studying, protecting, or improving health within a community. It involves understanding health issues that affect specific populations and implementing solutions to address them.</p>
                                <p class="mb-3">Community health workers serve as a bridge between health services and the community to facilitate access to services and improve the quality and cultural competence of service delivery.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Key Principles of Community Health</h3>
                                <h4 class="font-bold mb-2">1. Community Participation</h4>
                                <p class="mb-3">Active involvement of community members in identifying health problems and developing solutions.</p>
                                
                                <h4 class="font-bold mb-2">2. Equity and Social Justice</h4>
                                <p class="mb-3">Ensuring fair distribution of health resources and addressing health disparities.</p>
                                
                                <h4 class="font-bold mb-2">3. Intersectoral Collaboration</h4>
                                <p class="mb-3">Working across different sectors (education, housing, transportation) to address health determinants.</p>
                                
                                <h4 class="font-bold mb-2">4. Sustainability</h4>
                                <p class="mb-3">Developing programs that can be maintained over time with available resources.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Community Health Assessment</h3>
                                <p class="mb-3">A systematic process to identify and analyze community health needs and assets. This involves:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Collecting and analyzing demographic data</li>
                                    <li class="mb-2">Identifying health indicators and trends</li>
                                    <li class="mb-2">Engaging community stakeholders</li>
                                    <li class="mb-2">Prioritizing health issues</li>
                                </ul>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Common Community Health Interventions</h3>
                                <p class="mb-3">Effective community health programs often include:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Health education and promotion</li>
                                    <li class="mb-2">Disease prevention and screening</li>
                                    <li class="mb-2">Environmental health initiatives</li>
                                    <li class="mb-2">Policy advocacy</li>
                                    <li class="mb-2">Community mobilization</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    duration: 12,
                    difficulty: 'Intermediate',
                    points: 500,
                    order: 2
                },
                {
                    id: 'health-3',
                    title: 'Dental Therapy and Oral Health Management',
                    category: 'Health & Medicine',
                    subcategory: 'Dental Health',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Fundamentals of Dental Therapy</h3>
                                <p class="mb-3">Dental therapy focuses on preventive oral healthcare and basic dental treatments. Dental therapists are mid-level providers who work alongside dentists to expand access to dental care, particularly in underserved communities.</p>
                                <p class="mb-3">The scope of practice for dental therapists varies by region but typically includes preventive services, simple restorations, and uncomplicated extractions.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Core Competencies of Dental Therapists</h3>
                                <h4 class="font-bold mb-2">1. Preventive Care</h4>
                                <p class="mb-3">Providing oral health education, fluoride treatments, sealants, and prophylaxes.</p>
                                
                                <h4 class="font-bold mb-2">2. Restorative Procedures</h4>
                                <p class="mb-3">Placing amalgam and composite restorations in primary and permanent teeth.</p>
                                
                                <h4 class="font-bold mb-2">3. Minor Surgical Procedures</h4>
                                <p class="mb-3">Performing uncomplicated extractions of primary teeth and some permanent teeth.</p>
                                
                                <h4 class="font-bold mb-2">4. Assessment and Diagnosis</h4>
                                <p class="mb-3">Conducting oral health assessments and taking radiographs.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Common Oral Health Conditions</h3>
                                <p class="mb-3">Dental therapists must be knowledgeable about:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Dental caries (cavities) and their prevention</li>
                                    <li class="mb-2">Periodontal (gum) diseases</li>
                                    <li class="mb-2">Oral infections and their management</li>
                                    <li class="mb-2">Developmental dental anomalies</li>
                                    <li class="mb-2">Oral manifestations of systemic diseases</li>
                                </ul>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Patient Education and Communication</h3>
                                <p class="mb-3">Effective communication is essential for:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Explaining treatment options and procedures</li>
                                    <li class="mb-2">Providing oral hygiene instructions</li>
                                    <li class="mb-2">Discussing the importance of nutrition for oral health</li>
                                    <li class="mb-2">Addressing dental anxiety and fear</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    duration: 15,
                    difficulty: 'Intermediate',
                    points: 500,
                    order: 3
                },
                {
                    id: 'health-4',
                    title: 'Environmental Health and Disease Prevention',
                    category: 'Health & Medicine',
                    subcategory: 'Environmental Health',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Understanding Environmental Health</h3>
                                <p class="mb-3">Environmental health focuses on how our environment affects human health. This field addresses all the physical, chemical, and biological factors external to a person, and all the related factors impacting behaviors.</p>
                                <p class="mb-3">It encompasses the assessment and control of those environmental factors that can potentially affect health. It is targeted towards preventing disease and creating health-supportive environments.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Key Areas of Environmental Health</h3>
                                <h4 class="font-bold mb-2">1. Air Quality</h4>
                                <p class="mb-3">Monitoring and controlling indoor and outdoor air pollution to prevent respiratory diseases.</p>
                                
                                <h4 class="font-bold mb-2">2. Water Quality</h4>
                                <p class="mb-3">Ensuring safe drinking water and proper sanitation to prevent waterborne diseases.</p>
                                
                                <h4 class="font-bold mb-2">3. Food Safety</h4>
                                <p class="mb-3">Preventing food contamination and foodborne illnesses through proper handling and storage.</p>
                                
                                <h4 class="font-bold mb-2">4. Waste Management</h4>
                                <p class="mb-3">Proper disposal of solid and hazardous waste to prevent environmental contamination.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Environmental Health Hazards</h3>
                                <p class="mb-3">Common environmental hazards include:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Chemical hazards (pesticides, heavy metals, industrial chemicals)</li>
                                    <li class="mb-2">Biological hazards (bacteria, viruses, mold, allergens)</li>
                                    <li class="mb-2">Physical hazards (radiation, noise, extreme temperatures)</li>
                                    <li class="mb-2">Built environment hazards (poor housing, inadequate sanitation)</li>
                                </ul>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Environmental Health Interventions</h3>
                                <p class="mb-3">Effective strategies for improving environmental health include:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Policy development and regulation</li>
                                    <li class="mb-2">Environmental monitoring and surveillance</li>
                                    <li class="mb-2">Health education and promotion</li>
                                    <li class="mb-2">Community-based participatory research</li>
                                    <li class="mb-2">Advocacy for environmental justice</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    duration: 12,
                    difficulty: 'Intermediate',
                    points: 500,
                    order: 4
                },
                {
                    id: 'health-5',
                    title: 'Nutrition and Diet Therapy Fundamentals',
                    category: 'Health & Medicine',
                    subcategory: 'Nutrition',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Principles of Nutrition</h3>
                                <p class="mb-3">Nutrition is the science that interprets the interaction of nutrients and other substances in food in relation to maintenance, growth, reproduction, health, and disease of an organism.</p>
                                <p class="mb-3">It includes food intake, absorption, assimilation, biosynthesis, catabolism, and excretion. The diet of an organism is what it eats, which is largely determined by the availability and palatability of foods.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Essential Nutrients</h3>
                                <h4 class="font-bold mb-2">1. Macronutrients</h4>
                                <p class="mb-3">Carbohydrates, proteins, and fats that provide energy and building blocks for the body.</p>
                                
                                <h4 class="font-bold mb-2">2. Micronutrients</h4>
                                <p class="mb-3">Vitamins and minerals required in smaller amounts for various physiological functions.</p>
                                
                                <h4 class="font-bold mb-2">3. Water</h4>
                                <p class="mb-3">Essential for all bodily functions and makes up about 60% of body weight.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Dietary Guidelines and Recommendations</h3>
                                <p class="mb-3">Evidence-based guidelines for healthy eating include:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Balancing calorie intake with physical activity</li>
                                    <li class="mb-2">Consuming a variety of nutrient-dense foods</li>
                                    <li class="mb-2">Limiting saturated fats, trans fats, added sugars, and sodium</li>
                                    <li class="mb-2">Choosing a variety of protein foods</li>
                                    <li class="mb-2">Drinking adequate amounts of water</li>
                                </ul>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Medical Nutrition Therapy</h3>
                                <p class="mb-3">Therapeutic nutrition interventions for managing specific health conditions:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Diabetes mellitus (carbohydrate counting, glycemic control)</li>
                                    <li class="mb-2">Cardiovascular diseases (heart-healthy diets, cholesterol management)</li>
                                    <li class="mb-2">Renal diseases (protein, sodium, potassium, and phosphorus restrictions)</li>
                                    <li class="mb-2">Gastrointestinal disorders (fiber modifications, elimination diets)</li>
                                    <li class="mb-2">Cancer (managing side effects of treatment, maintaining nutritional status)</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    duration: 14,
                    difficulty: 'Intermediate',
                    points: 500,
                    order: 5
                },
                // Additional Health courses would continue here...
                
                // Technology Category
                {
                    id: 'tech-1',
                    title: 'Web Development Fundamentals',
                    category: 'Technology',
                    subcategory: 'Web Development',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Introduction to Web Development</h3>
                                <p class="mb-3">Web development refers to the building, creating, and maintaining of websites. It includes aspects such as web design, web publishing, web programming, and database management.</p>
                                <p class="mb-3">While the terms "web developer" and "web designer" are often used synonymously, they do not mean the same thing. Technically, a web designer only designs website interfaces using HTML and CSS. A web developer may be involved in designing a website, but may also write web scripts in languages such as PHP and ASP.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Front-End Development</h3>
                                <p class="mb-3">Front-end development, also known as client-side development, involves creating what users interact with directly in their web browsers. Key technologies include:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2"><strong>HTML (HyperText Markup Language):</strong> The standard markup language for documents designed to be displayed in a web browser.</li>
                                    <li class="mb-2"><strong>CSS (Cascading Style Sheets):</strong> Used to describe the presentation of a document written in HTML.</li>
                                    <li class="mb-2"><strong>JavaScript:</strong> A programming language that enables interactive web pages and is an essential part of web applications.</li>
                                </ul>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Back-End Development</h3>
                                <p class="mb-3">Back-end development, also known as server-side development, involves working with servers, applications, and databases. Key components include:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2"><strong>Server:</strong> The computer where the website's files and database are stored.</li>
                                    <li class="mb-2"><strong>Application:</strong> The piece of code that runs on the server, handles requests, and retrieves information from the database.</li>
                                    <li class="mb-2"><strong>Database:</strong> Where all the data of the website is stored, organized, and managed.</li>
                                </ul>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Full-Stack Development</h3>
                                <p class="mb-3">A full-stack developer is someone who works with both the front-end and back-end of a web application. They have the skills to work on all layers of the technology stack, which typically includes:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Front-end (HTML, CSS, JavaScript)</li>
                                    <li class="mb-2">Back-end (Server, Application, Database)</li>
                                    <li class="mb-2">Version Control Systems (Git)</li>
                                    <li class="mb-2">Web hosting and deployment</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    duration: 15,
                    difficulty: 'Beginner',
                    points: 500,
                    order: 1
                },
                {
                    id: 'tech-2',
                    title: 'Introduction to Artificial Intelligence and Machine Learning',
                    category: 'Technology',
                    subcategory: 'AI & ML',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">What is Artificial Intelligence?</h3>
                                <p class="mb-3">Artificial Intelligence (AI) refers to the simulation of human intelligence in machines that are programmed to think like humans and mimic their actions. The term may also be applied to any machine that exhibits traits associated with a human mind such as learning and problem-solving.</p>
                                <p class="mb-3">The ideal characteristic of artificial intelligence is its ability to rationalize and take actions that have the best chance of achieving a specific goal. A subset of artificial intelligence is machine learning, which we'll explore in detail.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Understanding Machine Learning</h3>
                                <p class="mb-3">Machine learning is a method of data analysis that automates analytical model building. It is a branch of artificial intelligence based on the idea that systems can learn from data, identify patterns and make decisions with minimal human intervention.</p>
                                <p class="mb-3">The process of learning begins with observations or data, such as examples, direct experience, or instruction, in order to look for patterns in data and make better decisions in the future based on the examples that we provide.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Types of Machine Learning</h3>
                                <h4 class="font-bold mb-2">1. Supervised Learning</h4>
                                <p class="mb-3">The algorithm is trained on a labeled dataset, which means that each training example is paired with an output label.</p>
                                
                                <h4 class="font-bold mb-2">2. Unsupervised Learning</h4>
                                <p class="mb-3">The algorithm is given data without explicit instructions on what to do with it, and it must find patterns and relationships in the data.</p>
                                
                                <h4 class="font-bold mb-2">3. Reinforcement Learning</h4>
                                <p class="mb-3">The algorithm learns by interacting with an environment and receiving rewards or penalties for actions.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Applications of AI and ML</h3>
                                <p class="mb-3">AI and ML are transforming various industries:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2"><strong>Healthcare:</strong> Disease diagnosis, drug discovery, personalized treatment</li>
                                    <li class="mb-2"><strong>Finance:</strong> Fraud detection, algorithmic trading, risk assessment</li>
                                    <li class="mb-2"><strong>Retail:</strong> Recommendation systems, inventory management, customer service</li>
                                    <li class="mb-2"><strong>Transportation:</strong> Autonomous vehicles, route optimization, traffic prediction</li>
                                    <li class="mb-2"><strong>Entertainment:</strong> Content recommendation, game AI, special effects</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    duration: 18,
                    difficulty: 'Intermediate',
                    points: 500,
                    order: 2
                },
                // Additional Technology courses would continue here...
                
                // Business & Entrepreneurship Category
                {
                    id: 'business-1',
                    title: 'Digital Marketing Fundamentals',
                    category: 'Business & Entrepreneurship',
                    subcategory: 'Marketing',
                    content: `
                        <div class="course-content">
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Introduction to Digital Marketing</h3>
                                <p class="mb-3">Digital marketing is the component of marketing that uses the Internet and online-based digital technologies such as desktop computers, mobile phones and other digital media and platforms to promote products and services.</p>
                                <p class="mb-3">Its development during the 1990s and 2000s changed the way brands and businesses use technology for marketing. As digital platforms became increasingly incorporated into marketing plans and everyday life, and as people increasingly use digital devices instead of visiting physical shops, digital marketing campaigns have become prevalent.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Key Channels in Digital Marketing</h3>
                                <h4 class="font-bold mb-2">1. Search Engine Optimization (SEO)</h4>
                                <p class="mb-3">The process of improving the quality and quantity of website traffic by increasing the visibility of a website or a web page to users of a web search engine.</p>
                                
                                <h4 class="font-bold mb-2">2. Content Marketing</h4>
                                <p class="mb-3">A strategic marketing approach focused on creating and distributing valuable, relevant, and consistent content to attract and retain a clearly defined audience.</p>
                                
                                <h4 class="font-bold mb-2">3. Social Media Marketing</h4>
                                <p class="mb-3">The use of social media platforms and websites to promote a product or service and to connect with customers.</p>
                                
                                <h4 class="font-bold mb-2">4. Email Marketing</h4>
                                <p class="mb-3">The act of sending a commercial message, typically to a group of people, using email to promote products or services.</p>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Digital Marketing Strategy</h3>
                                <p class="mb-3">An effective digital marketing strategy involves:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Setting clear, measurable goals</li>
                                    <li class="mb-2">Identifying target audiences</li>
                                    <li class="mb-2">Selecting appropriate channels</li>
                                    <li class="mb-2">Creating compelling content</li>
                                    <li class="mb-2">Implementing tracking and analytics</li>
                                    <li class="mb-2">Continuously optimizing based on data</li>
                                </ul>
                            </div>
                            
                            <div class="course-section">
                                <h3 class="text-xl font-bold mb-3">Measuring Digital Marketing Success</h3>
                                <p class="mb-3">Key performance indicators (KPIs) for digital marketing include:</p>
                                <ul class="list-disc pl-5 mb-3">
                                    <li class="mb-2">Website traffic and engagement metrics</li>
                                    <li class="mb-2">Conversion rates</li>
                                    <li class="mb-2">Return on investment (ROI)</li>
                                    <li class="mb-2">Customer acquisition cost (CAC)</li>
                                    <li class="mb-2">Customer lifetime value (CLV)</li>
                                    <li class="mb-2">Social media engagement and reach</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    duration: 12,
                    difficulty: 'Beginner',
                    points: 500,
                    order: 1
                },
                // Additional Business courses would continue here...
                
                // More categories and courses would be added similarly...
            ];
        }

        // --- Extensive Quiz Database ---
        function getAllQuizzes() {
            return [
                {
                    id: 'health-1-quiz',
                    title: 'Complementary and Alternative Medicine Quiz',
                    category: 'Health & Medicine',
                    courseId: 'health-1',
                    questions: [
                        { 
                            q: 'What is the main difference between complementary and alternative medicine?', 
                            options: [
                                'Complementary medicine is used together with standard care, while alternative medicine is used instead of standard care',
                                'Complementary medicine is more scientific than alternative medicine',
                                'Alternative medicine is always safer than complementary medicine',
                                'There is no significant difference between the two'
                            ], 
                            answer: 'Complementary medicine is used together with standard care, while alternative medicine is used instead of standard care' 
                        },
                        { 
                            q: 'Which of the following is NOT typically considered a type of complementary and alternative medicine?', 
                            options: [
                                'Chemotherapy',
                                'Acupuncture',
                                'Herbal medicine',
                                'Meditation'
                            ], 
                            answer: 'Chemotherapy' 
                        },
                        { 
                            q: 'What should patients always do before trying a complementary or alternative therapy?', 
                            options: [
                                'Discuss it with their healthcare provider',
                                'Keep it secret from their doctor',
                                'Only try therapies that are very expensive',
                                'Avoid telling anyone about it'
                            ], 
                            answer: 'Discuss it with their healthcare provider' 
                        },
                        { 
                            q: 'Which organization within the NIH is specifically dedicated to researching complementary and alternative medicine?', 
                            options: [
                                'National Center for Complementary and Integrative Health (NCCIH)',
                                'Centers for Disease Control and Prevention (CDC)',
                                'Food and Drug Administration (FDA)',
                                'World Health Organization (WHO)'
                            ], 
                            answer: 'National Center for Complementary and Integrative Health (NCCIH)' 
                        },
                        { 
                            q: 'What is integrative medicine?', 
                            options: [
                                'Combining conventional medical treatments with CAM therapies that have scientific evidence',
                                'Using only alternative medicine approaches',
                                'Avoiding all conventional medical treatments',
                                'Focusing exclusively on herbal remedies'
                            ], 
                            answer: 'Combining conventional medical treatments with CAM therapies that have scientific evidence' 
                        }
                    ]
                },
                {
                    id: 'tech-1-quiz',
                    title: 'Web Development Fundamentals Quiz',
                    category: 'Technology',
                    courseId: 'tech-1',
                    questions: [
                        { 
                            q: 'What does HTML stand for?', 
                            options: [
                                'HyperText Markup Language',
                                'High Tech Modern Language',
                                'Home Tool Management Link',
                                'Hyper Transfer Markup Language'
                            ], 
                            answer: 'HyperText Markup Language' 
                        },
                        { 
                            q: 'Which of these is primarily responsible for the visual styling of a webpage?', 
                            options: [
                                'CSS',
                                'HTML',
                                'JavaScript',
                                'PHP'
                            ], 
                            answer: 'CSS' 
                        },
                        { 
                            q: 'What is the main purpose of JavaScript in web development?', 
                            options: [
                                'To make web pages interactive',
                                'To structure content on a webpage',
                                'To style the appearance of a webpage',
                                'To store data in a database'
                            ], 
                            answer: 'To make web pages interactive' 
                        },
                        { 
                            q: 'Which of these is considered a back-end technology?', 
                            options: [
                                'Node.js',
                                'HTML',
                                'CSS',
                                'JavaScript'
                            ], 
                            answer: 'Node.js' 
                        },
                        { 
                            q: 'What does the term "full-stack developer" refer to?', 
                            options: [
                                'A developer who works on both front-end and back-end',
                                'A developer who only works on databases',
                                'A developer who specializes in mobile apps',
                                'A developer who only designs user interfaces'
                            ], 
                            answer: 'A developer who works on both front-end and back-end' 
                        }
                    ]
                },
                // Additional quizzes would continue here...
            ];
        }

        // --- Utility Functions ---

        function render() {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;
            appContainer.innerHTML = '';
            showLoading(state.isLoading);

            if (!state.user) {
                appContainer.innerHTML = renderAuthScreen();
                attachAuthListeners();
            } else if (state.currentView === 'loading') {
                appContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full p-8"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p class="mt-4 text-gray-500">Loading Dashboard...</p></div>';
            } else if (state.currentView === 'course-detail') {
                appContainer.innerHTML = renderHeader() + renderCourseDetail();
                attachCourseDetailListeners();
            } else {
                appContainer.innerHTML = renderHeader() + renderContent();
                attachNavListeners();
                attachContentListeners();
                updateNotifications();
            }
            
            // Update browser title based on current view
            updateBrowserTitle();
        }

        function showLoading(show) {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        function showModal(content, onConfirm = null, onCancel = null) {
            const modal = document.getElementById('global-modal');
            const modalContent = document.getElementById('modal-content');
            const modalConfirm = document.getElementById('modal-confirm');
            const modalCancel = document.getElementById('modal-cancel');

            if (!modal || !modalContent) return;

            modalContent.innerHTML = content;
            modal.classList.remove('hidden');

            if (onConfirm) {
                modalConfirm.classList.remove('hidden');
                modalConfirm.onclick = () => {
                    onConfirm();
                    modal.classList.add('hidden');
                    modalConfirm.onclick = null;
                };
            } else {
                modalConfirm.classList.add('hidden');
                modalConfirm.onclick = null;
            }

            if (onCancel) {
                modalCancel.classList.remove('hidden');
                modalCancel.onclick = () => {
                    onCancel();
                    modal.classList.add('hidden');
                    modalCancel.onclick = null;
                };
            } else {
                modalCancel.classList.add('hidden');
                modalCancel.onclick = null;
            }
        }

        function hideModal() {
            document.getElementById('global-modal').classList.add('hidden');
        }

        function formatPoints(points) {
            return points.toLocaleString();
        }

        function generateUniqueId() {
            return 'user-' + Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function calculateStreak(loginDates) {
            if (!loginDates || loginDates.length === 0) return 0;
            
            // Sort dates in descending order
            const sortedDates = [...loginDates].sort((a, b) => new Date(b) - new Date(a));
            let streak = 1;
            let currentDate = new Date(sortedDates[0]);
            
            for (let i = 1; i < sortedDates.length; i++) {
                const prevDate = new Date(currentDate);
                prevDate.setDate(prevDate.getDate() - 1);
                
                const checkDate = new Date(sortedDates[i]);
                if (checkDate.toDateString() === prevDate.toDateString()) {
                    streak++;
                    currentDate = checkDate;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // --- Browser Navigation Handling ---
        function initializeBrowserHistory() {
            window.history.replaceState({ view: state.currentView }, '', window.location.pathname);
        }

        function updateBrowserTitle() {
            const viewTitles = {
                'dashboard': 'Dashboard',
                'learn': 'Learn',
                'quiz': 'Quiz',
                'ads': 'Watch Ads',
                'referral': 'Refer & Earn',
                'rewards': 'Withdraw',
                'leaderboard': 'Leaderboard',
                'achievements': 'Achievements',
                'course-detail': state.currentCourse ? state.currentCourse.title : 'Course'
            };
            
            const title = viewTitles[state.currentView] || 'EduHeTech';
            document.title = `${title} - EduHeTech`;
        }

        // --- Core Application Logic ---

        function updateLeaderboards() {
            const allUsersArray = Object.values(state.allUsers);

            state.leaderboard = allUsersArray
                .sort((a, b) => b.eduPoints - a.eduPoints)
                .slice(0, 10);

            state.topReferrers = allUsersArray
                .sort((a, b) => b.referralCount - a.referralCount)
                .slice(0, 10);
        }

        function checkAchievements() {
            if (!state.user) return;
            
            const userAchievements = state.user.achievements || [];
            const newAchievements = [];
            
            state.achievements.forEach(achievement => {
                // Skip if already earned
                if (userAchievements.includes(achievement.id)) return;
                
                let conditionMet = false;
                const condition = achievement.condition;
                
                switch(condition.type) {
                    case 'lessonsCompleted':
                        const lessonCount = (state.user.history || []).filter(h => h.action.includes('Lesson Completed')).length;
                        conditionMet = lessonCount >= condition.threshold;
                        break;
                    case 'quizzesCompleted':
                        const quizCount = (state.user.history || []).filter(h => h.action.includes('Quiz Completed')).length;
                        conditionMet = quizCount >= condition.threshold;
                        break;
                    case 'streak':
                        const streak = calculateStreak(state.user.loginDates || []);
                        conditionMet = streak >= condition.threshold;
                        break;
                    case 'points':
                        conditionMet = state.user.eduPoints >= condition.threshold;
                        break;
                    case 'referrals':
                        conditionMet = state.user.referralCount >= condition.threshold;
                        break;
                    case 'categoryCompleted':
                        const categoryLessons = state.lessons.filter(l => l.category === condition.category);
                        const completedCategoryLessons = categoryLessons.filter(lesson => 
                            (state.user.history || []).some(h => h.action === `Lesson Completed: ${lesson.title}`)
                        );
                        conditionMet = completedCategoryLessons.length >= condition.threshold;
                        break;
                }
                
                if (conditionMet) {
                    userAchievements.push(achievement.id);
                    newAchievements.push(achievement);
                    
                    // Award points for achievement
                    addPoints(`Achievement: ${achievement.name}`, achievement.points, false);
                }
            });
            
            // Save updated achievements
            if (newAchievements.length > 0) {
                state.user.achievements = userAchievements;
                saveUser(state.user);
                
                // Show achievement notification
                showAchievementNotification(newAchievements);
            }
        }

        function showAchievementNotification(achievements) {
            achievements.forEach(achievement => {
                const notification = {
                    id: generateUniqueId(),
                    type: 'achievement',
                    title: 'Achievement Unlocked!',
                    message: `You earned the "${achievement.name}" achievement!`,
                    icon: achievement.icon,
                    points: achievement.points,
                    timestamp: Date.now()
                };
                
                state.notifications.push(notification);
            });
            
            // Update notification badge
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const unreadCount = state.notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-badge');
            
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function hasReachedDailyLimit() {
            if (!state.user) return true;
            
            const today = new Date().toDateString();
            const todayEarnings = (state.user.history || [])
                .filter(h => {
                    const historyDate = new Date(h.timestamp).toDateString();
                    return historyDate === today && h.points > 0;
                })
                .reduce((sum, h) => sum + h.points, 0);
                
            return todayEarnings >= DAILY_POINTS_LIMIT;
        }

        function getTodayEarnings() {
            if (!state.user) return 0;
            
            const today = new Date().toDateString();
            return (state.user.history || [])
                .filter(h => {
                    const historyDate = new Date(h.timestamp).toDateString();
                    return historyDate === today && h.points > 0;
                })
                .reduce((sum, h) => sum + h.points, 0);
        }

        function initializeData() {
            initMockData();

            state.allUsers = loadAllUsers();
            state.lessons = loadCollection(LS_LESSONS).sort((a, b) => a.order - b.order);
            state.quizzes = loadCollection(LS_QUIZZES);
            state.withdrawalRequests = loadCollection(LS_WITHDRAWALS);
            state.achievements = loadCollection(LS_ACHIEVEMENTS);

            userId = sessionStorage.getItem(SS_CURRENT_USER_ID);

            if (!userId || !state.allUsers[userId]) {
                state.user = null;
                state.currentView = 'auth';
                render();
                return;
            }

            state.user = state.allUsers[userId];

            // Check Daily Bonus and Streak
            const today = new Date().toDateString();
            const lastLoginDate = new Date(state.user.lastLogin).toDateString();
            
            // Initialize login dates array if not exists
            if (!state.user.loginDates) {
                state.user.loginDates = [];
            }
            
            if (today !== lastLoginDate) {
                // Add today to login dates
                if (!state.user.loginDates.includes(today)) {
                    state.user.loginDates.push(today);
                }
                
                // Calculate streak
                const streak = calculateStreak(state.user.loginDates);
                state.user.streak = streak;
                
                // Award daily login bonus (if not reached limit)
                if (!hasReachedDailyLimit()) {
                    addPoints('Daily Login Bonus', BASE_POINTS_REWARDS.dailyLogin, false);
                }
                
                // Award streak bonus if applicable (if not reached limit)
                if (streak >= 3 && !hasReachedDailyLimit()) {
                    addPoints(`${streak}-Day Streak Bonus`, BASE_POINTS_REWARDS.streak, false);
                }
                
                state.user.lastLogin = Date.now();
                saveUser(state.user);
            }

            updateLeaderboards();
            checkAchievements();
            state.currentView = 'dashboard';
            
            // Initialize browser history
            initializeBrowserHistory();
            
            render();
        }

        function saveUser(user) {
            state.allUsers[user.userId] = user;
            saveAllUsers(state.allUsers);
        }

        function addPoints(action, points, checkDailyLimit = true) {
            if (!state.user) return;
            
            // Check daily limit if required
            if (checkDailyLimit && hasReachedDailyLimit()) {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-triangle text-5xl text-yellow-500"></i>
                        <h3 class="text-xl font-bold text-yellow-600">Daily Limit Reached</h3>
                        <p class="text-gray-600">You have reached your daily earning limit of ${formatPoints(DAILY_POINTS_LIMIT)} points. Come back tomorrow to earn more!</p>
                    </div>
                `);
                return;
            }
            
            showLoading(true);

            // Update user data
            state.user.eduPoints += points;
            const historyEntry = { action, points, timestamp: Date.now() };
            if (!state.user.history) state.user.history = [];
            state.user.history.push(historyEntry);

            // Save and re-render
            saveUser(state.user);
            updateLeaderboards();
            checkAchievements();

            render();

            // Enhanced animation feedback - FIXED: This will now auto-hide properly
            const coinAnimation = document.getElementById('coin-animation');
            if (coinAnimation) {
                coinAnimation.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg slide-in">
                        <div class="flex items-center">
                            <i class="fas fa-coins text-xl mr-2"></i>
                            <span class="font-bold">+${points} EduPoints!</span>
                        </div>
                        <p class="text-sm mt-1">${action}</p>
                    </div>
                `;
                setTimeout(() => {
                    if (coinAnimation) coinAnimation.innerHTML = '';
                }, 3000);
            }

            showLoading(false);
        }

        function rewardPoints(targetUserId, points, action) {
            const targetUser = state.allUsers[targetUserId];
            if (!targetUser) return;

            targetUser.eduPoints += points;
            const historyEntry = { action, points, timestamp: Date.now() };
            if (!targetUser.history) targetUser.history = [];
            targetUser.history.push(historyEntry);

            saveUser(targetUser);
            updateLeaderboards();
        }

        function trackReferral(referrerId) {
            const targetUser = state.allUsers[referrerId];
            if (!targetUser) return;

            targetUser.referralCount = (targetUser.referralCount || 0) + 1;
            saveUser(targetUser);
            updateLeaderboards();
            checkAchievements();
        }

        // --- Enhanced UI Rendering Functions ---

        function renderAuthScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="w-full max-w-md card p-8 space-y-6 shadow-xl">
                        <div class="text-center">
                            <h1 class="text-4xl font-extrabold text-blue-600 mb-2">EduHeTech</h1>
                            <p class="text-gray-600">Learn valuable skills and earn rewards!</p>
                        </div>

                        <div id="auth-form-container" class="space-y-4">
                            <!-- Auth Form will be rendered here -->
                        </div>

                        <div class="text-center">
                            <button id="toggle-auth" class="text-sm text-blue-500 hover:text-blue-700 font-medium transition-colors">Need an account? Sign Up</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoginForm() {
            return `
                <h2 class="text-2xl font-bold text-center text-gray-800">Welcome Back</h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <button id="login-btn" class="w-full p-3 btn-primary font-semibold rounded-lg shadow-md hover:shadow-lg transition">Log In</button>
                </div>
                <div id="auth-error-message" class="text-red-500 text-sm text-center mt-2"></div>
            `;
        }

        function renderSignupForm() {
            return `
                <h2 class="text-2xl font-bold text-center text-gray-800">Join EduHeTech</h2>
                <div class="space-y-4">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="signup-name" placeholder="Enter your full name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="signup-password" placeholder="Create a password (min 6 chars)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="signup-referral" class="block text-sm font-medium text-gray-700 mb-1">Referral Code (Optional)</label>
                        <input type="text" id="signup-referral" placeholder="Enter referral code if you have one" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <button id="signup-btn" class="w-full p-3 btn-primary font-semibold rounded-lg shadow-md hover:shadow-lg transition">Create Account</button>
                </div>
                <div id="auth-error-message" class="text-red-500 text-sm text-center mt-2"></div>
            `;
        }

        function renderHeader() {
            const { name, eduPoints, streak = 0 } = state.user;
            const viewName = state.currentView.charAt(0).toUpperCase() + state.currentView.slice(1);
            const todayEarnings = getTodayEarnings();
            const dailyLimitReached = hasReachedDailyLimit();

            return `
                <header class="bg-white shadow-md p-4 sticky top-0 z-10 flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <button id="menu-toggle" class="p-2 rounded-lg hover:bg-gray-100 md:hidden">
                            <i class="fas fa-bars text-gray-600"></i>
                        </button>
                        <h1 class="text-xl font-bold text-blue-600">${viewName}</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        ${dailyLimitReached ? `
                            <div class="hidden sm:flex items-center space-x-1 bg-red-50 px-3 py-1 rounded-full border border-red-200">
                                <i class="fas fa-info-circle text-red-500"></i>
                                <span class="text-sm font-bold text-red-700">Daily Limit Reached</span>
                            </div>
                        ` : `
                            <div class="hidden sm:flex items-center space-x-1 bg-green-50 px-3 py-1 rounded-full border border-green-200">
                                <i class="fas fa-coins text-green-500"></i>
                                <span class="text-sm font-bold text-green-700">${formatPoints(todayEarnings)}/${formatPoints(DAILY_POINTS_LIMIT)} Today</span>
                            </div>
                        `}
                        ${streak > 0 ? `
                            <div class="hidden sm:flex items-center space-x-1 bg-orange-50 px-3 py-1 rounded-full border border-orange-200">
                                <i class="fas fa-fire text-orange-500 ${streak >= 3 ? 'streak-flame' : ''}"></i>
                                <span class="text-sm font-bold text-orange-700">${streak} day${streak !== 1 ? 's' : ''}</span>
                            </div>
                        ` : ''}
                        <div class="flex items-center space-x-2 bg-blue-50 px-3 py-1 rounded-full border border-blue-200">
                            <i class="fas fa-coins text-yellow-500"></i>
                            <span class="text-sm font-bold text-blue-700">${formatPoints(eduPoints)}</span>
                        </div>
                        <div class="relative">
                            <button id="notification-btn" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-blue-50 transition">
                                <i class="fas fa-bell"></i>
                                <div id="notification-badge" class="notification-badge" style="display: none;"></div>
                            </button>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex flex-col items-end">
                                <span class="text-sm font-semibold truncate max-w-28">${name}</span>
                                <span class="text-xs text-gray-500">Learner</span>
                            </div>
                            <button id="logout-btn" class="text-gray-500 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </header>
                <div id="coin-animation" class="fixed top-20 right-4 p-2 z-50"></div>
                <div id="notification-panel" class="hidden fixed top-16 right-4 w-80 bg-white rounded-lg shadow-xl z-40 border border-gray-200 max-h-96 overflow-y-auto">
                    <!-- Notifications will be populated here -->
                </div>
            `;
        }

        function renderNotifications() {
            const notifications = state.notifications.slice().reverse(); // Show newest first
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (notifications.length === 0) {
                return `
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-bell-slash text-2xl mb-2"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
            }
            
            return `
                <div class="p-2">
                    <div class="flex justify-between items-center p-2 border-b">
                        <h3 class="font-semibold">Notifications</h3>
                        ${unreadCount > 0 ? `
                            <button id="mark-all-read" class="text-xs text-blue-500 hover:text-blue-700">Mark all as read</button>
                        ` : ''}
                    </div>
                    <div class="divide-y">
                        ${notifications.map(notification => `
                            <div class="p-3 ${notification.read ? 'bg-white' : 'bg-blue-50'} transition">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                        <i class="${notification.icon || 'fas fa-bell'} ${notification.type === 'achievement' ? 'text-yellow-500' : 'text-blue-500'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-sm">${notification.title}</p>
                                        <p class="text-xs text-gray-600 mt-1">${notification.message}</p>
                                        ${notification.points ? `<p class="text-xs text-green-600 font-bold mt-1">+${notification.points} points</p>` : ''}
                                        <p class="text-xs text-gray-400 mt-1">${new Date(notification.timestamp).toLocaleDateString()}</p>
                                    </div>
                                    ${!notification.read ? `
                                        <div class="w-2 h-2 rounded-full bg-blue-500 flex-shrink-0 mt-2"></div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function updateNotifications() {
            const panel = document.getElementById('notification-panel');
            if (panel) {
                panel.innerHTML = renderNotifications();
                attachNotificationListeners();
            }
        }

        function renderContent() {
            let mainContent = '';
            switch(state.currentView) {
                case 'dashboard':
                    mainContent = renderDashboard();
                    break;
                case 'learn':
                    mainContent = renderLearnSection();
                    break;
                case 'quiz':
                    mainContent = renderQuizSection();
                    break;
                case 'ads':
                    mainContent = renderAdsSection();
                    break;
                case 'referral':
                    mainContent = renderReferralSection();
                    break;
                case 'rewards':
                    mainContent = renderRewardsSection();
                    break;
                case 'leaderboard':
                    mainContent = renderLeaderboard();
                    break;
                case 'achievements':
                    mainContent = renderAchievementsSection();
                    break;
                default:
                    mainContent = renderDashboard();
            }

            return `
                <div class="flex">
                    <!-- Sidebar/Bottom Nav (Mobile-First) -->
                    ${renderSidebar()}
                    <!-- Main Content Area -->
                    <main class="flex-1 p-4 sm:p-6 pb-20 sm:pb-4 scrollable-content" id="main-content">
                        ${mainContent}
                    </main>
                </div>
            `;
        }

        function renderSidebar() {
            const navItems = [
                { id: 'dashboard', icon: 'fas fa-home', label: 'Home' },
                { id: 'learn', icon: 'fas fa-graduation-cap', label: 'Learn' },
                { id: 'quiz', icon: 'fas fa-question-circle', label: 'Quiz' },
                { id: 'ads', icon: 'fas fa-ad', label: 'Ads' },
                { id: 'referral', icon: 'fas fa-share-alt', label: 'Refer' },
                { id: 'rewards', icon: 'fas fa-coins', label: 'Rewards' },
                { id: 'leaderboard', icon: 'fas fa-trophy', label: 'Leaderboard' },
                { id: 'achievements', icon: 'fas fa-medal', label: 'Achievements' }
            ];

            // Mobile Bottom Navigation Bar (Visible on small screens)
            const mobileNav = `
                <nav class="fixed bottom-0 left-0 right-0 bg-white border-t sm:hidden z-20 shadow-lg">
                    <div class="flex justify-around">
                        ${navItems.slice(0, 5).map(item => `
                            <button data-view="${item.id}" class="nav-item flex flex-col items-center p-2 text-xs ${state.currentView === item.id ? 'text-blue-600 font-bold' : 'text-gray-500 hover:text-blue-500'} transition-colors">
                                <i class="${item.icon} text-lg mb-1"></i>
                                <span>${item.label}</span>
                            </button>
                        `).join('')}
                        <button id="more-menu-btn" class="flex flex-col items-center p-2 text-xs text-gray-500 hover:text-blue-500 transition-colors">
                            <i class="fas fa-ellipsis-h text-lg mb-1"></i>
                            <span>More</span>
                        </button>
                    </div>
                </nav>
            `;

            // Desktop Sidebar (Hidden on small screens)
            const desktopSidebar = `
                <aside class="hidden sm:flex sm:flex-col w-64 bg-white shadow-md h-screen fixed left-0 top-0 z-10 pt-16">
                    <div class="flex-1 overflow-y-auto p-4 space-y-2">
                        ${navItems.map(item => `
                            <button data-view="${item.id}" class="nav-item w-full flex items-center space-x-3 p-3 rounded-lg ${state.currentView === item.id ? 'bg-blue-50 text-blue-600 font-semibold' : 'text-gray-600 hover:bg-gray-100'} transition-colors">
                                <i class="${item.icon} w-5 text-center"></i>
                                <span>${item.label}</span>
                            </button>
                        `).join('')}
                    </div>
                    <div class="p-4 border-t border-gray-200">
                        <div class="flex items-center space-x-3 p-2">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-blue-600"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">${state.user.name}</p>
                                <p class="text-xs text-gray-500 truncate">${state.user.email}</p>
                            </div>
                        </div>
                    </div>
                </aside>
                <div class="hidden sm:block w-64 flex-shrink-0"></div>
            `;

            return mobileNav + desktopSidebar;
        }

        // --- Enhanced Dashboard View ---
        function renderDashboard() {
            const { eduPoints, name, history, streak = 0 } = state.user;
            const usdEquivalent = (eduPoints / 100000).toFixed(2);
            const progress = Math.min(100, (eduPoints / MIN_WITHDRAWAL_POINTS) * 100);
            const todayEarnings = getTodayEarnings();
            const dailyLimitReached = hasReachedDailyLimit();
            
            const todayActivities = (history || [])
                .filter(h => {
                    const activityDate = new Date(h.timestamp);
                    const today = new Date();
                    return activityDate.toDateString() === today.toDateString();
                })
                .slice(-5)
                .reverse();

            const achievements = getAchievements();
            const earnedAchievements = achievements.filter(a => a.earned).length;
            const totalAchievements = achievements.length;

            return `
                <section class="space-y-6 fade-in">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h2 class="text-2xl font-bold text-gray-800">Welcome back, ${name.split(' ')[0]}!</h2>
                        <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                            ${dailyLimitReached ? `
                                <div class="flex items-center space-x-1 bg-red-50 px-3 py-1 rounded-full border border-red-200">
                                    <i class="fas fa-info-circle text-red-500"></i>
                                    <span class="text-sm font-bold text-red-700">Daily Limit Reached</span>
                                </div>
                            ` : `
                                <div class="flex items-center space-x-1 bg-green-50 px-3 py-1 rounded-full border border-green-200">
                                    <i class="fas fa-coins text-green-500"></i>
                                    <span class="text-sm font-bold text-green-700">${formatPoints(todayEarnings)}/${formatPoints(DAILY_POINTS_LIMIT)} Today</span>
                                </div>
                            `}
                            ${streak > 0 ? `
                                <div class="flex items-center space-x-1 bg-orange-50 px-3 py-1 rounded-full border border-orange-200">
                                    <i class="fas fa-fire text-orange-500 ${streak >= 3 ? 'streak-flame' : ''}"></i>
                                    <span class="text-sm font-bold text-orange-700">${streak} day streak</span>
                                </div>
                            ` : ''}
                            <div class="text-sm text-gray-500">
                                ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                            </div>
                        </div>
                    </div>

                    <!-- Stats Overview -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">${formatPoints(eduPoints)}</div>
                            <div class="text-xs text-gray-500 mt-1">Total Points</div>
                        </div>
                        <div class="card p-4 text-center">
                            <div class="text-2xl font-bold text-green-600">${(history || []).filter(h => h.action.includes('Lesson Completed')).length}</div>
                            <div class="text-xs text-gray-500 mt-1">Lessons</div>
                        </div>
                        <div class="card p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600">${(history || []).filter(h => h.action.includes('Quiz Completed')).length}</div>
                            <div class="text-xs text-gray-500 mt-1">Quizzes</div>
                        </div>
                        <div class="card p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-600">${earnedAchievements}/${totalAchievements}</div>
                            <div class="text-xs text-gray-500 mt-1">Achievements</div>
                        </div>
                    </div>

                    <!-- Main Points Card -->
                    <div class="card p-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div>
                                <p class="text-sm opacity-90">Your EduPoints Balance</p>
                                <h3 class="text-4xl font-extrabold mt-1">${formatPoints(eduPoints)}</h3>
                                <p class="text-lg font-medium mt-2">~ $${usdEquivalent} USD</p>
                                ${dailyLimitReached ? `
                                    <div class="mt-2 bg-red-500 bg-opacity-20 p-2 rounded-lg">
                                        <p class="text-sm">Daily limit reached. Come back tomorrow!</p>
                                    </div>
                                ` : `
                                    <p class="text-sm opacity-90 mt-2">${formatPoints(DAILY_POINTS_LIMIT - todayEarnings)} points remaining today</p>
                                `}
                            </div>
                            <div class="mt-4 md:mt-0 flex items-center justify-center">
                                <div class="relative w-24 h-24">
                                    <svg class="w-24 h-24" viewBox="0 0 36 36">
                                        <path class="text-white opacity-20"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="3"/>
                                        <path class="text-white"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="3"
                                            stroke-dasharray="${progress}, 100"/>
                                        <text x="18" y="20.5" class="text-sm font-bold fill-white text-center">
                                            <tspan x="18" dy="0" text-anchor="middle">${progress.toFixed(0)}%</tspan>
                                        </text>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button data-view="learn" class="card p-4 text-center hover:bg-blue-50 transition-colors group ${dailyLimitReached ? 'opacity-50 cursor-not-allowed' : ''}" ${dailyLimitReached ? 'disabled' : ''}>
                            <i class="fas fa-book-open text-2xl text-blue-500 mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium text-gray-700">Learn</p>
                            <p class="text-xs text-gray-500 mt-1">Earn ${BASE_POINTS_REWARDS.lesson} points</p>
                        </button>
                        <button data-view="quiz" class="card p-4 text-center hover:bg-green-50 transition-colors group ${dailyLimitReached ? 'opacity-50 cursor-not-allowed' : ''}" ${dailyLimitReached ? 'disabled' : ''}>
                            <i class="fas fa-brain text-2xl text-green-500 mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium text-gray-700">Quiz</p>
                            <p class="text-xs text-gray-500 mt-1">Earn ${BASE_POINTS_REWARDS.quiz} points</p>
                        </button>
                        <button data-view="ads" class="card p-4 text-center hover:bg-yellow-50 transition-colors group ${dailyLimitReached ? 'opacity-50 cursor-not-allowed' : ''}" ${dailyLimitReached ? 'disabled' : ''}>
                            <i class="fas fa-ad text-2xl text-yellow-500 mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium text-gray-700">Watch Ads</p>
                            <p class="text-xs text-gray-500 mt-1">Earn ${BASE_POINTS_REWARDS.ad} points</p>
                        </button>
                        <button data-view="rewards" class="card p-4 text-center hover:bg-purple-50 transition-colors group">
                            <i class="fas fa-gift text-2xl text-purple-500 mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium text-gray-700">Rewards</p>
                            <p class="text-xs text-gray-500 mt-1">Withdraw points</p>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Today's Activities -->
                        <div class="card p-5">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-history text-blue-500 mr-2"></i>
                                Today's Activities
                            </h3>
                            <div class="space-y-3">
                                ${todayActivities.length > 0 ? todayActivities.map(item => `
                                    <div class="flex justify-between items-center text-sm p-2 rounded-lg hover:bg-gray-50 transition">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                            <span class="text-gray-600 truncate">${item.action}</span>
                                        </div>
                                        <span class="font-bold text-green-600 whitespace-nowrap">+${item.points} Pts</span>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-4 text-gray-500">
                                        <i class="fas fa-inbox text-2xl mb-2"></i>
                                        <p>No activities today yet</p>
                                        <p class="text-sm mt-1">Complete a lesson or quiz to earn points!</p>
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Recent Achievements -->
                        <div class="card p-5">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-medal text-yellow-500 mr-2"></i>
                                Recent Achievements
                            </h3>
                            <div class="space-y-3">
                                ${achievements.filter(a => a.earned).slice(0, 3).map(achievement => `
                                    <div class="flex items-center space-x-3 p-2 rounded-lg bg-yellow-50 border border-yellow-200">
                                        <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                                            <i class="${achievement.icon} text-yellow-600"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-sm text-gray-800">${achievement.name}</p>
                                            <p class="text-xs text-gray-600">${achievement.description}</p>
                                        </div>
                                    </div>
                                `).join('')}
                                ${achievements.filter(a => a.earned).length === 0 ? `
                                    <div class="text-center py-4 text-gray-500">
                                        <i class="fas fa-medal text-2xl mb-2"></i>
                                        <p>No achievements yet</p>
                                        <p class="text-sm mt-1">Complete activities to unlock achievements!</p>
                                    </div>
                                ` : ''}
                                ${achievements.filter(a => a.earned).length > 3 ? `
                                    <div class="text-center pt-2">
                                        <button data-view="achievements" class="text-sm text-blue-500 hover:text-blue-700 font-medium">
                                            View all achievements
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </section>
            `;
        }

        function getAchievements() {
            const history = state.user.history || [];
            const userAchievements = state.user.achievements || [];
            const quizCount = history.filter(h => h.action.includes('Quiz Completed')).length;
            const lessonCount = history.filter(h => h.action.includes('Lesson Completed')).length;
            const adCount = history.filter(h => h.action.includes('Ad Watched')).length;
            const streak = state.user.streak || 0;

            return [
                { 
                    id: 'a1', 
                    name: 'First Steps', 
                    description: 'Complete your first lesson', 
                    icon: 'fas fa-footsteps', 
                    type: 'bronze', 
                    earned: userAchievements.includes('a1') || lessonCount >= 1,
                    progress: Math.min(100, (lessonCount / 1) * 100)
                },
                { 
                    id: 'a2', 
                    name: 'Quiz Whiz', 
                    description: 'Complete 5 quizzes', 
                    icon: 'fas fa-brain', 
                    type: 'silver', 
                    earned: userAchievements.includes('a2') || quizCount >= 5,
                    progress: Math.min(100, (quizCount / 5) * 100)
                },
                { 
                    id: 'a3', 
                    name: 'Learning Streak', 
                    description: 'Maintain a 7-day learning streak', 
                    icon: 'fas fa-fire', 
                    type: 'gold', 
                    earned: userAchievements.includes('a3') || streak >= 7,
                    progress: Math.min(100, (streak / 7) * 100)
                },
                { 
                    id: 'a4', 
                    name: 'Point Collector', 
                    description: 'Earn 50,000 points', 
                    icon: 'fas fa-coins', 
                    type: 'gold', 
                    earned: userAchievements.includes('a4') || state.user.eduPoints >= 50000,
                    progress: Math.min(100, (state.user.eduPoints / 50000) * 100)
                },
                { 
                    id: 'a5', 
                    name: 'Ad Enthusiast', 
                    description: 'Watch 10 ads', 
                    icon: 'fas fa-ad', 
                    type: 'silver', 
                    earned: userAchievements.includes('a5') || adCount >= 10,
                    progress: Math.min(100, (adCount / 10) * 100)
                }
            ];
        }

        // --- Enhanced Learn Section View ---
        function renderLearnSection() {
            const categories = [...new Set(state.lessons.map(l => l.category))];
            const { user } = state;
            const completedLessons = (user.history || []).filter(h => h.action.includes('Lesson Completed')).length;
            const totalLessons = state.lessons.length;
            const progress = totalLessons > 0 ? (completedLessons / totalLessons) * 100 : 0;
            const dailyLimitReached = hasReachedDailyLimit();

            return `
                <section class="space-y-6 fade-in">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h2 class="text-2xl font-bold">Learning Center</h2>
                        <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                            <div class="text-sm text-gray-600">
                                <span class="font-semibold">${completedLessons}</span> of <span class="font-semibold">${totalLessons}</span> lessons completed
                            </div>
                            <div class="w-32 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-600">Complete lessons to earn <span class="font-semibold text-green-600">${BASE_POINTS_REWARDS.lesson} EduPoints</span> each.</p>
                    
                    ${dailyLimitReached ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-red-500 mr-2"></i>
                                <p class="text-red-700">You have reached your daily earning limit. Come back tomorrow to earn more points from lessons.</p>
                            </div>
                        </div>
                    ` : ''}

                    ${categories.map(category => {
                        const filteredLessons = state.lessons.filter(l => l.category === category);
                        if (filteredLessons.length === 0) return '';

                        return `
                            <div class="space-y-4">
                                <h3 class="text-xl font-bold text-blue-600 flex items-center">
                                    <i class="fas fa-folder-open mr-2"></i>
                                    ${category}
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${filteredLessons.map(lesson => {
                                        const isCompleted = (user.history || []).some(h => h.action === `Lesson Completed: ${lesson.title}`);
                                        return `
                                            <div class="card p-5 flex flex-col h-full ${isCompleted ? 'border-l-4 border-green-500 bg-green-50' : 'border-l-4 border-blue-400'} transition-all hover:shadow-md">
                                                <div class="flex-1">
                                                    <div class="flex justify-between items-start mb-2">
                                                        <p class="font-semibold text-lg">${lesson.title}</p>
                                                        ${isCompleted ? `
                                                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">
                                                                <i class="fas fa-check mr-1"></i>Completed
                                                            </span>
                                                        ` : `
                                                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-medium">
                                                                ${lesson.duration || 5} min
                                                            </span>
                                                        `}
                                                    </div>
                                                    <p class="text-sm text-gray-500 mb-3">${lesson.subcategory || 'General'}</p>
                                                    <div class="flex items-center text-xs text-gray-500 mb-4">
                                                        <span class="bg-gray-100 px-2 py-1 rounded mr-2">
                                                            <i class="fas fa-signal mr-1"></i>${lesson.difficulty || 'Beginner'}
                                                        </span>
                                                        <span class="bg-gray-100 px-2 py-1 rounded">
                                                            <i class="fas fa-coins mr-1"></i>+${BASE_POINTS_REWARDS.lesson} points
                                                        </span>
                                                    </div>
                                                </div>
                                                ${isCompleted ? `
                                                    <div class="flex items-center text-green-600 font-bold text-sm pt-3 border-t border-green-200">
                                                        <i class="fas fa-check-circle mr-2"></i> Completed! Reward claimed
                                                    </div>
                                                ` : `
                                                    <button data-lesson-id="${lesson.id}" class="view-course-btn w-full p-3 btn-primary font-semibold rounded-lg mt-auto ${dailyLimitReached ? 'opacity-50 cursor-not-allowed' : ''}" ${dailyLimitReached ? 'disabled' : ''}>
                                                        Start Learning & Earn ${BASE_POINTS_REWARDS.lesson} Points
                                                    </button>
                                                `}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </section>
            `;
        }

        function renderCourseDetail() {
            if (!state.currentCourse) {
                state.currentView = 'learn';
                render();
                return '';
            }

            const { title, category, subcategory, content, duration, difficulty, points } = state.currentCourse;
            const isCompleted = (state.user.history || []).some(h => h.action === `Lesson Completed: ${title}`);
            const dailyLimitReached = hasReachedDailyLimit();

            return `
                <section class="space-y-6 fade-in">
                    <div class="flex items-center space-x-2 mb-4">
                        <button id="back-to-courses" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-blue-50 transition">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold text-gray-800">Course Details</h2>
                    </div>

                    <div class="card p-6">
                        <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-6">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800 mb-2">${title}</h1>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${category}</span>
                                    ${subcategory ? `<span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">${subcategory}</span>` : ''}
                                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">${difficulty}</span>
                                    <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">${duration} min</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                                    <p class="text-sm text-green-600 font-semibold">Reward</p>
                                    <p class="text-lg font-bold text-green-700">+${points} Points</p>
                                </div>
                            </div>
                        </div>

                        ${content}

                        <div class="mt-8 pt-6 border-t border-gray-200">
                            ${isCompleted ? `
                                <div class="text-center py-4">
                                    <div class="flex items-center justify-center text-green-600 font-bold text-lg mb-2">
                                        <i class="fas fa-check-circle mr-2"></i> Course Completed
                                    </div>
                                    <p class="text-gray-600">You have already completed this course and earned the reward.</p>
                                </div>
                            ` : `
                                <div class="text-center">
                                    <p class="text-gray-600 mb-4">Complete this course to earn ${points} EduPoints</p>
                                    <button id="complete-course-btn" class="p-4 btn-primary font-bold rounded-lg shadow-md hover:shadow-lg transition text-lg ${dailyLimitReached ? 'opacity-50 cursor-not-allowed' : ''}" ${dailyLimitReached ? 'disabled' : ''}>
                                        <i class="fas fa-check-circle mr-2"></i> Mark as Completed & Earn Points
                                    </button>
                                    ${dailyLimitReached ? `
                                        <p class="text-red-500 text-sm mt-2">Daily limit reached. Come back tomorrow to earn points.</p>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    </div>
                </section>
            `;
        }

        // --- Enhanced Quiz Section View ---
        function renderQuizSection() {
            const { quizzes } = state;
            const completedQuizzes = (state.user.history || []).filter(h => h.action.includes('Quiz Completed')).length;
            const dailyLimitReached = hasReachedDailyLimit();

            if (quizzes.length === 0) {
                return `
                    <div class="card p-8 text-center">
                        <i class="fas fa-question-circle text-5xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">No Quizzes Available</h3>
                        <p class="text-gray-500">Check back soon for new quizzes!</p>
                    </div>
                `;
            }

            // If we're in the middle of a quiz, show the quiz interface
            if (state.quizData && !state.quizData.isComplete) {
                const currentQuiz = quizzes.find(q => q.id === state.quizData.id) || quizzes[0];
                return renderQuizInterface(currentQuiz);
            }

            // Otherwise, show the quiz selection
            return `
                <section class="space-y-6 fade-in">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h2 class="text-2xl font-bold">Quiz Center</h2>
                        <div class="text-sm text-gray-600 mt-2 sm:mt-0">
                            <span class="font-semibold">${completedQuizzes}</span> quizzes completed
                        </div>
                    </div>
                    <p class="text-gray-600">Test your knowledge and earn <span class="font-semibold text-green-600">${BASE_POINTS_REWARDS.quiz} EduPoints</span> for each passed quiz.</p>
                    
                    ${dailyLimitReached ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-red-500 mr-2"></i>
                                <p class="text-red-700">You have reached your daily earning limit. Come back tomorrow to earn more points from quizzes.</p>
                            </div>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${quizzes.map(quiz => {
                            const isCompleted = (state.user.history || []).some(h => 
                                h.action.includes(`Quiz Completed: ${quiz.title}`)
                            );
                            
                            return `
                                <div class="card p-6 flex flex-col h-full ${isCompleted ? 'border-l-4 border-green-500 bg-green-50' : 'border-l-4 border-purple-400'} transition-all hover:shadow-md">
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start mb-3">
                                            <h3 class="text-xl font-bold">${quiz.title}</h3>
                                            ${isCompleted ? `
                                                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">
                                                    <i class="fas fa-check mr-1"></i>Completed
                                                </span>
                                            ` : ''}
                                        </div>
                                        <p class="text-sm text-gray-500 mb-2">Category: <span class="font-medium">${quiz.category}</span></p>
                                        <p class="text-sm text-gray-500 mb-4">${quiz.questions.length} questions</p>
                                        <div class="flex items-center text-xs text-gray-500">
                                            <span class="bg-gray-100 px-2 py-1 rounded mr-2">
                                                <i class="fas fa-coins mr-1"></i>+${BASE_POINTS_REWARDS.quiz} points
                                            </span>
                                            <span class="bg-gray-100 px-2 py-1 rounded">
                                                <i class="fas fa-clock mr-1"></i>~${Math.ceil(quiz.questions.length * 0.5)} min
                                            </span>
                                        </div>
                                    </div>
                                    <button data-quiz-id="${quiz.id}" class="start-quiz-btn w-full mt-4 p-3 font-semibold rounded-lg ${isCompleted || dailyLimitReached ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'btn-primary'}" ${isCompleted || dailyLimitReached ? 'disabled' : ''}>
                                        ${isCompleted ? 'Quiz Completed' : (dailyLimitReached ? 'Daily Limit Reached' : 'Start Quiz')}
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </section>
            `;
        }

        function renderQuizInterface(quiz) {
            if (!state.quizData || state.quizData.id !== quiz.id || state.quizData.isComplete) {
                // Initialize/Reset Quiz
                state.quizData = { 
                    id: quiz.id, 
                    answers: Array(quiz.questions.length).fill(null), 
                    isComplete: false, 
                    results: null, 
                    currentQ: 0,
                    startTime: Date.now()
                };
            }

            const { questions } = quiz;
            const { currentQ, answers, results } = state.quizData;

            if (results) {
                // Results Screen
                const correctCount = results.filter(r => r.isCorrect).length;
                const percentage = (correctCount / questions.length) * 100;
                const passed = percentage >= 70; // 70% to pass
                const timeSpent = Math.round((Date.now() - state.quizData.startTime) / 1000 / 60); // in minutes
                
                return `
                    <section class="space-y-6 fade-in">
                        <h2 class="text-2xl font-bold text-center">Quiz Results</h2>
                        <div class="card p-8 text-center space-y-6">
                            <div class="flex justify-center">
                                <div class="relative w-32 h-32">
                                    <svg class="w-32 h-32" viewBox="0 0 36 36">
                                        <path class="text-gray-200"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="3"/>
                                        <path class="${passed ? 'text-green-500' : 'text-red-500'}"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="3"
                                            stroke-dasharray="${percentage}, 100"/>
                                        <text x="18" y="20.5" class="text-lg font-bold ${passed ? 'fill-green-500' : 'fill-red-500'} text-center">
                                            <tspan x="18" dy="0" text-anchor="middle">${percentage.toFixed(0)}%</tspan>
                                        </text>
                                    </svg>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold ${passed ? 'text-green-600' : 'text-red-600'}">
                                    ${passed ? 'Congratulations! You passed!' : 'Quiz Failed - Please Try Again'}
                                </h3>
                                <p class="text-gray-600 mt-2">You scored ${correctCount} out of ${questions.length} questions correctly.</p>
                                <p class="text-sm text-gray-500 mt-1">Time spent: ${timeSpent} minute${timeSpent !== 1 ? 's' : ''}</p>
                                <p class="text-sm ${passed ? 'text-green-600' : 'text-red-600'} font-semibold mt-2">
                                    ${passed ? `You earned ${BASE_POINTS_REWARDS.quiz} points!` : 'You need at least 70% to pass and earn points.'}
                                </p>
                            </div>
                            
                            <div class="flex justify-center space-x-4 pt-4">
                                <button id="retry-quiz-btn" class="p-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition">
                                    <i class="fas fa-redo mr-2"></i>Retry Quiz
                                </button>
                                <button id="next-quiz-btn" class="p-3 btn-primary font-semibold transition">
                                    Back to Quizzes <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </section>
                `;
            }

            const q = questions[currentQ];
            const progress = ((currentQ + 1) / questions.length) * 100;

            return `
                <section class="space-y-6 fade-in">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h2 class="text-2xl font-bold">${quiz.title}</h2>
                        <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                            <div class="text-sm text-gray-500">Question ${currentQ + 1} of ${questions.length}</div>
                            <div class="w-32 bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 space-y-6">
                        <h3 class="text-xl font-semibold">${q.q}</h3>
                        <div class="space-y-3">
                            ${q.options.map((option, index) => `
                                <button data-option="${option}" class="quiz-option w-full p-4 text-left border rounded-lg transition-all duration-150 ${answers[currentQ] === option ? 'bg-blue-100 border-blue-500 font-bold' : 'bg-gray-50 hover:bg-blue-50 border-gray-200'}">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-full border flex items-center justify-center mr-3 ${answers[currentQ] === option ? 'bg-blue-500 text-white border-blue-500' : 'bg-white border-gray-300'}">
                                            ${String.fromCharCode(65 + index)}
                                        </div>
                                        <span>${option}</span>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                        <div class="flex justify-between pt-4 border-t">
                            <button id="prev-q-btn" class="p-3 text-gray-500 hover:text-blue-600 transition ${currentQ === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentQ === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-left mr-2"></i> Previous
                            </button>
                            ${currentQ < questions.length - 1 ? `
                                <button id="next-q-btn" class="p-3 btn-primary font-semibold transition ${!answers[currentQ] ? 'opacity-50 cursor-not-allowed' : ''}" ${!answers[currentQ] ? 'disabled' : ''}>
                                    Next <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            ` : `
                                <button id="submit-quiz-btn" class="p-3 btn-primary font-semibold transition ${!answers[currentQ] ? 'opacity-50 cursor-not-allowed' : ''}" ${!answers[currentQ] ? 'disabled' : ''}>
                                    Submit Quiz <i class="fas fa-paper-plane ml-2"></i>
                                </button>
                            `}
                        </div>
                    </div>
                </section>
            `;
        }

        // --- Enhanced Ads Section View ---
        function renderAdsSection() {
            const adCount = (state.user.history || []).filter(h => h.action.includes('Ad Watched')).length;
            const dailyLimitReached = hasReachedDailyLimit();
            
            return `
                <section class="space-y-6 fade-in">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h2 class="text-2xl font-bold">Watch & Earn</h2>
                        <div class="text-sm text-gray-600 mt-2 sm:mt-0">
                            <span class="font-semibold">${adCount}</span> ads watched
                        </div>
                    </div>
                    <p class="text-gray-600">Support our partners and earn <span class="font-semibold text-green-600">${BASE_POINTS_REWARDS.ad} EduPoints</span> for each ad you watch.</p>
                    
                    ${dailyLimitReached ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-red-500 mr-2"></i>
                                <p class="text-red-700">You have reached your daily earning limit. Come back tomorrow to earn more points from ads.</p>
                            </div>
                        </div>
                    ` : ''}

                    <div class="card p-6 text-center space-y-6">
                        <div class="flex justify-center">
                            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-ad text-3xl text-blue-500"></i>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-lg">Earn EduPoints Now!</p>
                            <p class="text-sm text-gray-500 mt-2">Click below to view a partner advertisement. You will be rewarded after a 10-second viewing period.</p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center justify-center space-x-2 text-blue-700">
                                <i class="fas fa-info-circle"></i>
                                <p class="text-sm">Please remain on the ad page for at least 10 seconds to qualify for the reward.</p>
                            </div>
                        </div>
                        
                        <button id="watch-ad-btn" class="w-full p-4 btn-primary font-bold rounded-lg shadow-md hover:shadow-lg transition ${dailyLimitReached ? 'opacity-50 cursor-not-allowed' : ''}" ${dailyLimitReached ? 'disabled' : ''}>
                            <i class="fas fa-play-circle mr-2"></i> Watch Ad & Earn +${BASE_POINTS_REWARDS.ad} Points
                        </button>
                        <p id="ad-status" class="text-sm"></p>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-bold mb-4">How it works</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="text-blue-600 font-bold">1</span>
                                </div>
                                <p class="font-medium">Click Watch Ad</p>
                                <p class="text-sm text-gray-500 mt-1">A new tab will open with the advertisement</p>
                            </div>
                            <div class="text-center p-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="text-blue-600 font-bold">2</span>
                                </div>
                                <p class="font-medium">Wait 10 Seconds</p>
                                <p class="text-sm text-gray-500 mt-1">Keep the ad tab open for the required time</p>
                            </div>
                            <div class="text-center p-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="text-blue-600 font-bold">3</span>
                                </div>
                                <p class="font-medium">Get Rewarded</p>
                                <p class="text-sm text-gray-500 mt-1">Receive ${BASE_POINTS_REWARDS.ad} points automatically</p>
                            </div>
                        </div>
                    </div>
                </section>
            `;
        }

        // --- Enhanced Referral Section View ---
        function renderReferralSection() {
            const { referralCode, referralCount } = state.user;
            const referralLink = `${window.location.origin}${window.location.pathname}?ref=${referralCode}`;
            const referralEarnings = referralCount * BASE_POINTS_REWARDS.referral;

            return `
                <section class="space-y-6 fade-in">
                    <h2 class="text-2xl font-bold">Refer & Earn</h2>
                    <p class="text-gray-600">Share your unique link and earn <span class="font-semibold text-green-600">${BASE_POINTS_REWARDS.referral} EduPoints</span> for every friend who signs up.</p>

                    <div class="card p-6 space-y-6">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-user-plus text-2xl text-green-600"></i>
                            </div>
                            <h3 class="text-xl font-semibold">Your Referral Program</h3>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Referral Link</label>
                            <div class="flex items-center space-x-2 bg-gray-100 p-3 rounded-lg border border-dashed border-gray-400 overflow-hidden">
                                <input type="text" id="referral-link-input" value="${referralLink}" readonly class="flex-1 bg-transparent text-sm truncate focus:outline-none"/>
                                <button id="copy-referral-btn" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition" title="Copy Link">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <p id="copy-status" class="text-sm text-green-500 font-semibold mt-2"></p>
                        </div>

                        <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <p class="text-3xl font-bold text-blue-600">${referralCount}</p>
                                <p class="text-sm text-gray-600">Total Referrals</p>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <p class="text-3xl font-bold text-green-600">${formatPoints(referralEarnings)}</p>
                                <p class="text-sm text-gray-600">Points Earned</p>
                            </div>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-lightbulb text-yellow-500 text-lg mt-0.5"></i>
                                <div>
                                    <p class="font-medium text-yellow-800">Pro Tip</p>
                                    <p class="text-sm text-yellow-700 mt-1">Share your link on social media, in emails, or with friends directly to maximize your earnings!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold mt-6">Top Referrers</h3>
                    <div class="card p-4 space-y-3">
                        ${state.topReferrers.map((user, index) => `
                            <div class="flex justify-between items-center p-3 rounded-lg ${index < 3 ? 'bg-blue-50' : 'hover:bg-gray-50'} transition">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center ${index === 0 ? 'bg-yellow-100 text-yellow-600' : index === 1 ? 'bg-gray-100 text-gray-600' : index === 2 ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'}">
                                        ${index === 0 ? '<i class="fas fa-crown text-sm"></i>' : index + 1}
                                    </div>
                                    <span class="font-medium truncate max-w-32">${user.name}</span>
                                </div>
                                <span class="text-sm font-semibold">${user.referralCount} Referrals</span>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        // --- Enhanced Rewards/Withdrawal View ---
        function renderRewardsSection() {
            const { eduPoints } = state.user;
            const canWithdraw = eduPoints >= MIN_WITHDRAWAL_POINTS;
            const usdEquivalent = (eduPoints / 100000).toFixed(2);
            const minimumWithdrawalUsd = (MIN_WITHDRAWAL_POINTS / 100000).toFixed(2);
            const withdrawalHistory = (state.user.history || []).filter(h => h.action.includes('Withdrawal')).slice(-5).reverse();

            return `
                <section class="space-y-6 fade-in">
                    <h2 class="text-2xl font-bold">Withdraw EduPoints</h2>
                    
                    <!-- Balance Overview -->
                    <div class="card p-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div>
                                <p class="text-sm opacity-90">Your Current Balance</p>
                                <h3 class="text-4xl font-extrabold mt-1">${formatPoints(eduPoints)}</h3>
                                <p class="text-lg font-medium mt-2">~ $${usdEquivalent} USD</p>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                                    <p class="text-sm">Minimum Withdrawal</p>
                                    <p class="text-lg font-bold">${formatPoints(MIN_WITHDRAWAL_POINTS)} Pts</p>
                                    <p class="text-sm">$${minimumWithdrawalUsd} USD</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Withdrawal Form -->
                    <div class="card p-6 space-y-5">
                        <h3 class="text-xl font-semibold">Submit Withdrawal Request</h3>

                        <div id="withdrawal-message" class="hidden p-4 rounded-lg text-sm font-semibold"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Withdrawal Amount (Points)</label>
                                <input type="number" id="withdrawal-amount" placeholder="e.g. ${MIN_WITHDRAWAL_POINTS}" min="${MIN_WITHDRAWAL_POINTS}" value="${canWithdraw ? MIN_WITHDRAWAL_POINTS : ''}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" ${!canWithdraw ? 'disabled' : ''}>
                                <p class="text-xs text-gray-500 mt-1">Minimum: ${formatPoints(MIN_WITHDRAWAL_POINTS)} points</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                                <select id="withdrawal-method" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" ${!canWithdraw ? 'disabled' : ''}>
                                    <option value="USDT TRC20">USDT (TRC20)</option>
                                    <option value="Paystack">Paystack (Nigeria Only)</option>
                                    <option value="Stripe">Stripe (Global Bank Transfer)</option>
                                    <option value="PayPal">PayPal</option>
                                    <option value="Skrill">Skrill</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Address / Account Details</label>
                            <textarea id="withdrawal-details" rows="3" placeholder="USDT Wallet Address, or Bank/Paystack/Stripe details..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" ${!canWithdraw ? 'disabled' : ''}></textarea>
                        </div>

                        <button id="submit-withdrawal-btn" class="w-full p-4 font-bold rounded-lg transition ${canWithdraw ? 'btn-primary shadow-md hover:shadow-lg' : 'bg-gray-300 text-gray-600 cursor-not-allowed'}" ${!canWithdraw ? 'disabled' : ''}>
                            ${canWithdraw ? `
                                <i class="fas fa-paper-plane mr-2"></i> Submit Withdrawal Request to eduhetech@gmail.com
                            ` : 'Insufficient Points'}
                        </button>
                    </div>

                    <!-- Payout History -->
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4">Withdrawal History</h3>
                        <div class="space-y-4">
                            ${withdrawalHistory.length > 0 ? withdrawalHistory.map(item => `
                                <div class="flex justify-between items-center p-3 border-b border-gray-100 last:border-b-0">
                                    <div>
                                        <p class="font-medium text-gray-800">${item.action.replace('Withdrawal Request:', '').trim()}</p>
                                        <p class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleDateString()}</p>
                                    </div>
                                    <span class="font-bold text-red-600">-${formatPoints(Math.abs(item.points))} Pts</span>
                                </div>
                            `).join('') : `
                                <div class="text-center py-6 text-gray-500">
                                    <i class="fas fa-history text-3xl mb-3"></i>
                                    <p>No withdrawal history yet</p>
                                </div>
                            `}
                        </div>
                    </div>
                </section>
            `;
        }

        // --- Enhanced Leaderboard View ---
        function renderLeaderboard() {
            return `
                <section class="space-y-6 fade-in">
                    <h2 class="text-2xl font-bold">EduHeTech Leaderboard</h2>
                    <p class="text-gray-600">Top learners by Total EduPoints. (Based on users stored in this browser's local storage).</p>

                    <div class="card p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Rank</th>
                                        <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">User</th>
                                        <th class="text-right py-3 px-4 text-sm font-medium text-gray-500">Points</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.leaderboard.map((user, index) => `
                                        <tr class="border-b border-gray-100 last:border-b-0 hover:bg-gray-50 transition">
                                            <td class="py-4 px-4">
                                                <div class="flex items-center">
                                                    <div class="w-8 h-8 rounded-full flex items-center justify-center ${index === 0 ? 'bg-yellow-100 text-yellow-600' : index === 1 ? 'bg-gray-100 text-gray-600' : index === 2 ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'}">
                                                        ${index === 0 ? '<i class="fas fa-crown"></i>' : index + 1}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="py-4 px-4">
                                                <div class="flex items-center space-x-3">
                                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                                        <i class="fas fa-user text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <p class="font-medium text-gray-900">${user.name}</p>
                                                        <p class="text-xs text-gray-500">${user.email}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="py-4 px-4 text-right">
                                                <span class="font-bold text-lg ${index === 0 ? 'text-yellow-600' : index === 1 ? 'text-gray-600' : index === 2 ? 'text-orange-600' : 'text-blue-600'}">${formatPoints(user.eduPoints)}</span>
                                                <p class="text-xs text-gray-500">Pts</p>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            `;
        }

        // --- New Achievements Section View ---
        function renderAchievementsSection() {
            const achievements = getAchievements();
            const earnedCount = achievements.filter(a => a.earned).length;
            const totalCount = achievements.length;
            const progress = totalCount > 0 ? (earnedCount / totalCount) * 100 : 0;

            return `
                <section class="space-y-6 fade-in">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h2 class="text-2xl font-bold">Achievements</h2>
                        <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                            <div class="text-sm text-gray-600">
                                <span class="font-semibold">${earnedCount}</span> of <span class="font-semibold">${totalCount}</span> unlocked
                            </div>
                            <div class="w-32 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-600">Complete challenges to unlock achievements and earn bonus points!</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${achievements.map(achievement => {
                            const typeColors = {
                                bronze: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                                silver: 'bg-gray-100 text-gray-800 border-gray-200',
                                gold: 'bg-yellow-50 text-yellow-800 border-yellow-300',
                                platinum: 'bg-blue-100 text-blue-800 border-blue-200'
                            };
                            
                            return `
                                <div class="card p-5 flex flex-col h-full ${achievement.earned ? 'border-l-4 border-green-500 bg-green-50' : ''} transition-all hover:shadow-md">
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start mb-3">
                                            <div class="w-12 h-12 rounded-full ${achievement.earned ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'} flex items-center justify-center">
                                                <i class="${achievement.icon} text-xl"></i>
                                            </div>
                                            <span class="text-xs font-medium px-2 py-1 rounded-full ${typeColors[achievement.type] || 'bg-gray-100 text-gray-800'}">
                                                ${achievement.type}
                                            </span>
                                        </div>
                                        <h3 class="font-bold text-lg mb-2">${achievement.name}</h3>
                                        <p class="text-sm text-gray-600 mb-3">${achievement.description}</p>
                                    </div>
                                    
                                    <div class="mt-auto">
                                        <div class="flex justify-between items-center text-xs text-gray-500 mb-2">
                                            <span>Progress</span>
                                            <span>${achievement.progress.toFixed(0)}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="h-2 rounded-full transition-all duration-500 ${achievement.earned ? 'bg-green-500' : 'bg-blue-500'}" style="width: ${achievement.progress}%"></div>
                                        </div>
                                        <div class="flex justify-between items-center mt-3">
                                            ${achievement.earned ? `
                                                <span class="text-green-600 font-bold text-sm flex items-center">
                                                    <i class="fas fa-check-circle mr-1"></i> Unlocked!
                                                </span>
                                            ` : `
                                                <span class="text-gray-500 text-sm">Keep going!</span>
                                            `}
                                            <span class="text-yellow-600 font-bold text-sm flex items-center">
                                                <i class="fas fa-coins mr-1"></i> +${achievement.points || 0}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </section>
            `;
        }

        // --- Enhanced Event Handlers ---

        function attachAuthListeners() {
            const container = document.getElementById('auth-form-container');
            const toggleBtn = document.getElementById('toggle-auth');
            let isLogin = true;

            const updateForm = () => {
                container.innerHTML = isLogin ? renderLoginForm() : renderSignupForm();
                toggleBtn.textContent = isLogin ? 'Need an account? Sign Up' : 'Already have an account? Log In';
                attachFormListeners();
            };

            const attachFormListeners = () => {
                document.getElementById('login-btn')?.addEventListener('click', handleLogin);
                document.getElementById('signup-btn')?.addEventListener('click', handleSignup);
                
                // Add enter key support
                document.getElementById('login-email')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
                document.getElementById('login-password')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
                document.getElementById('signup-name')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSignup();
                });
                document.getElementById('signup-email')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSignup();
                });
                document.getElementById('signup-password')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSignup();
                });
            };

            toggleBtn?.addEventListener('click', () => {
                isLogin = !isLogin;
                updateForm();
            });

            updateForm();
        }

        function handleAuthError(message) {
            const errorEl = document.getElementById('auth-error-message');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('slide-in');
                setTimeout(() => errorEl.classList.remove('slide-in'), 500);
            }
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                handleAuthError('Please fill in all fields.');
                return;
            }

            const allUsers = loadAllUsers();
            const user = Object.values(allUsers).find(u => u.email === email && u.password === password);

            if (user) {
                sessionStorage.setItem(SS_CURRENT_USER_ID, user.userId);
                initializeData();
            } else {
                handleAuthError('Login failed: Invalid email or password.');
            }
        }

        function handleSignup() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const referrerId = document.getElementById('signup-referral').value;

            if (!name || !email || password.length < 6) {
                handleAuthError('Please fill out all fields and ensure the password is at least 6 characters.');
                return;
            }

            const allUsers = loadAllUsers();
            if (Object.values(allUsers).some(u => u.email === email)) {
                handleAuthError('This email is already registered.');
                return;
            }

            const newUserId = generateUniqueId();
            const newUser = {
                userId: newUserId,
                name: name,
                email: email,
                password: password,
                eduPoints: 0,
                referralCount: 0,
                referralCode: newUserId,
                lastLogin: Date.now(),
                loginDates: [new Date().toDateString()],
                history: [],
                achievements: [],
                createdAt: Date.now()
            };

            allUsers[newUserId] = newUser;
            saveAllUsers(allUsers);

            // Handle referral bonus for the referrer
            if (referrerId && allUsers[referrerId]) {
                rewardPoints(referrerId, BASE_POINTS_REWARDS.referral, 'Referral Bonus');
                trackReferral(referrerId);
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-check-circle text-5xl text-green-500"></i>
                        <h3 class="text-xl font-bold text-green-600">Success!</h3>
                        <p class="text-gray-600">${name}, your account is created. Your referrer has been rewarded!</p>
                    </div>
                `, () => {
                    // Auto-hide modal after showing success
                    setTimeout(hideModal, 2000);
                });
            } else {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-check-circle text-5xl text-green-500"></i>
                        <h3 class="text-xl font-bold text-green-600">Account Created</h3>
                        <p class="text-gray-600">Welcome ${name}! You can now log in.</p>
                    </div>
                `, () => {
                    // Auto-hide modal after showing success
                    setTimeout(hideModal, 2000);
                });
            }

            // Log in the new user automatically
            sessionStorage.setItem(SS_CURRENT_USER_ID, newUserId);
            initializeData();
        }

        function handleLogout() {
            showModal(`
                <div class="text-center space-y-3">
                    <i class="fas fa-sign-out-alt text-5xl text-blue-500"></i>
                    <h3 class="text-xl font-bold">Log Out</h3>
                    <p class="text-gray-600">Are you sure you want to log out?</p>
                </div>
            `, () => {
                sessionStorage.removeItem(SS_CURRENT_USER_ID);
                state.user = null;
                state.currentView = 'auth';
                render();
            });
        }

        function attachNavListeners() {
            // Navigation items
            document.querySelectorAll('.nav-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const newView = e.currentTarget.dataset.view;
                    if (newView) {
                        state.currentView = newView;
                        state.quizData = null; // Reset quiz data when navigating away
                        render();
                        // Push state to update browser history
                        window.history.pushState({ view: newView }, '', window.location.pathname);
                    }
                });
            });
            
            // Logout button
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            
            // Notification button
            document.getElementById('notification-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                const panel = document.getElementById('notification-panel');
                panel.classList.toggle('hidden');
            });
            
            // Menu toggle for mobile
            document.getElementById('menu-toggle')?.addEventListener('click', () => {
                const sidebar = document.querySelector('aside');
                sidebar?.classList.toggle('hidden');
            });
            
            // More menu for mobile
            document.getElementById('more-menu-btn')?.addEventListener('click', () => {
                showModal(`
                    <div class="space-y-3">
                        <h3 class="text-lg font-bold text-center mb-4">More Options</h3>
                        ${[
                            { id: 'achievements', icon: 'fas fa-medal', label: 'Achievements' },
                            { id: 'leaderboard', icon: 'fas fa-trophy', label: 'Leaderboard' }
                        ].map(item => `
                            <button data-view="${item.id}" class="w-full flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-50 text-gray-700 transition-colors">
                                <i class="${item.icon} w-5 text-center text-blue-500"></i>
                                <span>${item.label}</span>
                            </button>
                        `).join('')}
                    </div>
                `);
                
                // Re-attach navigation listeners for modal buttons
                setTimeout(() => {
                    document.querySelectorAll('[data-view]').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const newView = e.currentTarget.dataset.view;
                            if (newView) {
                                state.currentView = newView;
                                hideModal();
                                render();
                                // Push state to update browser history
                                window.history.pushState({ view: newView }, '', window.location.pathname);
                            }
                        });
                    });
                }, 100);
            });
            
            // Close notification panel when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#notification-panel') && !e.target.closest('#notification-btn')) {
                    document.getElementById('notification-panel')?.classList.add('hidden');
                }
            });
        }

        function attachNotificationListeners() {
            // Mark all as read
            document.getElementById('mark-all-read')?.addEventListener('click', () => {
                state.notifications.forEach(n => n.read = true);
                updateNotificationBadge();
                updateNotifications();
            });
            
            // Mark individual notifications as read when clicked
            document.querySelectorAll('#notification-panel [class*="bg-blue-50"]').forEach(notificationEl => {
                notificationEl.addEventListener('click', () => {
                    // In a real app, you would mark the specific notification as read
                    updateNotificationBadge();
                });
            });
        }

        function attachContentListeners() {
            // Learn Section
            document.querySelectorAll('.view-course-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleViewCourse(e.currentTarget.dataset.lessonId));
            });
            
            // Quiz Section
            document.querySelectorAll('.start-quiz-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleStartQuiz(e.currentTarget.dataset.quizId));
            });
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.addEventListener('click', (e) => handleQuizOption(e.currentTarget.dataset.option));
            });
            document.getElementById('prev-q-btn')?.addEventListener('click', () => updateQuizView(-1));
            document.getElementById('next-q-btn')?.addEventListener('click', () => updateQuizView(1));
            document.getElementById('submit-quiz-btn')?.addEventListener('click', handleSubmitQuiz);
            document.getElementById('retry-quiz-btn')?.addEventListener('click', handleRetryQuiz);
            document.getElementById('next-quiz-btn')?.addEventListener('click', handleNextQuiz);
            
            // Ads Section
            document.getElementById('watch-ad-btn')?.addEventListener('click', handleWatchAd);
            
            // Referral Section
            document.getElementById('copy-referral-btn')?.addEventListener('click', handleCopyReferralLink);
            
            // Rewards Section
            document.getElementById('submit-withdrawal-btn')?.addEventListener('click', handleSubmitWithdrawal);
            
            // Quick action buttons
            document.querySelectorAll('[data-view]').forEach(btn => {
                if (btn.classList.contains('nav-item')) return; // Skip nav items already handled
                btn.addEventListener('click', (e) => {
                    const view = e.currentTarget.dataset.view;
                    if (view) {
                        state.currentView = view;
                        render();
                        // Push state to update browser history
                        window.history.pushState({ view: view }, '', window.location.pathname);
                    }
                });
            });
        }

        function attachCourseDetailListeners() {
            document.getElementById('back-to-courses')?.addEventListener('click', () => {
                state.currentView = 'learn';
                render();
                // Push state to update browser history
                window.history.pushState({ view: 'learn' }, '', window.location.pathname);
            });
            
            document.getElementById('complete-course-btn')?.addEventListener('click', handleCompleteCourse);
        }

        function handleViewCourse(lessonId) {
            const course = state.lessons.find(l => l.id === lessonId);
            if (course) {
                state.currentCourse = course;
                state.currentView = 'course-detail';
                render();
                // Push state to update browser history
                window.history.pushState({ view: 'course-detail', courseId: lessonId }, '', window.location.pathname);
            }
        }

        function handleCompleteCourse() {
            if (!state.currentCourse) return;
            
            const { title, points } = state.currentCourse;
            const action = `Lesson Completed: ${title}`;
            
            if ((state.user.history || []).some(h => h.action === action)) {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-check-circle text-5xl text-yellow-500"></i>
                        <h3 class="text-xl font-bold text-yellow-600">Already Completed</h3>
                        <p class="text-gray-600">You have already completed this course and received the reward.</p>
                    </div>
                `, () => {
                    // Auto-hide modal
                    setTimeout(hideModal, 2000);
                });
                return;
            }
            
            // Open Monetag smartlink in new tab
            const adLink = MONETAG_LINKS[Math.floor(Math.random() * MONETAG_LINKS.length)];
            const adWindow = window.open(adLink, '_blank');
            
            showModal(`
                <div class="text-center space-y-4">
                    <i class="fas fa-external-link-alt text-5xl text-blue-500"></i>
                    <h3 class="text-xl font-bold">Redirecting to Ad</h3>
                    <p class="text-gray-600">Please wait while we redirect you to the advertisement.</p>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-fill" class="h-2 bg-green-500 rounded-full transition-all duration-10000" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-500">Please stay on the ad page for 10 seconds to earn your reward.</p>
                    <p id="countdown" class="text-lg font-bold text-red-500">10 seconds remaining</p>
                </div>
            `);

            let seconds = 10;
            const countdownEl = document.getElementById('countdown');
            const progressEl = document.getElementById('progress-fill');
            
            const countdown = setInterval(() => {
                seconds--;
                if (countdownEl) countdownEl.textContent = `${seconds} second${seconds !== 1 ? 's' : ''} remaining`;
                if (progressEl) progressEl.style.width = `${((10 - seconds) / 10) * 100}%`;
                
                if (seconds <= 0) {
                    clearInterval(countdown);
                    hideModal();
                    adWindow?.close();
                    
                    // Award points after ad viewing
                    addPoints(action, points);
                    
                    showModal(`
                        <div class="text-center space-y-3">
                            <i class="fas fa-check-circle text-5xl text-green-500"></i>
                            <h3 class="text-xl font-bold text-green-600">Course Complete!</h3>
                            <p class="text-gray-600">You earned ${points} EduPoints for completing "${title}".</p>
                        </div>
                    `, () => {
                        // Auto-hide modal after showing success
                        setTimeout(hideModal, 2000);
                    });
                    
                    // Return to courses list
                    state.currentView = 'learn';
                    render();
                    // Push state to update browser history
                    window.history.pushState({ view: 'learn' }, '', window.location.pathname);
                }
            }, 1000);
        }

        function handleStartQuiz(quizId) {
            const quiz = state.quizzes.find(q => q.id === quizId) || state.quizzes[0];
            state.quizData = { 
                id: quiz.id, 
                answers: Array(quiz.questions.length).fill(null), 
                isComplete: false, 
                results: null, 
                currentQ: 0,
                startTime: Date.now()
            };
            render();
            // Push state to update browser history
            window.history.pushState({ view: 'quiz-detail', quizId: quizId }, '', window.location.pathname);
        }

        function handleQuizOption(option) {
            if (state.quizData.results) return;
            state.quizData.answers[state.quizData.currentQ] = option;
            render();
        }

        function updateQuizView(direction) {
            state.quizData.currentQ += direction;
            render();
        }

        function handleSubmitQuiz() {
            const currentQuiz = state.quizzes.find(q => q.id === state.quizData.id) || state.quizzes[0];
            if (!currentQuiz || !state.quizData.answers.every(a => a !== null)) {
                showModal(`
                    <div class="text-center space-y-3">
                        <i class="fas fa-exclamation-circle text-5xl text-red-500"></i>
                        <h3 class="text-xl font-bold text-red-600">Incomplete Quiz</h3>
                        <p class="text-gray-600">Please answer all questions before submitting.</p>
                    </div>
                `, () => {
                    // Auto-hide modal
                    setTimeout(hideModal, 2000);
                });
                return;
            }

            showModal(`
                <div class="text-center space-y-4">
                    <i class="fas fa-spinner fa-spin text-5xl text-blue-500"></i>
                    <h3 class="text-xl font-bold">Processing Results</h3>
                    <p class="text-gray-600">Please wait while we calculate your score...</p>
                </div>
            `);

            // Simulate processing time
            setTimeout(() => {
                hideModal();
                processQuizResults(currentQuiz);
            }, 1500);
        }

        function processQuizResults(quiz) {
            const results = quiz.questions.map((q, index) => ({
                isCorrect: q.answer === state.quizData.answers[index],
                correctAnswer: q.answer,
                userAnswer: state.quizData.answers[index]
            }));

            state.quizData.isComplete = true;
            state.quizData.results = results;

            const correctCount = results.filter(r => r.isCorrect).length;
            const percentage = (correctCount / quiz.questions.length) * 100;
            
            // Only award points if passed (70% or higher)
            if (percentage >= 70) {
                addPoints(`Quiz Completed: ${quiz.title} (${correctCount}/${quiz.questions.length})`, BASE_POINTS_REWARDS.quiz);
            }

            render();
        }

        function handleRetryQuiz() {
            const currentQuiz = state.quizzes.find(q => q.id === state.quizData.id) || state.quizzes[0];
            state.quizData = { 
                id: currentQuiz.id, 
                answers: Array(currentQuiz.questions.length).fill(null), 
                isComplete: false, 
                results: null, 
                currentQ: 0,
                startTime: Date.now()
            };
            render();
        }

        function handleNextQuiz() {
            state.quizData = null;
            state.currentView = 'quiz';
            render();
            // Push state to update browser history
            window.history.pushState({ view: 'quiz' }, '', window.location.pathname);
        }

        function handleWatchAd() {
            const adLink = MONETAG_LINKS[Math.floor(Math.random() * MONETAG_LINKS.length)];
            const adWindow = window.open(adLink, '_blank');
            const adBtn = document.getElementById('watch-ad-btn');
            const adStatus = document.getElementById('ad-status');

            if (adBtn) adBtn.disabled = true;
            if (adStatus) {
                adStatus.innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-blue-600">
                        <div class="loader"></div>
                        <span>Loading Ad... Please wait 10 seconds.</span>
                    </div>
                `;
            }

            showModal(`
                <div class="text-center space-y-4">
                    <i class="fas fa-stopwatch text-5xl text-blue-500"></i>
                    <h3 class="text-xl font-bold">Ad View Timer</h3>
                    <p class="text-gray-600">You will be rewarded in <span id="ad-timer" class="font-bold text-red-500">10</span> seconds.</p>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-fill" class="h-2 bg-green-500 rounded-full transition-all duration-10000" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-500">Please do not close the ad window yet.</p>
                </div>
            `);

            let timer = 10;
            const interval = setInterval(() => {
                timer--;
                const timerEl = document.getElementById('ad-timer');
                const progressEl = document.getElementById('progress-fill');
                if (timerEl) timerEl.textContent = timer;
                if (progressEl) progressEl.style.width = `${((10 - timer) / 10) * 100}%`;

                if (timer <= 0) {
                    clearInterval(interval);
                    hideModal();
                    adWindow?.close();
                    handleAdReward(adBtn, adStatus);
                }
            }, 1000);
        }

        function handleAdReward(btn, status) {
            addPoints('Ad Watched', BASE_POINTS_REWARDS.ad);
            if (btn) btn.disabled = false;
            if (status) {
                status.innerHTML = `
                    <div class="text-green-600 font-semibold text-center">
                        <i class="fas fa-check-circle mr-2"></i> Reward successful! +${BASE_POINTS_REWARDS.ad} EduPoints earned.
                    </div>
                `;
            }
            setTimeout(() => { 
                if (status) status.textContent = ''; 
            }, 5000);
        }

        function handleCopyReferralLink() {
            const input = document.getElementById('referral-link-input');
            const status = document.getElementById('copy-status');

            if (input) {
                input.select();
                document.execCommand('copy');
                status.textContent = 'Copied to clipboard!';
                status.classList.add('slide-in');
                setTimeout(() => {
                    status.textContent = '';
                    status.classList.remove('slide-in');
                }, 2000);
            }
        }

        function handleSubmitWithdrawal() {
            const amountEl = document.getElementById('withdrawal-amount');
            const methodEl = document.getElementById('withdrawal-method');
            const detailsEl = document.getElementById('withdrawal-details');
            const messageEl = document.getElementById('withdrawal-message');

            const amount = parseInt(amountEl.value);
            const method = methodEl.value;
            const details = detailsEl.value.trim();

            if (!amount || amount < MIN_WITHDRAWAL_POINTS || amount > state.user.eduPoints || !details) {
                messageEl.textContent = 'Please enter a valid amount (min 100k) and payment details.';
                messageEl.className = 'p-4 rounded-lg text-sm font-semibold bg-red-100 text-red-700';
                messageEl.classList.remove('hidden');
                return;
            }

            showModal(`
                <div class="text-center space-y-4">
                    <i class="fas fa-hand-holding-usd text-5xl text-yellow-500"></i>
                    <h3 class="text-xl font-bold">Confirm Withdrawal</h3>
                    <p class="text-gray-600">Are you sure you want to withdraw <span class="font-bold">${formatPoints(amount)}</span> EduPoints ($${(amount / 100000).toFixed(2)}) via <span class="font-bold">${method}</span>?</p>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-left">
                        <p class="text-sm text-yellow-800"><i class="fas fa-info-circle mr-1"></i> Your withdrawal request will be sent to eduhetech@gmail.com for manual processing.</p>
                    </div>
                </div>
            `, () => {
                showLoading(true);
                try {
                    // Create Withdrawal Request in Local Storage
                    const withdrawalRequest = {
                        id: generateUniqueId(),
                        userId: state.user.userId,
                        userName: state.user.name,
                        amount: amount,
                        method: method,
                        details: details,
                        status: 'Pending',
                        timestamp: Date.now()
                    };
                    state.withdrawalRequests.push(withdrawalRequest);
                    saveCollection(LS_WITHDRAWALS, state.withdrawalRequests);

                    // Deduct Points from User
                    state.user.eduPoints -= amount;
                    if (!state.user.history) state.user.history = [];
                    state.user.history.push({ action: `Withdrawal Request: ${method}`, points: -amount, timestamp: Date.now() });

                    saveUser(state.user);

                    // Create email content
                    const emailSubject = `Withdrawal Request - ${state.user.name}`;
                    const emailBody = `
User: ${state.user.name} (${state.user.email})
Amount: ${formatPoints(amount)} EduPoints ($${(amount / 100000).toFixed(2)})
Payment Method: ${method}
Payment Details: ${details}
Request ID: ${withdrawalRequest.id}
Timestamp: ${new Date().toLocaleString()}
                    `.trim();

                    // Create mailto link
                    const mailtoLink = `mailto:eduhetech@gmail.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                    
                    // Open email client
                    window.open(mailtoLink, '_blank');

                    // Update local state and UI
                    messageEl.textContent = 'Withdrawal request submitted! An email has been opened for you to send the request to eduhetech@gmail.com.';
                    messageEl.className = 'p-4 rounded-lg text-sm font-semibold bg-green-100 text-green-700';
                    messageEl.classList.remove('hidden');
                    
                    render();
                } catch (error) {
                    messageEl.textContent = `Error submitting request: ${error.message}`;
                    messageEl.className = 'p-4 rounded-lg text-sm font-semibold bg-red-100 text-red-700';
                    messageEl.classList.remove('hidden');
                    console.error("Withdrawal error:", error);
                } finally {
                    showLoading(false);
                }
            });
        }

        // --- Browser Back Button Handling ---
        window.addEventListener('popstate', function(event) {
            // If we have state data, use it to restore the view
            if (event.state && event.state.view) {
                state.currentView = event.state.view;
                
                // Handle specific views that need additional data
                if (event.state.view === 'course-detail' && event.state.courseId) {
                    const course = state.lessons.find(l => l.id === event.state.courseId);
                    if (course) {
                        state.currentCourse = course;
                    } else {
                        state.currentView = 'learn'; // Fallback if course not found
                    }
                }
                
                // Reset quiz data when navigating away from quiz
                if (event.state.view !== 'quiz' && event.state.view !== 'quiz-detail') {
                    state.quizData = null;
                }
                
                render();
            } else {
                // Default to dashboard if no state
                state.currentView = 'dashboard';
                state.quizData = null;
                render();
            }
        });

        // --- Initialization ---

        // Start the application lifecycle
        window.onload = initializeData;

    </script>

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="loader"></div>
    </div>

    <!-- Global Modal Structure -->
    <div id="global-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4 z-40">
        <div class="card w-full max-w-sm p-6 space-y-4 slide-in">
            <div id="modal-content"></div>
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" onclick="hideModal()" class="p-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm" class="p-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition hidden">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Application Root -->
    <div id="app">
        <!-- Content rendered by JavaScript -->
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-500">Initializing EduHeTech...</p>
            </div>
        </div>
    </div>
</body>
</html>
