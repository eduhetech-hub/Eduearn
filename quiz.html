                    },
                        {
                            id: 3,
                            question: 'Which of these is a JavaScript framework?',
                            options: [
                                'Django',
                                'Laravel',
                                'React',
                                'Flask'
                            ],
                            correctAnswer: 'React',
                            explanation: 'React is a popular JavaScript library for building user interfaces, often considered a framework.'
                        },
                        {
                            id: 4,
                            question: 'What is the purpose of the "alt" attribute in an image tag?',
                            options: [
                                'To add a title to the image',
                                'To provide alternative text for accessibility',
                                'To set the image alignment',
                                'To specify the image source'
                            ],
                            correctAnswer: 'To provide alternative text for accessibility',
                            explanation: 'The "alt" attribute provides alternative text for screen readers and when images cannot be displayed.'
                        },
                        {
                            id: 5,
                            question: 'Which CSS property is used to change the text color?',
                            options: [
                                'text-color',
                                'font-color',
                                'color',
                                'text-style'
                            ],
                            correctAnswer: 'color',
                            explanation: 'The "color" property in CSS is used to set the color of text.'
                        }
                    ]
                },
                {
                    id: 'tech-2',
                    category: 'technology',
                    title: 'JavaScript Fundamentals',
                    description: 'Test your knowledge of JavaScript programming concepts',
                    difficulty: 'Intermediate',
                    duration: 7,
                    questions: [
                        {
                            id: 1,
                            question: 'What will "typeof null" return in JavaScript?',
                            options: [
                                'null',
                                'undefined',
                                'object',
                                'number'
                            ],
                            correctAnswer: 'object',
                            explanation: 'This is a known quirk in JavaScript - typeof null returns "object".'
                        },
                        {
                            id: 2,
                            question: 'Which method is used to add an element to the end of an array?',
                            options: [
                                'push()',
                                'pop()',
                                'shift()',
                                'unshift()'
                            ],
                            correctAnswer: 'push()',
                            explanation: 'The push() method adds one or more elements to the end of an array.'
                        },
                        {
                            id: 3,
                            question: 'What is the purpose of "use strict" in JavaScript?',
                            options: [
                                'To enable strict mode for catching common coding errors',
                                'To make the code run faster',
                                'To enable new JavaScript features',
                                'To improve code readability'
                            ],
                            correctAnswer: 'To enable strict mode for catching common coding errors',
                            explanation: '"use strict" enables strict mode which helps catch common coding errors and unsafe actions.'
                        },
                        {
                            id: 4,
                            question: 'Which of these is NOT a JavaScript data type?',
                            options: [
                                'boolean',
                                'number',
                                'character',
                                'symbol'
                            ],
                            correctAnswer: 'character',
                            explanation: 'JavaScript has string type, not character type. Other primitive types are boolean, number, symbol, etc.'
                        },
                        {
                            id: 5,
                            question: 'What does the "=== " operator do?',
                            options: [
                                'Compares values only',
                                'Compares values and types',
                                'Assigns a value',
                                'Checks for null values'
                            ],
                            correctAnswer: 'Compares values and types',
                            explanation: 'The "===" operator is the strict equality operator that compares both value and type.'
                        }
                    ]
                },
                // Health Quizzes
                {
                    id: 'health-1',
                    category: 'health',
                    title: 'Nutrition Basics',
                    description: 'Test your knowledge of nutrition and healthy eating',
                    difficulty: 'Beginner',
                    duration: 5,
                    questions: [
                        {
                            id: 1,
                            question: 'Which vitamin is produced when the skin is exposed to sunlight?',
                            options: [
                                'Vitamin A',
                                'Vitamin C',
                                'Vitamin D',
                                'Vitamin K'
                            ],
                            correctAnswer: 'Vitamin D',
                            explanation: 'Vitamin D is produced in the skin in response to sunlight exposure.'
                        },
                        {
                            id: 2,
                            question: 'Which of these is a complex carbohydrate?',
                            options: [
                                'White bread',
                                'Table sugar',
                                'Whole grains',
                                'Honey'
                            ],
                            correctAnswer: 'Whole grains',
                            explanation: 'Whole grains are complex carbohydrates that provide sustained energy and fiber.'
                        },
                        {
                            id: 3,
                            question: 'What is the primary function of protein in the body?',
                            options: [
                                'Provide quick energy',
                                'Build and repair tissues',
                                'Store vitamins',
                                'Regulate body temperature'
                            ],
                            correctAnswer: 'Build and repair tissues',
                            explanation: 'Proteins are essential for building and repairing tissues, enzymes, and hormones.'
                        },
                        {
                            id: 4,
                            question: 'Which mineral is important for bone health?',
                            options: [
                                'Iron',
                                'Calcium',
                                'Sodium',
                                'Potassium'
                            ],
                            correctAnswer: 'Calcium',
                            explanation: 'Calcium is crucial for building and maintaining strong bones and teeth.'
                        },
                        {
                            id: 5,
                            question: 'How much water should an average adult drink daily?',
                            options: [
                                '1-2 cups',
                                '4-6 cups',
                                '8-10 cups',
                                '12-15 cups'
                            ],
                            correctAnswer: '8-10 cups',
                            explanation: 'The general recommendation is about 8-10 cups (2-2.5 liters) of water per day for adults.'
                        }
                    ]
                },
                // Business Quizzes
                {
                    id: 'business-1',
                    category: 'business',
                    title: 'Entrepreneurship Fundamentals',
                    description: 'Test your knowledge of business and entrepreneurship concepts',
                    difficulty: 'Beginner',
                    duration: 5,
                    questions: [
                        {
                            id: 1,
                            question: 'What does MVP stand for in business?',
                            options: [
                                'Most Valuable Product',
                                'Minimum Viable Product',
                                'Maximum Value Proposition',
                                'Main Venture Plan'
                            ],
                            correctAnswer: 'Minimum Viable Product',
                            explanation: 'MVP stands for Minimum Viable Product - a product with just enough features to satisfy early customers.'
                        },
                        {
                            id: 2,
                            question: 'What is a business plan?',
                            options: [
                                'A marketing strategy',
                                'A financial document',
                                'A written document describing business goals and strategies',
                                'A legal agreement'
                            ],
                            correctAnswer: 'A written document describing business goals and strategies',
                            explanation: 'A business plan is a formal written document containing business goals and how to achieve them.'
                        },
                        {
                            id: 3,
                            question: 'What does ROI stand for?',
                            options: [
                                'Return on Investment',
                                'Rate of Interest',
                                'Risk of Investment',
                                'Revenue on Income'
                            ],
                            correctAnswer: 'Return on Investment',
                            explanation: 'ROI stands for Return on Investment, a performance measure to evaluate efficiency.'
                        },
                        {
                            id: 4,
                            question: 'What is the primary purpose of marketing?',
                            options: [
                                'To create products',
                                'To manage finances',
                                'To identify and satisfy customer needs',
                                'To hire employees'
                            ],
                            correctAnswer: 'To identify and satisfy customer needs',
                            explanation: 'Marketing focuses on identifying customer needs and developing products/services to meet them.'
                        },
                        {
                            id: 5,
                            question: 'What is cash flow?',
                            options: [
                                'The total revenue of a business',
                                'The movement of money in and out of a business',
                                'The profit after expenses',
                                'The value of company assets'
                            ],
                            correctAnswer: 'The movement of money in and out of a business',
                            explanation: 'Cash flow refers to the net amount of cash being transferred into and out of a business.'
                        }
                    ]
                }
            ]
        };

        // Application State
        const state = {
            user: null,
            currentView: 'categories',
            currentQuiz: null,
            currentQuestion: 0,
            userAnswers: [],
            quizScore: 0,
            quizCompleted: false,
            points: 0,
            completedQuizzes: JSON.parse(localStorage.getItem('completedQuizzes')) || [],
            isLoading: false
        };

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        function showLoading(show) {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        function showModal(content, onConfirm = null, onCancel = null) {
            const modal = document.getElementById('global-modal');
            const modalContent = document.getElementById('modal-content');
            const modalConfirm = document.getElementById('modal-confirm');
            const modalCancel = document.getElementById('modal-cancel');

            if (!modal || !modalContent) return;

            modalContent.innerHTML = content;
            modal.classList.remove('hidden');

            if (onConfirm) {
                modalConfirm.classList.remove('hidden');
                modalConfirm.onclick = () => {
                    onConfirm();
                    modal.classList.add('hidden');
                    modalConfirm.onclick = null;
                };
            } else {
                modalConfirm.classList.add('hidden');
                modalConfirm.onclick = null;
            }

            if (onCancel) {
                modalCancel.classList.remove('hidden');
                modalCancel.onclick = () => {
                    onCancel();
                    modal.classList.add('hidden');
                    modalCancel.onclick = null;
                };
            } else {
                modalCancel.classList.add('hidden');
                modalCancel.onclick = null;
            }
        }

        function hideModal() {
            document.getElementById('global-modal').classList.add('hidden');
        }

        function formatPoints(points) {
            return points?.toLocaleString() || '0';
        }

        // =====================================================
        // POINTS SYNCHRONIZATION WITH MAIN APP
        // =====================================================

        // Check if user is logged in and sync points
        function checkUserAuth() {
            // Try to get user data from localStorage (set by main app)
            const userData = localStorage.getItem('eduhetech_user');
            if (userData) {
                try {
                    state.user = JSON.parse(userData);
                    state.points = state.user.eduPoints || 0;
                    updatePointsDisplay();
                    updateUserInfo();
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
            
            // Also check for pending points to sync
            checkForPendingPoints();
        }

        function updatePointsDisplay() {
            const pointsDisplay = document.getElementById('points-display');
            if (pointsDisplay) {
                pointsDisplay.textContent = formatPoints(state.points);
            }
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');
            const loginBtn = document.getElementById('login-btn');
            
            if (state.user) {
                userInfo.classList.remove('hidden');
                userName.textContent = state.user.name;
                loginBtn.textContent = 'Log Out';
                loginBtn.onclick = handleLogout;
            } else {
                userInfo.classList.add('hidden');
                loginBtn.textContent = 'Log In';
                loginBtn.onclick = redirectToMainApp;
            }
        }

        function redirectToMainApp() {
            window.location.href = 'index.html';
        }

        function handleLogout() {
            state.user = null;
            state.points = 0;
            localStorage.removeItem('eduhetech_user');
            updatePointsDisplay();
            updateUserInfo();
        }

        // Award points for quiz completion
        async function awardQuizPoints(quizId, quizTitle, score) {
            if (state.quizCompleted) return; // Prevent duplicate awards
            
            // Mark quiz as completed locally
            state.quizCompleted = true;
            state.completedQuizzes.push(quizId);
            localStorage.setItem('completedQuizzes', JSON.stringify(state.completedQuizzes));
            
            // Calculate points based on score (bonus for perfect score)
            let pointsEarned = QUIZ_POINTS_REWARD;
            if (score === 100) {
                pointsEarned += 50; // Bonus for perfect score
            }
            
            // Update local points
            state.points += pointsEarned;
            updatePointsDisplay();
            
            // Store pending points for main app to sync
            const pendingPoints = {
                quizId: quizId,
                quizTitle: quizTitle,
                points: pointsEarned,
                score: score,
                timestamp: Date.now()
            };
            
            localStorage.setItem('pendingQuizPoints', JSON.stringify(pendingPoints));
            
            // Try to communicate with main app if it's open
            if (window.opener) {
                try {
                    window.opener.postMessage({
                        type: 'QUIZ_POINTS_AWARDED',
                        quizId: quizId,
                        quizTitle: quizTitle,
                        points: pointsEarned,
                        score: score
                    }, '*');
                } catch (e) {
                    console.log('Main app window not available for direct communication');
                }
            }
            
            return pointsEarned;
        }

        // Check for pending points that need to be synced with main app
        function checkForPendingPoints() {
            const pendingPoints = localStorage.getItem('pendingQuizPoints');
            if (pendingPoints) {
                try {
                    const pointsData = JSON.parse(pendingPoints);
                    console.log('Pending quiz points found:', pointsData);
                    // These will be picked up by the main app
                } catch (e) {
                    console.error('Error parsing pending points:', e);
                }
            }
        }

        // =====================================================
        // QUIZ LOGIC FUNCTIONS
        // =====================================================

        function startQuiz(quizId) {
            const quiz = QUIZ_DATA.quizzes.find(q => q.id === quizId);
            if (!quiz) return;
            
            state.currentQuiz = quiz;
            state.currentQuestion = 0;
            state.userAnswers = [];
            state.quizScore = 0;
            state.quizCompleted = false;
            
            switchView('quiz');
        }

        function selectAnswer(questionIndex, answer) {
            state.userAnswers[questionIndex] = answer;
            
            // Auto-advance to next question after a short delay
            setTimeout(() => {
                if (questionIndex < state.currentQuiz.questions.length - 1) {
                    nextQuestion();
                } else {
                    completeQuiz();
                }
            }, 1500);
        }

        function nextQuestion() {
            if (state.currentQuestion < state.currentQuiz.questions.length - 1) {
                state.currentQuestion++;
                renderQuizQuestion();
            }
        }

        function prevQuestion() {
            if (state.currentQuestion > 0) {
                state.currentQuestion--;
                renderQuizQuestion();
            }
        }

        async function completeQuiz() {
            // Calculate score
            let correctAnswers = 0;
            state.currentQuiz.questions.forEach((question, index) => {
                if (state.userAnswers[index] === question.correctAnswer) {
                    correctAnswers++;
                }
            });
            
            state.quizScore = Math.round((correctAnswers / state.currentQuiz.questions.length) * 100);
            
            // Award points
            const pointsEarned = await awardQuizPoints(
                state.currentQuiz.id, 
                state.currentQuiz.title, 
                state.quizScore
            );
            
            // Show results
            switchView('results');
            
            // Show points animation
            showPointsAnimation(pointsEarned);
        }

        function showPointsAnimation(points) {
            const pointsAnimation = document.createElement('div');
            pointsAnimation.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 points-animation';
            pointsAnimation.innerHTML = `
                <div class="bg-green-500 text-white text-2xl font-bold px-6 py-3 rounded-full shadow-lg">
                    +${points} Points!
                </div>
            `;
            document.body.appendChild(pointsAnimation);
            
            setTimeout(() => {
                if (pointsAnimation.parentNode) {
                    document.body.removeChild(pointsAnimation);
                }
            }, 2000);
        }

        function restartQuiz() {
            if (state.currentQuiz) {
                startQuiz(state.currentQuiz.id);
            }
        }

        function getCategoryColor(categoryId) {
            const category = QUIZ_DATA.categories.find(c => c.id === categoryId);
            return category ? category.color : 'gray';
        }

        function getCategoryIcon(categoryId) {
            const category = QUIZ_DATA.categories.find(c => c.id === categoryId);
            return category ? category.icon : 'fas fa-question';
        }

        function isQuizCompleted(quizId) {
            return state.completedQuizzes.includes(quizId);
        }

        // =====================================================
        // RENDER FUNCTIONS
        // =====================================================

        function switchView(view) {
            state.currentView = view;
            render();
        }

        function render() {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;
            
            let content = '';
            
            switch (state.currentView) {
                case 'categories':
                    content = renderCategories();
                    break;
                case 'quiz':
                    content = renderQuiz();
                    break;
                case 'results':
                    content = renderResults();
                    break;
                default:
                    content = renderCategories();
            }
            
            appContainer.innerHTML = content;
        }

        function renderCategories() {
            return `
                <div class="max-w-6xl mx-auto px-4">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-4">Quiz & Earn</h1>
                        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                            Test your knowledge across various topics and earn ${QUIZ_POINTS_REWARD} points for each completed quiz!
                            Perfect scores earn an additional 50-point bonus.
                        </p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        ${QUIZ_DATA.categories.map(category => {
                            const categoryQuizzes = QUIZ_DATA.quizzes.filter(q => q.category === category.id);
                            const completedCount = categoryQuizzes.filter(q => isQuizCompleted(q.id)).length;
                            
                            return `
                                <div class="card p-6 border-l-4 border-${category.color}-500">
                                    <div class="flex items-start mb-4">
                                        <i class="${category.icon} text-${category.color}-500 text-2xl mr-4 mt-1"></i>
                                        <div>
                                            <h2 class="text-xl font-bold text-gray-800">${category.name}</h2>
                                            <p class="text-gray-600">${category.description}</p>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-500">${completedCount}/${categoryQuizzes.length} quizzes completed</span>
                                        <button onclick="showCategoryQuizzes('${category.id}')" class="bg-${category.color}-500 hover:bg-${category.color}-600 text-white px-4 py-2 rounded-lg transition">
                                            View Quizzes
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Recently Completed Quizzes -->
                    ${state.completedQuizzes.length > 0 ? `
                        <div class="card p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Recently Completed</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${state.completedQuizzes.slice(-4).map(quizId => {
                                    const quiz = QUIZ_DATA.quizzes.find(q => q.id === quizId);
                                    if (!quiz) return '';
                                    
                                    return `
                                        <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between">
                                            <div>
                                                <h3 class="font-semibold">${quiz.title}</h3>
                                                <p class="text-sm text-gray-600">${quiz.difficulty} • ${quiz.duration} min</p>
                                            </div>
                                            <button onclick="startQuiz('${quiz.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition">
                                                Retake
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function showCategoryQuizzes(categoryId) {
            const category = QUIZ_DATA.categories.find(c => c.id === categoryId);
            const categoryQuizzes = QUIZ_DATA.quizzes.filter(q => q.category === categoryId);
            
            showModal(`
                <div class="space-y-4">
                    <div class="flex items-center mb-4">
                        <i class="${category.icon} text-${category.color}-500 text-xl mr-3"></i>
                        <h3 class="text-lg font-bold">${category.name} Quizzes</h3>
                    </div>
                    
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${categoryQuizzes.map(quiz => {
                            const isCompleted = isQuizCompleted(quiz.id);
                            
                            return `
                                <div class="border rounded-lg p-4 ${isCompleted ? 'bg-green-50 border-green-200' : 'bg-white'}">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold">${quiz.title}</h4>
                                        ${isCompleted ? 
                                            '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Completed</span>' : 
                                            ''
                                        }
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">${quiz.description}</p>
                                    <div class="flex justify-between items-center">
                                        <div class="flex space-x-2 text-sm text-gray-500">
                                            <span>${quiz.difficulty}</span>
                                            <span>•</span>
                                            <span>${quiz.duration} min</span>
                                            <span>•</span>
                                            <span>${quiz.questions.length} questions</span>
                                        </div>
                                        <button onclick="startQuiz('${quiz.id}'); hideModal();" class="bg-${category.color}-500 hover:bg-${category.color}-600 text-white px-3 py-1 rounded text-sm transition">
                                            ${isCompleted ? 'Retake' : 'Start'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `);
        }

        function renderQuiz() {
            if (!state.currentQuiz) {
                switchView('categories');
                return '';
            }
            
            return `
                <div class="max-w-4xl mx-auto px-4 quiz-container">
                    <div class="card p-6">
                        <!-- Quiz Header -->
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">${state.currentQuiz.title}</h1>
                                <p class="text-gray-600">${state.currentQuiz.description}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Question</div>
                                <div class="text-lg font-bold">${state.currentQuestion + 1}/${state.currentQuiz.questions.length}</div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mb-6">
                            <div class="progress-bar">
                                <div class="progress-fill bg-blue-500" style="width: ${((state.currentQuestion + 1) / state.currentQuiz.questions.length) * 100}%"></div>
                            </div>
                        </div>
                        
                        <!-- Question -->
                        ${renderQuizQuestion()}
                    </div>
                </div>
            `;
        }

        function renderQuizQuestion() {
            if (!state.currentQuiz || state.currentQuestion >= state.currentQuiz.questions.length) {
                return '';
            }
            
            const question = state.currentQuiz.questions[state.currentQuestion];
            const userAnswer = state.userAnswers[state.currentQuestion];
            const isAnswered = userAnswer !== undefined;
            
            return `
                <div class="space-y-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">${question.question}</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${question.options.map((option, index) => {
                                let cardClass = 'option-card border-2 border-gray-200 p-4 rounded-lg';
                                let icon = '';
                                
                                if (isAnswered) {
                                    if (option === question.correctAnswer) {
                                        cardClass += ' correct';
                                        icon = '<i class="fas fa-check text-green-500 ml-2"></i>';
                                    } else if (option === userAnswer && option !== question.correctAnswer) {
                                        cardClass += ' incorrect';
                                        icon = '<i class="fas fa-times text-red-500 ml-2"></i>';
                                    }
                                } else if (option === userAnswer) {
                                    cardClass += ' selected';
                                }
                                
                                return `
                                    <div class="${cardClass}" onclick="${!isAnswered ? `selectAnswer(${state.currentQuestion}, '${option}')` : ''}">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">${option}</span>
                                            ${icon}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Explanation (shown after answer) -->
                    ${isAnswered ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="font-semibold text-blue-800 mb-2">Explanation:</h3>
                            <p class="text-blue-700">${question.explanation}</p>
                        </div>
                    ` : ''}
                    
                    <!-- Navigation Buttons -->
                    <div class="flex justify-between pt-4">
                        <button 
                            onclick="prevQuestion()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition ${state.currentQuestion === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${state.currentQuestion === 0 ? 'disabled' : ''}
                        >
                            <i class="fas fa-arrow-left mr-2"></i> Previous
                        </button>
                        
                        ${!isAnswered ? `
                            <div class="text-sm text-gray-500 text-center py-2">
                                Select an answer to continue
                            </div>
                        ` : ''}
                        
                        <button 
                            onclick="nextQuestion()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition ${!isAnswered ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${!isAnswered ? 'disabled' : ''}
                        >
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderResults() {
            if (!state.currentQuiz) {
                switchView('categories');
                return '';
            }
            
            const correctAnswers = state.currentQuiz.questions.filter((question, index) => 
                state.userAnswers[index] === question.correctAnswer
            ).length;
            
            const totalQuestions = state.currentQuiz.questions.length;
            const percentage = state.quizScore;
            
            // Calculate points (with bonus for perfect score)
            const basePoints = QUIZ_POINTS_REWARD;
            const bonusPoints = percentage === 100 ? 50 : 0;
            const totalPoints = basePoints + bonusPoints;
            
            return `
                <div class="max-w-2xl mx-auto px-4">
                    <div class="card p-8 text-center quiz-complete-animation">
                        <div class="mb-6">
                            <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Quiz Complete!</h1>
                            <p class="text-gray-600">You've completed "${state.currentQuiz.title}"</p>
                        </div>
                        
                        <!-- Score Display -->
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-6 mb-6">
                            <div class="text-5xl font-bold mb-2">${percentage}%</div>
                            <div class="text-lg">${correctAnswers} out of ${totalQuestions} correct</div>
                        </div>
                        
                        <!-- Points Earned -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-center space-x-2 mb-2">
                                <i class="fas fa-coins text-yellow-500 text-xl"></i>
                                <span class="text-lg font-bold text-green-800">Points Earned: ${totalPoints}</span>
                            </div>
                            <div class="text-sm text-green-700">
                                ${basePoints} base points ${bonusPoints > 0 ? `+ ${bonusPoints} perfect score bonus` : ''}
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button onclick="restartQuiz()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition font-semibold">
                                <i class="fas fa-redo mr-2"></i> Retake Quiz
                            </button>
                            <button onclick="switchView('categories')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition font-semibold">
                                <i class="fas fa-th-large mr-2"></i> More Quizzes
                            </button>
                            <a href="index.html" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition font-semibold text-center">
                                <i class="fas fa-home mr-2"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                    
                    <!-- Question Review -->
                    <div class="card p-6 mt-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Question Review</h2>
                        <div class="space-y-4">
                            ${state.currentQuiz.questions.map((question, index) => {
                                const userAnswer = state.userAnswers[index];
                                const isCorrect = userAnswer === question.correctAnswer;
                                
                                return `
                                    <div class="border rounded-lg p-4 ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                                        <div class="flex items-start mb-3">
                                            <div class="w-8 h-8 flex items-center justify-center rounded-full ${isCorrect ? 'bg-green-500 text-white' : 'bg-red-500 text-white'} font-bold text-sm mr-3">
                                                ${index + 1}
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold">${question.question}</h3>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
                                            ${question.options.map(option => {
                                                let bgClass = 'bg-white';
                                                let textClass = 'text-gray-700';
                                                let borderClass = 'border-gray-200';
                                                let icon = '';
                                                
                                                if (option === question.correctAnswer) {
                                                    bgClass = 'bg-green-100';
                                                    textClass = 'text-green-800';
                                                    borderClass = 'border-green-300';
                                                    icon = '<i class="fas fa-check text-green-500 ml-2"></i>';
                                                } else if (option === userAnswer && !isCorrect) {
                                                    bgClass = 'bg-red-100';
                                                    textClass = 'text-red-800';
                                                    borderClass = 'border-red-300';
                                                    icon = '<i class="fas fa-times text-red-500 ml-2"></i>';
                                                }
                                                
                                                return `
                                                    <div class="border-2 ${borderClass} ${bgClass} p-3 rounded-lg">
                                                        <div class="flex justify-between items-center">
                                                            <span class="${textClass} font-medium">${option}</span>
                                                            ${icon}
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                        
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                            <p class="text-sm text-blue-700"><strong>Explanation:</strong> ${question.explanation}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================

        function initializeApp() {
            checkUserAuth();
            render();
            
            // Listen for messages from main app
            window.addEventListener('message', function(event) {
                if (event.data.type === 'USER_DATA_UPDATED') {
                    // Update user data if sent from main app
                    if (event.data.user) {
                        state.user = event.data.user;
                        state.points = state.user.eduPoints || 0;
                        updatePointsDisplay();
                        updateUserInfo();
                        
                        // Store in localStorage for persistence
                        localStorage.setItem('eduhetech_user', JSON.stringify(state.user));
                    }
                }
            });
            
            // Also try to get user data from main app if it exists
            if (window.opener) {
                try {
                    window.opener.postMessage({
                        type: 'REQUEST_USER_DATA'
                    }, '*');
                } catch (e) {
                    console.log('Cannot communicate with main app');
                }
            }
        }

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Make functions globally available
        window.startQuiz = startQuiz;
        window.selectAnswer = selectAnswer;
        window.nextQuestion = nextQuestion;
        window.prevQuestion = prevQuestion;
        window.completeQuiz = completeQuiz;
        window.restartQuiz = restartQuiz;
        window.switchView = switchView;
        window.showCategoryQuizzes = showCategoryQuizzes;
        window.hideModal = hideModal;
        window.redirectToMainApp = redirectToMainApp;
        window.handleLogout = handleLogout;
    </script>
</body>
</html>
